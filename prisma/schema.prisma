// This is the optimized Prisma schema for Avoqado
// Multi-sector POS & Management System

generator client {
  provider = "prisma-client-js"
  // output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// NOTE: CORE MULTI-TENANT ARCHITECTURE
// ==========================================

model Organization {
  id    String       @id @default(cuid())
  name  String
  slug  String?      @unique // URL-friendly identifier for white-label routes (e.g., /wl/organizations/playtelecom)
  email String
  phone String
  taxId String?
  type  BusinessType @default(OTHER)

  // Billing configuration
  billingEmail   String?
  billingAddress Json?

  venues      Venue[]
  invitations Invitation[]
  invoices    Invoice[]

  // Staff memberships (multi-org support)
  staffOrganizations StaffOrganization[] @relation("StaffOrganizations")

  // Modules enabled at organization level (inherited by all venues)
  organizationModules OrganizationModule[]

  // ‚úÖ NEW: Onboarding tracking
  onboardingProgress    OnboardingProgress?
  onboardingCompletedAt DateTime?
  onboardingStep        Int                 @default(0) // For resuming onboarding

  // Commission System (org-wide configs inherit to venues)
  commissionConfigs CommissionConfig[]

  // Performance goals (for CommandCenter charts)
  organizationGoals OrganizationGoal[]

  // Geographic zones for grouping venues
  zones Zone[]

  // Organization-level payment configuration (inherited by venues)
  organizationPaymentConfig     OrganizationPaymentConfig?
  organizationPricingStructures OrganizationPricingStructure[]

  // Organization-level sales goal defaults (inherited by venues without custom goals)
  organizationSalesGoalConfigs OrganizationSalesGoalConfig[]

  // Organization-level payout configuration (inherited by venues without custom payout config)
  organizationPayoutConfig OrganizationPayoutConfig?

  // Training modules created for this organization (null organizationId = global)
  trainingModules TrainingModule[]

  // Organization-level item categories & serialized items (shared across all org venues)
  itemCategories  ItemCategory[]
  serializedItems SerializedItem[]

  // Organization-level attendance config defaults (inherited by venues without custom config)
  attendanceConfig OrganizationAttendanceConfig?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Geographic zone for grouping venues (used by PlayTelecom manager/supervisor dashboards)
model Zone {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name String // "CDMX", "Zona Norte", "Zona Sur"
  slug String // "cdmx", "zona-norte" (for URLs)

  venues Venue[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, slug])
  @@index([organizationId])
}

model Venue {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  // Zone assignment (optional geographic grouping)
  zoneId String?
  zone   Zone?   @relation(fields: [zoneId], references: [id], onDelete: SetNull)

  // Basic info
  name     String
  slug     String    @unique
  type     VenueType @default(RESTAURANT)
  timezone String    @default("America/Mexico_City")
  currency String    @default("MXN")

  // Location
  address   String?
  city      String?
  state     String?
  country   String?  @default("MX")
  zipCode   String?
  latitude  Decimal? @db.Decimal(10, 8)
  longitude Decimal? @db.Decimal(11, 8)

  // Contact
  phone   String?
  email   String?
  website String?

  // Branding
  logo           String?
  primaryColor   String?
  secondaryColor String?

  // Status
  active           Boolean   @default(true)
  operationalSince DateTime?

  // ‚úÖ NEW: Venue operational status (replaces active boolean logic)
  // Mexican law requires data retention - venues cannot be hard deleted
  status           VenueStatus @default(ONBOARDING)
  statusChangedAt  DateTime? // When status was last changed
  statusChangedBy  String? // Staff ID who changed the status
  suspensionReason String?     @db.Text // Reason for suspension (for audit trail)

  // NOTE: isOnboardingDemo and isLiveDemo fields were REMOVED on 2024-12-08
  // Use status field instead: TRIAL = demo during onboarding, LIVE_DEMO = ephemeral demo

  // Demo-specific fields (valid when status = TRIAL or LIVE_DEMO)
  demoExpiresAt         DateTime? // Demo expiration date (TRIAL only)
  onboardingCompletedAt DateTime? // When onboarding was completed
  liveDemoSessionId     String?   @unique // Browser session ID (LIVE_DEMO only)
  lastActivityAt        DateTime? @default(now()) // Last activity for cleanup (LIVE_DEMO only)

  // Legal Entity Type
  entityType     EntityType? // PERSONA_FISICA or PERSONA_MORAL
  legalDocuments Json? // Metadata for uploaded legal documents

  // Tax Information (for converting from demo to real)
  rfc             String? // RFC (Tax ID) for Mexico
  legalName       String? // Legal business name (Raz√≥n social)
  fiscalRegime    String? // Fiscal regime code
  taxDocumentUrl  String? // URL to tax document (constancia de situaci√≥n fiscal)
  idDocumentUrl   String? // URL to ID document (INE/IFE)
  actaDocumentUrl String? // URL to Acta Constitutiva

  // KYC Documents (required by payment processor)
  rfcDocumentUrl          String? // RFC certificate document
  comprobanteDomicilioUrl String? // Address proof (utility bill, bank statement)
  caratulaBancariaUrl     String? // Bank statement with CLABE visible
  poderLegalUrl           String? // Power of attorney (Persona Moral only)

  // KYC Verification Status
  kycStatus            VerificationStatus @default(NOT_SUBMITTED)
  kycCompletedAt       DateTime? // When KYC verification was completed
  kycRejectionReason   String?            @db.Text // Reason for rejection (if REJECTED)
  kycRejectedDocuments String[]           @default([]) // Specific documents rejected (e.g., ["ineUrl", "rfcDocumentUrl"])
  kycVerifiedBy        String? // Superadmin user ID who verified

  // Stripe integration (for trial subscriptions)
  stripeCustomerId      String? @unique
  stripePaymentMethodId String?

  // POS Integration
  posType   PosType?
  posConfig Json? // Encrypted POS credentials
  posStatus PosStatus @default(NOT_INTEGRATED)

  // Google Business Profile Integration
  googleBusinessProfileConnected Boolean   @default(false)
  googleBusinessProfileEmail     String?
  googlePlaceId                  String? // Internal Google location ID
  googleLocationName             String?
  googleAccessToken              String?   @db.Text
  googleRefreshToken             String?   @db.Text
  googleTokenExpiresAt           DateTime?
  googleLastSyncAt               DateTime?

  // Avoqado Fees
  feeType       FeeType      @default(PERCENTAGE)
  feeValue      Decimal      @default(0.025) @db.Decimal(5, 4)
  feeScheduleId String?
  feeSchedule   FeeSchedule? @relation(fields: [feeScheduleId], references: [id])

  // Features & Settings
  features VenueFeature[]
  settings VenueSettings?

  // Relations
  posCommands           PosCommand[]
  posConnectionStatus   PosConnectionStatus?
  invitations           Invitation[]
  staff                 StaffVenue[]
  rolePermissions       VenueRolePermission[]
  roleConfigs           VenueRoleConfig[]
  menuCategories        MenuCategory[]
  menus                 Menu[]
  products              Product[]
  modifierGroups        ModifierGroup[]
  inventories           Inventory[]
  tables                Table[]
  areas                 Area[]
  floorElements         FloorElement[]
  shifts                Shift[]
  timeEntries           TimeEntry[]
  orders                Order[]
  payments              Payment[]
  transactions          VenueTransaction[]
  reviews               Review[]
  terminals             Terminal[]
  terminalLogs          TerminalLog[]
  terminalHealthMetrics TerminalHealth[]

  // Customer Management (Phase 1)
  customers      Customer[]
  customerGroups CustomerGroup[]
  loyaltyConfig  LoyaltyConfig?

  // Discount System (Phase 2)
  discounts Discount[]

  // Notifications
  notifications           Notification[]
  notificationPreferences NotificationPreference[]

  // AI Training
  chatTrainingData   ChatTrainingData[]  @relation("VenueChatTraining")
  chatbotTokenBudget ChatbotTokenBudget?

  // Payment Provider Integration
  paymentConfig           VenuePaymentConfig?
  webhookSubscriptions    WebhookSubscription[]
  providerEvents          ProviderEventLog[]
  pricingStructures       VenuePricingStructure[]
  monthlyProfits          MonthlyVenueProfit[]
  settlementSimulations   SettlementSimulation[]
  settlementIncidents     SettlementIncident[]
  settlementConfirmations SettlementConfirmation[]
  cashCloseouts           CashCloseout[]
  creditAssessment        VenueCreditAssessment?
  creditOffers            CreditOffer[]
  ecommerceMerchants      EcommerceMerchant[]      @relation("VenueEcommerceMerchants") // ‚≠ê E-commerce sales channels for this venue
  cryptoConfig            VenueCryptoConfig? // Per-venue B4Bit crypto payment device config

  // ‚úÖ NEW: Inventory Management
  rawMaterials         RawMaterial[]
  suppliers            Supplier[]
  purchaseOrders       PurchaseOrder[]
  pricingPolicies      PricingPolicy[]
  rawMaterialMovements RawMaterialMovement[]
  lowStockAlerts       LowStockAlert[]
  stockBatches         StockBatch[] // FIFO batch tracking
  stockCounts          StockCount[]

  // ‚úÖ NEW: Webhook event logging
  webhookEvents WebhookEvent[]

  // ‚úÖ NEW: Live Demo Session
  liveDemoSession LiveDemoSession?

  // üì∏ Step 4: Sale Verifications for this venue
  saleVerifications SaleVerification[]

  // üÜï TPV Remote Command System (2025-11-30)
  tpvCommandQueue       TpvCommandQueue[]
  bulkCommandOperations BulkCommandOperation[]
  scheduledCommands     ScheduledCommand[]
  geofenceRules         GeofenceRule[]

  // ==========================================
  // MODULE SYSTEM - Multi-tenant feature management
  // ==========================================
  venueModules    VenueModule[] // Modules enabled for this venue
  itemCategories      ItemCategory[] // Categories for serialized items
  serializedItems     SerializedItem[] // Items with unique barcodes (SIMs, etc.)
  soldSerializedItems SerializedItem[] @relation("SoldItems") // Items sold at this venue (org-level items)

  // ==========================================
  // COMMISSION SYSTEM
  // ==========================================
  commissionConfigs      CommissionConfig[]
  commissionOverrides    CommissionOverride[]
  commissionCalculations CommissionCalculation[]
  commissionSummaries    CommissionSummary[]
  commissionPayouts      CommissionPayout[]
  milestoneAchievements  MilestoneAchievement[]

  // ==========================================
  // PLAYTELECOM / WHITE-LABEL DASHBOARD
  // ==========================================
  cashDeposits      CashDeposit[]
  stockAlertConfigs StockAlertConfig[]
  performanceGoals  PerformanceGoal[]

  // ==========================================
  // TPV MESSAGING SYSTEM
  // ==========================================
  tpvMessages TpvMessage[]

  // ==========================================
  // RESERVATION / BOOKING SYSTEM
  // ==========================================
  reservations        Reservation[]
  waitlistEntries     ReservationWaitlistEntry[]
  reservationSettings ReservationSettings?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([slug])
  @@index([active])
  @@index([status]) // For filtering by operational status
}

// ‚úÖ Live Demo Session Tracking
// Tracks temporary demo sessions for public demo (demo.dashboard.avoqado.io)
model LiveDemoSession {
  id             String   @id @default(cuid())
  sessionId      String   @unique // Browser session cookie identifier
  venueId        String   @unique
  staffId        String   @unique
  venue          Venue    @relation(fields: [venueId], references: [id], onDelete: Cascade)
  staff          Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)
  createdAt      DateTime @default(now())
  lastActivityAt DateTime @default(now())
  expiresAt      DateTime // createdAt + 5 hours

  @@index([sessionId])
  @@index([expiresAt]) // For cleanup queries
  @@index([lastActivityAt]) // For activity monitoring
}

model VenueSettings {
  id      String @id @default(cuid())
  venueId String @unique
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // Operations
  autoCloseShifts Boolean @default(false)
  shiftDuration   Int     @default(8) // hours
  enableShifts    Boolean @default(true) // Enable/disable shift system for venue
  requirePinLogin Boolean @default(true)

  // Attendance verification
  requireClockInPhoto Boolean @default(false) // Require photo when clocking in (anti-fraud)

  // Attendance ‚Äî lateness detection (nullable = inherit from org config)
  expectedCheckInTime      String? // "HH:mm" ‚Äî expected check-in time (null = use org default)
  latenessThresholdMinutes Int?    // Minutes of tolerance after expectedCheckInTime (null = use org default)
  geofenceRadiusMeters     Int?    // Max distance (meters) from venue for valid clock-in (null = use org default)

  // Auto Clock-Out (HR automation - Square-style)
  autoClockOutEnabled     Boolean @default(false) // Enable automatic clock-out at fixed time
  autoClockOutTime        String? // "HH:mm" format - e.g., "03:00" for 3 AM
  maxShiftDurationEnabled Boolean @default(false) // Enable max shift duration enforcement
  maxShiftDurationHours   Int     @default(12) // Max hours before auto clock-out

  // Reviews
  autoReplyReviews    Boolean  @default(false)
  notifyBadReviews    Boolean  @default(true)
  badReviewThreshold  Int      @default(3)
  badReviewAlertRoles String[] @default(["OWNER", "ADMIN", "MANAGER"])

  // Inventory
  trackInventory    Boolean       @default(false)
  lowStockAlert     Boolean       @default(true)
  lowStockThreshold Int           @default(10)
  costingMethod     CostingMethod @default(FIFO) // Inventory costing strategy

  // Customer features
  allowReservations Boolean @default(false)
  allowTakeout      Boolean @default(false)
  allowDelivery     Boolean @default(false)

  // Payment
  acceptCash          Boolean            @default(true)
  acceptCard          Boolean            @default(true)
  acceptDigitalWallet Boolean            @default(true)
  tipSuggestions      Json? // [15, 18, 20, 25]
  paymentTiming       PaymentTiming      @default(PAY_AFTER) // When to collect payment
  inventoryDeduction  InventoryDeduction @default(ON_ORDER_CREATE) // When to deduct inventory

  // TPV Settings removed (2025-11-29) - now stored per-terminal in Terminal.config.settings
  // Migration script: scripts/migrate-tpv-settings-to-terminal.ts

  updatedAt DateTime @updatedAt
}

model PosConnectionStatus {
  id      String @id @default(cuid())
  venueId String @unique // Solo puede haber un estado por Venue
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  status          PosConnectionState @default(OFFLINE)
  instanceId      String? // El GUID √∫nico de la base de datos del POS
  producerVersion String? // La versi√≥n de nuestro producer.ts
  lastHeartbeatAt DateTime? // La √∫ltima vez que recibimos un latido

  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([lastHeartbeatAt])
}

// ==========================================
// NOTE: STAFF MANAGEMENT (SIMPLIFIED)
// ==========================================

model Staff {
  id String @id @default(cuid())
  // organizationId removed: use StaffOrganization junction table for multi-org membership

  // Authentication
  // NOTE: email is GLOBALLY UNIQUE (industry standard: Stripe, Shopify, Toast)
  // One person = one Staff account, can be member of multiple orgs via StaffVenue
  email    String  @unique
  password String? // Null for PIN-only users or OAuth users
  googleId String? @unique // Google OAuth ID
  // pin      String? // ‚ùå REMOVER - Se mueve a StaffVenue

  // Profile
  firstName    String
  lastName     String
  phone        String?
  employeeCode String?
  photoUrl     String?

  // Status
  active        Boolean      @default(true)
  emailVerified Boolean      @default(false)
  invitations   Invitation[]

  // Email Verification
  emailVerificationCode    String? // 4-digit PIN code
  emailVerificationExpires DateTime? // Expiration time for verification code

  // Access
  organizations     StaffOrganization[]
  venues            StaffVenue[]
  shifts            Shift[]
  ordersCreated     Order[]             @relation("OrderCreatedBy")
  ordersServed      Order[]             @relation("OrderServedBy")
  paymentsProcessed Payment[]
  activities        ActivityLog[]
  reviewsReceived   Review[]
  orderActions      OrderAction[] // Order modifications performed by this staff member

  // Notifications
  notifications           Notification[]
  notificationPreferences NotificationPreference[]
  deviceTokens            DeviceToken[]

  // AI Training
  chatTrainingData ChatTrainingData[] @relation("UserChatTraining")

  // Time tracking
  timeEntries TimeEntry[]

  // Role permission management
  modifiedRolePermissions VenueRolePermission[] @relation("ModifiedRolePermissions")

  //POS sync
  originSystem OriginSystem @default(AVOQADO)
  posRawData   Json?

  // ‚úÖ NEW: Live Demo Session
  liveDemoSession LiveDemoSession?

  // ‚úÖ NEW: Settlement simulations
  settlementSimulations SettlementSimulation[]

  // üì∏ Step 4: Sale Verifications processed by this staff
  saleVerifications SaleVerification[]

  // ‚úÖ NEW: E-commerce Merchant (SDK client) dashboard access
  ecommerceMerchant EcommerceMerchant?

  // ‚úÖ NEW: Cash Closeouts (Cortes de Caja)
  cashCloseouts CashCloseout[] @relation("CashCloseoutClosedBy")

  // ‚úÖ NEW: Credit Offers (SOFOM integration)
  creditOffersAccepted CreditOffer[]
  creditOffersCreated  CreditOffer[] @relation("CreditOfferCreatedBy")

  // ==========================================
  // COMMISSION SYSTEM
  // ==========================================
  commissionConfigsCreated    CommissionConfig[]      @relation("CommissionConfigCreatedBy")
  commissionOverridesCreated  CommissionOverride[]    @relation("CommissionOverrideCreatedBy")
  commissionOverridesReceived CommissionOverride[]    @relation("CommissionOverrideStaff")
  commissionCalculations      CommissionCalculation[]
  commissionSummaries         CommissionSummary[]
  commissionSummariesApproved CommissionSummary[]     @relation("CommissionSummaryApprovedBy")
  commissionPayoutsReceived   CommissionPayout[]      @relation("CommissionPayoutStaff")
  commissionPayoutsProcessed  CommissionPayout[]      @relation("CommissionPayoutProcessedBy")
  commissionClawbacksCreated  CommissionClawback[]    @relation("CommissionClawbackCreatedBy")
  milestoneAchievements       MilestoneAchievement[]

  // Reservations
  reservationsAssigned Reservation[] @relation("ReservationStaff")
  reservationsCreated  Reservation[] @relation("ReservationCreatedBy")

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // Security: Account lockout after failed login attempts (FAANG best practice)
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?

  // Password reset fields (Stripe-style flow)
  resetToken        String?   @unique
  resetTokenExpiry  DateTime?
  resetTokenUsedAt  DateTime?
  lastPasswordReset DateTime?

  // ‚úÖ PlayTelecom / White-Label Dashboard relations
  cashDeposits     CashDeposit[]
  depositsApproved CashDeposit[]     @relation("DepositApprover")
  performanceGoals PerformanceGoal[]

  // ‚úÖ TPV App Update System (superadmin uploads)
  appUpdatesUploaded AppUpdate[] @relation("AppUpdateUploadedBy")

  // ‚úÖ Passkeys (WebAuthn) for passwordless authentication
  passkeys StaffPasskey[]

  // Stock Counts
  stockCounts StockCount[] @relation("StockCountCreatedBy")

  // Marketing Campaigns (superadmin)
  emailTemplatesCreated     EmailTemplate[]     @relation("EmailTemplateCreator")
  marketingCampaignsCreated MarketingCampaign[] @relation("MarketingCampaignCreator")

  // Email is now @unique on the field itself (globally unique)
  @@index([email])
}

model StaffVenue {
  id         String  @id @default(cuid())
  staffId    String
  staff      Staff   @relation(fields: [staffId], references: [id], onDelete: Cascade)
  posStaffId String?
  venueId    String
  venue      Venue   @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // ‚úÖ PIN espec√≠fico por venue
  pin String? // 4-6 digits for TPV access per venue

  role        StaffRole
  permissions Json? // Custom permissions override

  // Performance tracking (for waiters)
  totalSales    Decimal @default(0) @db.Decimal(12, 2)
  totalTips     Decimal @default(0) @db.Decimal(10, 2)
  averageRating Decimal @default(0) @db.Decimal(3, 2)
  totalOrders   Int     @default(0)

  active    Boolean   @default(true)
  startDate DateTime  @default(now())
  endDate   DateTime?

  // Relations
  loyaltyTransactionsCreated LoyaltyTransaction[] @relation("LoyaltyTransactionCreatedBy")

  // Discount System (Phase 2)
  discountsCreated          Discount[]         @relation("DiscountCreatedBy")
  customerDiscountsAssigned CustomerDiscount[] @relation("CustomerDiscountAssignedBy")
  orderDiscountsApplied     OrderDiscount[]    @relation("OrderDiscountAppliedBy")
  orderDiscountsAuthorized  OrderDiscount[]    @relation("OrderDiscountAuthorizedBy")

  @@unique([venueId, posStaffId]) // Asegura que no se duplique posStaffId por venue
  @@unique([staffId, venueId]) // Un staff solo puede tener una relaci√≥n por venue
  @@unique([venueId, pin]) // ‚úÖ PIN √∫nico por venue
  @@index([staffId])
  @@index([venueId])
  @@index([role])
  @@index([pin]) // ‚úÖ √çndice para b√∫squedas de PIN
}

// ==========================================
// STAFF-ORGANIZATION JUNCTION TABLE
// Enables staff to belong to multiple organizations
// Pattern: Stripe, GitHub, Slack multi-tenant membership
// ==========================================
model StaffOrganization {
  id             String       @id @default(cuid())
  staffId        String
  staff          Staff        @relation(fields: [staffId], references: [id], onDelete: Cascade)
  organizationId String
  organization   Organization @relation("StaffOrganizations", fields: [organizationId], references: [id], onDelete: Cascade)

  role      OrgRole @default(MEMBER)
  isActive  Boolean @default(true)
  isPrimary Boolean @default(false) // Primary org for token generation fallback

  joinedAt   DateTime  @default(now())
  joinedById String? // Staff who invited this member
  leftAt     DateTime?

  @@unique([staffId, organizationId])
  @@index([staffId])
  @@index([organizationId])
  @@index([isPrimary])
}

// ==========================================
// NOTE: PASSKEY (WebAuthn) AUTHENTICATION
// ==========================================

/// Stores WebAuthn/Passkey credentials for passwordless authentication.
/// Each staff member can have multiple passkeys (e.g., different devices).
model StaffPasskey {
  id      String @id @default(cuid())
  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)

  // WebAuthn credential data
  credentialId   String @unique // Base64URL encoded credential ID
  publicKey      String // Base64URL encoded public key (COSE format)
  counter        Int    @default(0) // Signature counter for replay attack prevention
  credentialType String @default("public-key") // Always "public-key" for WebAuthn

  // Device info (optional, for user-friendly display)
  deviceName String? // e.g., "iPhone 15 Pro", "MacBook Pro"
  deviceType String? // e.g., "platform", "cross-platform"
  aaguid     String? // Authenticator AAGUID for identifying authenticator type

  // Timestamps
  createdAt  DateTime  @default(now())
  lastUsedAt DateTime?

  @@index([staffId])
  @@index([credentialId])
}

// ==========================================
// NOTE: ROLE PERMISSIONS MANAGEMENT
// ==========================================

/// Venue-specific role permission configurations.
/// Allows OWNER and ADMIN to customize default permissions for each role.
model VenueRolePermission {
  id          String    @id @default(cuid())
  venueId     String
  venue       Venue     @relation(fields: [venueId], references: [id], onDelete: Cascade)
  role        StaffRole
  permissions String[] // Custom permissions array: ["menu:read", "orders:create", ...]

  // Audit trail
  modifiedBy String
  modifier   Staff  @relation("ModifiedRolePermissions", fields: [modifiedBy], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([venueId, role]) // One permission config per role per venue
  @@index([venueId])
  @@index([role])
  @@index([modifiedBy])
  @@index([venueId, updatedAt]) // Audit trail: recent changes per venue
  @@index([modifiedBy, updatedAt]) // Audit trail: who changed what when
}

// ==========================================
// VenueRoleConfig: Custom Role Display Names
// ==========================================
// Allows venues to customize role display names while keeping
// the internal StaffRole enum for type safety.
// Example: CASHIER -> "Promotor" for events businesses
model VenueRoleConfig {
  id          String    @id @default(cuid())
  venueId     String
  venue       Venue     @relation(fields: [venueId], references: [id], onDelete: Cascade)
  role        StaffRole // Internal enum (never changes)
  displayName String // Custom name shown to users (e.g., "Promotor")
  description String? // Optional description for this role
  icon        String? // Optional icon name (e.g., "ticket", "users")
  color       String? // Optional hex color for UI badges (e.g., "#7C3AED")
  isActive    Boolean   @default(true) // Can hide unused roles
  sortOrder   Int       @default(0) // Custom ordering in UI

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([venueId, role]) // One config per role per venue
  @@index([venueId])
  @@index([role])
}

model Invitation {
  id    String    @id @default(cuid())
  email String
  role  StaffRole

  // Tipo de invitaci√≥n
  type InvitationType @default(VENUE_STAFF) // ‚úÖ AGREGAR

  // Organization (siempre requerida)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  // Venue (opcional - solo para invitaciones de staff a venue espec√≠fico)
  venueId String?
  venue   Venue?  @relation(fields: [venueId], references: [id])

  // Token y seguridad
  token     String   @unique @default(cuid()) // ‚úÖ Generar por defecto
  expiresAt DateTime

  // Estado
  status     InvitationStatus @default(PENDING) // ‚úÖ MEJOR QUE isUsed
  acceptedAt DateTime?
  declinedAt DateTime? // ‚úÖ AGREGAR

  // Metadata
  message     String? // ‚úÖ Mensaje personalizado del invitador
  permissions Json? // ‚úÖ Permisos espec√≠ficos si aplica

  // Tracking
  invitedById  String
  invitedBy    Staff   @relation(fields: [invitedById], references: [id])
  acceptedById String? // ‚úÖ AGREGAR - Qui√©n acept√≥ (puede ser diferente)

  // Intentos de uso
  attemptCount  Int       @default(0) // ‚úÖ AGREGAR
  lastAttemptAt DateTime? // ‚úÖ AGREGAR

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt // ‚úÖ AGREGAR

  @@index([email])
  @@index([token])
  @@index([organizationId])
  @@index([venueId])
  @@index([status]) // ‚úÖ AGREGAR
  @@index([expiresAt]) // ‚úÖ AGREGAR para queries de limpieza
}

// OAuth State Management (for Google Integration)
model OAuthState {
  id        String   @id @default(cuid())
  state     String   @unique
  venueId   String
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([state])
  @@index([expiresAt])
}

// ==========================================
// NOTE: ONBOARDING SYSTEM
// ==========================================

/// Tracks onboarding progress for new organizations/venues
/// Stores step-by-step data collection for resume capability
model OnboardingProgress {
  id             String       @id @default(cuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Progress tracking
  currentStep    Int  @default(0)
  completedSteps Json // Array of completed step numbers: [1, 2, 3]

  // Step 1: User info (captured during signup, stored for reference)
  step1_userInfo Json? // {email, firstName, lastName, phone}

  // Step 2: Onboarding type selection
  step2_onboardingType OnboardingType? // DEMO or REAL

  // Step 3: Business information
  step3_businessInfo Json? // {name, type, venueType, timezone, address, phone, email}

  // Step 4: Menu setup
  step4_menuData Json? // {method: "manual" | "csv", categories: [...], products: [...]}

  // Step 5: Team invitations (optional)
  step5_teamInvites Json[] // [{email, role}, ...]

  // Step 6: Premium features selection (optional)
  step6_selectedFeatures String[] // ["inventory", "advanced_reports", "ai_assistant", "online_ordering"]

  // Step 7: KYC Documents
  step7_kycDocuments Json? // {entityType, documents: {ineUrl, rfcDocumentUrl, ...}}

  // Step 8: Payment configuration (CLABE)
  step8_paymentInfo Json? // {clabe, bankName, accountHolder}

  // V2 Setup Wizard (Square-style onboarding)
  wizardVersion     Int       @default(1)
  v2SetupData       Json? // All v2 step data as structured JSON
  termsAcceptedAt   DateTime?
  privacyAcceptedAt DateTime?
  termsVersion      String? // e.g. "2026-02-10"
  termsIpAddress    String?

  // Metadata
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  updatedAt   DateTime  @updatedAt

  @@index([organizationId])
  @@index([currentStep])
  @@index([completedAt])
}

// ==========================================
// NOTE: MENU & CATEGORIES
// ==========================================
model MenuCategory {
  id      String @id @default(cuid())
  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // Basic info
  name        String
  description String?
  slug        String

  // Display
  displayOrder Int     @default(0)
  imageUrl     String?
  color        String? // For UI theming
  icon         String? // Icon name/class

  // Hierarchy (for subcategories)
  parentId String?
  parent   MenuCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children MenuCategory[] @relation("CategoryHierarchy")

  // Scheduling
  active         Boolean  @default(true)
  availableFrom  String? // "08:00"
  availableUntil String? // "22:00"
  availableDays  String[] // ["MON", "TUE", "WED"]

  // Relations
  products Product[]
  menus    MenuCategoryAssignment[]

  // Commission System
  commissionMilestones CommissionMilestone[]

  //POS sync
  originSystem OriginSystem @default(AVOQADO)
  posRawData   Json?
  externalId   String?
  syncStatus   SyncStatus   @default(NOT_REQUIRED)
  lastSyncAt   DateTime?

  // Demo data flag (for cleanup on conversion)
  isDemo Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([venueId, slug])
  @@index([syncStatus])
  @@index([venueId])
  @@index([displayOrder])
  @@index([active])
}

model Menu {
  id      String @id @default(cuid())
  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // Basic info
  name        String
  description String?
  type        MenuType @default(REGULAR)

  // Display
  displayOrder Int     @default(0)
  isDefault    Boolean @default(false) // Main menu

  // Scheduling
  active         Boolean   @default(true)
  startDate      DateTime?
  endDate        DateTime?
  availableFrom  String? // "11:00"
  availableUntil String? // "15:00"
  availableDays  String[] // ["MON", "TUE"]

  // Relations
  categories MenuCategoryAssignment[]

  // Demo data flag (for cleanup on conversion)
  isDemo Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([venueId])
  @@index([active])
}

model MenuCategoryAssignment {
  id         String       @id @default(cuid())
  menuId     String
  menu       Menu         @relation(fields: [menuId], references: [id], onDelete: Cascade)
  categoryId String
  category   MenuCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  displayOrder Int @default(0)

  @@unique([menuId, categoryId])
  @@index([menuId])
  @@index([categoryId])
}

// ==========================================
// NOTE: INVENTORY MANAGEMENT
// ==========================================

model Product {
  id      String @id @default(cuid())
  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // Basic info
  sku         String
  gtin        String? // Global Trade Item Number (UPC/EAN barcode)
  name        String
  description String?

  // Category relationship (flexible)
  categoryId String
  category   MenuCategory @relation(fields: [categoryId], references: [id])

  // Type for reporting/analytics
  type ProductType @default(FOOD)

  // Pricing
  price   Decimal  @db.Decimal(10, 2)
  cost    Decimal? @db.Decimal(10, 2)
  taxRate Decimal  @default(0.16) @db.Decimal(5, 4)

  // Display
  imageUrl     String?
  displayOrder Int     @default(0)
  featured     Boolean @default(false)

  // Dietary info
  tags      String[] // ["vegetarian", "gluten-free", "spicy"]
  allergens String[] // ["nuts", "dairy", "shellfish"]
  calories  Int?

  // Preparation
  prepTime     Int? // minutes
  cookingNotes String?

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // Square-aligned contextual fields (January 2026)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  // Alcohol flag (replaces ALCOHOL type - Square pattern)
  isAlcoholic Boolean @default(false) // Only relevant for FOOD_AND_BEV

  // POS Display
  kitchenName  String? // Short name for kitchen display (max 50 chars)
  abbreviation String? // Ultra-short text for POS (max 24 chars, like Square)

  // Service-specific (SERVICE, APPOINTMENTS_SERVICE)
  duration Int? // Duration in minutes (1-1440)

  // Event-specific (EVENT)
  eventDate     DateTime? // Event date
  eventTime     String? // Start time "HH:mm" format
  eventEndTime  String? // End time "HH:mm" format
  eventCapacity Int? // Max capacity
  eventLocation String? // Event location/venue

  // Digital-specific (DIGITAL)
  downloadUrl   String? // Download URL for digital product
  downloadLimit Int? // Max downloads per purchase (null = unlimited)
  fileSize      String? // Display size "15 MB", "2.3 GB"

  // Donation-specific (DONATION)
  suggestedAmounts  Decimal[] @default([]) // [5.00, 10.00, 25.00, 50.00]
  allowCustomAmount Boolean   @default(true) // Allow custom donation amount
  donationCause     String? // "Tips for staff", "Red Cross", etc.

  // Inventory tracking configuration
  trackInventory  Boolean          @default(false)
  inventoryMethod InventoryMethod? // ‚úÖ WORLD-CLASS: How to track (QUANTITY | RECIPE)
  unit            Unit? // Measurement unit for inventory

  // Status
  active         Boolean   @default(true)
  availableFrom  DateTime?
  availableUntil DateTime?

  // Soft delete
  deletedAt DateTime? // Soft delete timestamp
  deletedBy String? // Staff ID who deleted

  // POS Integration
  externalId   String? // ID from POS
  externalData Json? // Raw data from POS
  originSystem OriginSystem @default(AVOQADO)
  posRawData   Json?
  syncStatus   SyncStatus   @default(NOT_REQUIRED)
  lastSyncAt   DateTime?

  // Relations
  inventory      Inventory?
  orderItems     OrderItem[]
  modifierGroups ProductModifierGroup[]
  recipe         Recipe? // ‚úÖ NEW: Recipe composition
  pricingPolicy  PricingPolicy? // ‚úÖ NEW: Pricing strategy

  // Commission System
  commissionMilestones CommissionMilestone[]

  // Stock Counts
  stockCountItems StockCountItem[]

  // Reservations (product-based appointments/classes)
  reservations Reservation[]

  // Demo data flag (for cleanup on conversion)
  isDemo Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([venueId, sku])
  @@unique([venueId, gtin])
  @@unique([venueId, externalId])
  @@index([venueId])
  @@index([categoryId])
  @@index([active])
  @@index([type])
  @@index([syncStatus]) // ‚úÖ NUEVO √çNDICE
}

model Inventory {
  id            String   @id @default(cuid())
  productId     String   @unique
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  venueId       String
  venue         Venue    @relation(fields: [venueId], references: [id], onDelete: Cascade)
  currentStock  Decimal  @db.Decimal(10, 2)
  reservedStock Decimal  @default(0) @db.Decimal(10, 2)
  minimumStock  Decimal  @default(0) @db.Decimal(10, 2)
  maximumStock  Decimal? @db.Decimal(10, 2)

  lastRestockedAt DateTime?
  lastCountedAt   DateTime?

  movements InventoryMovement[]

  // Demo data flag (for cleanup on conversion)
  isDemo Boolean @default(false)

  updatedAt DateTime @updatedAt

  @@index([productId])
}

model InventoryMovement {
  id          String    @id @default(cuid())
  inventoryId String
  inventory   Inventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)

  type          MovementType
  quantity      Decimal      @db.Decimal(10, 2) // Positive or negative
  previousStock Decimal      @db.Decimal(10, 2)
  newStock      Decimal      @db.Decimal(10, 2)

  reason    String?
  reference String? // Order ID, adjustment ID, etc.

  // Cost and supplier tracking (for PURCHASE movements)
  unitCost Decimal? @db.Decimal(10, 2) // Cost per unit for this movement
  supplier String? // Supplier name for this movement

  createdBy String?
  createdAt DateTime @default(now())

  @@index([inventoryId])
  @@index([type])
  @@index([createdAt])
}

// ==========================================
// NOTE: ADVANCED INVENTORY MANAGEMENT (RAW MATERIALS & RECIPES)
// ==========================================

// Raw materials / ingredients that compose products
model RawMaterial {
  id      String @id @default(cuid())
  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // Basic info
  name        String
  description String?
  sku         String // Internal tracking code
  gtin        String? // Global Trade Item Number (UPC/EAN barcode)
  category    RawMaterialCategory @default(OTHER)

  // Stock tracking
  currentStock  Decimal  @db.Decimal(12, 3)
  unit          Unit // Base unit of measurement
  unitType      UnitType // Type of unit (WEIGHT, VOLUME, COUNT)
  minimumStock  Decimal  @db.Decimal(12, 3) // Low stock threshold
  reorderPoint  Decimal  @db.Decimal(12, 3) // Auto-reorder trigger
  maximumStock  Decimal? @db.Decimal(12, 3) // Maximum storage capacity
  reservedStock Decimal  @default(0) @db.Decimal(12, 3)

  // Costing
  costPerUnit    Decimal @db.Decimal(10, 4) // Current purchase price
  avgCostPerUnit Decimal @db.Decimal(10, 4) // Weighted average cost

  // Perishability
  perishable    Boolean @default(false)
  shelfLifeDays Int? // Expected shelf life in days (used to calculate batch expiration dates)

  // Status
  active      Boolean   @default(true)
  lastCountAt DateTime?

  // Soft delete
  deletedAt DateTime? // Soft delete timestamp
  deletedBy String? // Staff ID who deleted

  // Relations
  recipeLines        RecipeLine[]
  movements          RawMaterialMovement[]
  supplierPricing    SupplierPricing[]
  purchaseOrderItems PurchaseOrderItem[]
  lowStockAlerts     LowStockAlert[]
  batches            StockBatch[] // FIFO batch tracking
  modifiers          Modifier[] // Modifiers linked to this raw material for inventory tracking

  // Demo data flag (for cleanup on conversion)
  isDemo Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([venueId, sku])
  @@unique([venueId, gtin])
  @@index([venueId])
  @@index([category])
  @@index([active])
  @@index([currentStock]) // For low stock queries
  @@index([deletedAt]) // For filtering out deleted records
}

// Product recipes - composition of raw materials
model Recipe {
  id        String  @id @default(cuid())
  productId String  @unique
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Recipe details
  portionYield Int     @default(1) // How many portions this recipe makes
  totalCost    Decimal @db.Decimal(10, 4) // Calculated from ingredients
  prepTime     Int? // minutes
  cookTime     Int? // minutes
  notes        String?

  // Relations
  lines RecipeLine[] // Individual ingredients

  // Demo data flag (for cleanup on conversion)
  isDemo Boolean @default(false)

  updatedAt DateTime @updatedAt

  @@index([productId])
}

// Individual ingredients in a recipe with quantities
model RecipeLine {
  id            String      @id @default(cuid())
  recipeId      String
  recipe        Recipe      @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  rawMaterialId String
  rawMaterial   RawMaterial @relation(fields: [rawMaterialId], references: [id])

  // Quantity details
  quantity        Decimal  @db.Decimal(12, 3) // Amount needed
  unit            Unit // Must match or be convertible to rawMaterial.unit
  costPerServing  Decimal? @db.Decimal(10, 4) // Calculated
  displayOrder    Int      @default(0)
  isOptional      Boolean  @default(false)
  substituteNotes String? // e.g., "Can use chicken instead of beef"

  // ‚úÖ VARIABLE INGREDIENT SUPPORT (Toast/Square pattern)
  // When true, this ingredient can be substituted by a modifier from linkedModifierGroup
  // Example: "Whole Milk" (150ml) can be substituted by "Almond Milk" from "Milk Type" group
  isVariable            Boolean        @default(false)
  linkedModifierGroupId String? // The modifier group that can substitute this ingredient
  linkedModifierGroup   ModifierGroup? @relation(fields: [linkedModifierGroupId], references: [id])

  // Demo data flag (for cleanup on conversion)
  isDemo Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([recipeId, rawMaterialId])
  @@index([recipeId])
  @@index([rawMaterialId])
  @@index([linkedModifierGroupId])
}

// Suppliers for raw materials
model Supplier {
  id      String @id @default(cuid())
  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // Basic info
  name        String
  contactName String?
  email       String?
  phone       String?
  website     String?

  // Address
  address String?
  city    String?
  state   String?
  country String? @default("MX")
  zipCode String?

  // Tax
  taxId String?

  // Performance metrics
  rating           Decimal @default(3.0) @db.Decimal(3, 2) // 1.0 - 5.0
  reliabilityScore Decimal @default(0.7) @db.Decimal(3, 2) // 0.0 - 1.0

  // Ordering details
  leadTimeDays Int      @default(3) // Average delivery time
  minimumOrder Decimal? @db.Decimal(12, 2) // Minimum order value

  // Status
  active Boolean @default(true)
  notes  String?

  // Soft delete
  deletedAt DateTime? // Soft delete timestamp
  deletedBy String? // Staff ID who deleted

  // Relations
  pricing        SupplierPricing[]
  purchaseOrders PurchaseOrder[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([venueId, name])
  @@index([venueId])
  @@index([active])
  @@index([rating])
  @@index([deletedAt]) // For filtering out deleted records
}

// Supplier pricing history for raw materials
model SupplierPricing {
  id            String      @id @default(cuid())
  supplierId    String
  supplier      Supplier    @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  rawMaterialId String
  rawMaterial   RawMaterial @relation(fields: [rawMaterialId], references: [id], onDelete: Cascade)

  // Pricing
  pricePerUnit    Decimal  @db.Decimal(10, 4)
  unit            Unit // Must match rawMaterial unit or be convertible
  minimumQuantity Decimal  @default(1) @db.Decimal(12, 3)
  bulkDiscount    Decimal? @db.Decimal(5, 4) // Percentage discount for bulk

  // Period
  effectiveFrom DateTime
  effectiveTo   DateTime?

  // Status
  active Boolean @default(true)

  // Tracking
  lastOrderDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([supplierId, rawMaterialId, effectiveFrom])
  @@index([supplierId])
  @@index([rawMaterialId])
  @@index([effectiveFrom])
  @@index([active])
}

// Purchase orders to suppliers
model PurchaseOrder {
  id         String   @id @default(cuid())
  venueId    String
  venue      Venue    @relation(fields: [venueId], references: [id], onDelete: Restrict)
  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Restrict)

  // Order details
  orderNumber          String              @unique
  status               PurchaseOrderStatus @default(DRAFT)
  orderDate            DateTime
  expectedDeliveryDate DateTime?
  receivedDate         DateTime?

  // Shipping address (optional custom delivery location)
  shippingAddressType ShippingAddressType @default(VENUE)
  shippingAddress     String? // Street address
  shippingCity        String?
  shippingState       String?
  shippingZipCode     String?

  // Amounts
  subtotal       Decimal @db.Decimal(12, 2)
  taxAmount      Decimal @default(0) @db.Decimal(10, 2)
  taxRate        Decimal @default(0.16) @db.Decimal(5, 4)
  commission     Decimal @default(0) @db.Decimal(10, 2) // Additional fees/commission
  commissionRate Decimal @default(0) @db.Decimal(5, 4) // Commission percentage
  total          Decimal @db.Decimal(12, 2)

  // Tracking
  createdById String?
  createdBy   String? // Staff ID who created
  receivedBy  String? // Staff ID who received

  // Approval tracking
  approvedBy      String? // Staff ID who approved
  approvedAt      DateTime?
  rejectedBy      String? // Staff ID who rejected
  rejectedAt      DateTime?
  rejectionReason String?

  notes String?

  // Relations
  items PurchaseOrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([venueId])
  @@index([supplierId])
  @@index([status])
  @@index([orderDate])
}

// Individual items in a purchase order
model PurchaseOrderItem {
  id              String        @id @default(cuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  rawMaterialId   String
  rawMaterial     RawMaterial   @relation(fields: [rawMaterialId], references: [id])

  // Quantities
  quantityOrdered  Decimal @db.Decimal(12, 3)
  quantityReceived Decimal @default(0) @db.Decimal(12, 3)
  unit             Unit

  // Receive status tracking
  receiveStatus PurchaseOrderItemStatus @default(PENDING)

  // Pricing
  unitPrice Decimal @db.Decimal(10, 4)
  total     Decimal @db.Decimal(12, 2)

  notes String?

  // Relations
  batches StockBatch[] // FIFO batch tracking

  @@index([purchaseOrderId])
  @@index([rawMaterialId])
}

// Pricing policies for products
model PricingPolicy {
  id        String  @id @default(cuid())
  venueId   String
  venue     Venue   @relation(fields: [venueId], references: [id], onDelete: Cascade)
  productId String  @unique
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Pricing strategy
  pricingStrategy          PricingStrategy @default(MANUAL)
  targetFoodCostPercentage Decimal?        @db.Decimal(5, 2) // e.g., 30.00 for 30%
  targetMarkupPercentage   Decimal?        @db.Decimal(5, 2) // e.g., 50.00 for 50%

  // Calculated prices
  calculatedCost     Decimal  @db.Decimal(10, 4) // From recipe
  suggestedPrice     Decimal? @db.Decimal(10, 2) // Auto-calculated
  minimumPrice       Decimal? @db.Decimal(10, 2) // Floor price
  currentPrice       Decimal  @db.Decimal(10, 2) // Active selling price
  foodCostPercentage Decimal? @db.Decimal(5, 2) // Current food cost %

  // Tracking
  lastReviewedAt DateTime?
  lastUpdatedBy  String? // Staff ID

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([venueId])
  @@index([pricingStrategy])
}

// Unit conversion system (standalone, not tied to specific raw materials)
model UnitConversion {
  id String @id @default(cuid())

  fromUnit         Unit // Source unit (e.g., KILOGRAM)
  toUnit           Unit // Target unit (e.g., GRAM)
  conversionFactor Decimal  @db.Decimal(12, 6) // 1 kg = 1000 g ‚Üí factor = 1000
  unitType         UnitType // Type category (WEIGHT, VOLUME, COUNT)

  // System-provided conversions (vs custom venue-specific ones)
  isSystemDefault Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([fromUnit, toUnit])
  @@index([fromUnit])
  @@index([toUnit])
  @@index([unitType])
  @@index([isSystemDefault])
}

// Raw material stock movements
model RawMaterialMovement {
  id            String      @id @default(cuid())
  rawMaterialId String
  rawMaterial   RawMaterial @relation(fields: [rawMaterialId], references: [id], onDelete: Cascade)
  venueId       String
  venue         Venue       @relation(fields: [venueId], references: [id], onDelete: Cascade)

  type          RawMaterialMovementType
  quantity      Decimal                 @db.Decimal(12, 3) // Positive or negative
  unit          Unit
  previousStock Decimal                 @db.Decimal(12, 3)
  newStock      Decimal                 @db.Decimal(12, 3)

  // Cost impact
  costImpact Decimal? @db.Decimal(10, 4) // How this affected total cost

  // Batch tracking for FIFO
  batchId String?
  batch   StockBatch? @relation(fields: [batchId], references: [id], onDelete: SetNull)

  // References
  reason    String?
  reference String? // Order ID, PO ID, etc.

  // Tracking
  createdBy String? // Staff ID
  createdAt DateTime @default(now())

  @@index([rawMaterialId])
  @@index([venueId])
  @@index([type])
  @@index([batchId])
  @@index([createdAt])
}

// Low stock alerts for raw materials
model LowStockAlert {
  id            String      @id @default(cuid())
  venueId       String
  venue         Venue       @relation(fields: [venueId], references: [id], onDelete: Cascade)
  rawMaterialId String
  rawMaterial   RawMaterial @relation(fields: [rawMaterialId], references: [id], onDelete: Cascade)

  alertType    AlertType
  threshold    Decimal     @db.Decimal(12, 3) // Stock level that triggered alert
  currentLevel Decimal     @db.Decimal(12, 3)
  status       AlertStatus @default(ACTIVE)

  // Tracking
  acknowledgedBy String? // Staff ID
  acknowledgedAt DateTime?
  resolvedBy     String? // Staff ID
  resolvedAt     DateTime?

  createdAt DateTime @default(now())

  @@index([venueId])
  @@index([rawMaterialId])
  @@index([status])
  @@index([alertType])
  @@index([createdAt])
}

// ==========================================
// STOCK COUNTS (Physical inventory counting)
// ==========================================

model StockCount {
  id      String @id @default(cuid())
  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  type   StockCountType // CYCLE or FULL
  status StockCountStatus @default(IN_PROGRESS)
  note   String?

  items StockCountItem[]

  createdById   String?
  createdByUser Staff?    @relation("StockCountCreatedBy", fields: [createdById], references: [id])
  createdAt     DateTime  @default(now())
  completedAt   DateTime?

  @@index([venueId])
  @@index([status])
  @@index([createdAt])
}

model StockCountItem {
  id           String     @id @default(cuid())
  stockCountId String
  stockCount   StockCount @relation(fields: [stockCountId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  expected Decimal @db.Decimal(10, 2) // System stock at count time
  counted  Decimal @default(0) @db.Decimal(10, 2) // Physically counted

  @@index([stockCountId])
  @@index([productId])
}

enum StockCountType {
  CYCLE // Partial - specific items
  FULL // All inventory items
}

enum StockCountStatus {
  IN_PROGRESS
  COMPLETED
}

// ==========================================
// NOTE: FIFO BATCH TRACKING
// ==========================================

// Stock batches for FIFO inventory costing and tracking
model StockBatch {
  id            String      @id @default(cuid())
  rawMaterialId String
  rawMaterial   RawMaterial @relation(fields: [rawMaterialId], references: [id], onDelete: Cascade)
  venueId       String
  venue         Venue       @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // Purchase details (optional - manual adjustments may not have PO)
  purchaseOrderItemId String?
  purchaseOrderItem   PurchaseOrderItem? @relation(fields: [purchaseOrderItemId], references: [id], onDelete: SetNull)

  // Batch tracking
  batchNumber       String // Generated identifier (e.g., "BATCH-20231013-001")
  initialQuantity   Decimal @db.Decimal(12, 3) // Original quantity received
  remainingQuantity Decimal @db.Decimal(12, 3) // Current remaining quantity
  unit              Unit // Must match rawMaterial.unit

  // Costing (locked at time of receipt)
  costPerUnit Decimal @db.Decimal(10, 4) // Historical cost for FIFO accuracy

  // Dates
  receivedDate   DateTime // When this batch was received
  expirationDate DateTime? // Optional expiration date

  // Status
  status     BatchStatus @default(ACTIVE)
  depletedAt DateTime? // When fully consumed

  // Relations
  movements RawMaterialMovement[] // Movements from this batch

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([rawMaterialId, batchNumber])
  @@index([rawMaterialId])
  @@index([venueId])
  @@index([status])
  @@index([receivedDate]) // Critical for FIFO ordering (oldest first)
  @@index([expirationDate]) // For expiration tracking
  @@index([purchaseOrderItemId])
}

// ==========================================
// NOTE: OPERATIONS
// ==========================================
model Area {
  id      String @id @default(cuid())
  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id])

  name        String
  description String?

  // --- Campos de Sincronizaci√≥n ---
  externalId   String?      @unique
  originSystem OriginSystem @default(AVOQADO)
  posRawData   Json?

  tables        Table[] // Un √°rea tiene muchas mesas
  floorElements FloorElement[] // Elementos decorativos del √°rea (paredes, barras, etc.)

  // Demo data flag (for cleanup on conversion)
  isDemo Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([venueId, externalId])
  @@unique([venueId, name])
}

model Table {
  id      String @id @default(cuid())
  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  number   String
  capacity Int
  qrCode   String  @unique
  areaId   String?
  area     Area?   @relation(fields: [areaId], references: [id])
  active   Boolean @default(true)

  // Floor plan positioning (normalized 0-1 coordinates)
  positionX Float?
  positionY Float?
  shape     TableShape @default(SQUARE)
  rotation  Int        @default(0) // 0, 90, 180, 270 degrees

  // Table status for availability tracking
  status TableStatus @default(AVAILABLE)

  // Current order link (1-to-1 relationship for occupied tables)
  currentOrderId String? @unique
  currentOrder   Order?  @relation("TableCurrentOrder", fields: [currentOrderId], references: [id], onDelete: SetNull)

  // Order history (all orders ever assigned to this table)
  orders Order[] @relation("TableOrderHistory")

  // Reservations
  reservations Reservation[]

  //POS sync
  originSystem OriginSystem @default(AVOQADO)
  posRawData   Json?
  externalId   String?

  // Demo data flag (for cleanup on conversion)
  isDemo Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@unique([venueId, externalId])
  @@unique([venueId, number])
  @@index([venueId])
  @@index([venueId, status])
}

// Floor plan decorative elements (walls, bars, service areas, labels)
// IMPORTANT: Coordinates are GLOBAL to venue (0-1) just like Table coordinates
model FloorElement {
  id      String @id @default(cuid())
  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // Optional area relationship (for visual filtering)
  areaId String?
  area   Area?   @relation(fields: [areaId], references: [id], onDelete: SetNull)

  type FloorElementType

  // GLOBAL coordinates (0.0 - 1.0, relative to entire venue)
  // Same coordinate system as Table.positionX/Y
  positionX Float
  positionY Float

  // For rectangular elements (BAR_COUNTER, SERVICE_AREA)
  width    Float? // Width (0.0 - 1.0)
  height   Float? // Height (0.0 - 1.0)
  rotation Int    @default(0) // 0, 90, 180, 270 degrees

  // For WALL (line from positionX/Y to endX/endY)
  endX Float? // End point X coordinate
  endY Float? // End point Y coordinate

  // Metadata
  label  String? // "Cocina", "Ba√±o", "Entrada", "Barra"
  color  String? // Hex color (e.g., "#424242")
  active Boolean @default(true) // Visibility toggle

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([venueId])
  @@index([venueId, areaId])
  @@index([venueId, type])
}

model Shift {
  id      String @id @default(cuid())
  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id])
  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id])

  startTime DateTime
  endTime   DateTime?

  // Cash management
  startingCash   Decimal  @default(0) @db.Decimal(10, 2)
  endingCash     Decimal? @db.Decimal(10, 2)
  cashDifference Decimal? @db.Decimal(10, 2)

  // Cash reconciliation (for shift closing)
  cashDeclared     Decimal? @db.Decimal(10, 2)
  cardDeclared     Decimal? @db.Decimal(10, 2)
  vouchersDeclared Decimal? @db.Decimal(10, 2)
  otherDeclared    Decimal? @db.Decimal(10, 2)

  // Summary
  totalSales  Decimal @default(0) @db.Decimal(12, 2)
  totalTips   Decimal @default(0) @db.Decimal(10, 2)
  totalOrders Int     @default(0)

  // Automatic calculation fields (FASE 1 - Shift Management)
  totalCashPayments    Decimal @default(0) @db.Decimal(12, 2)
  totalCardPayments    Decimal @default(0) @db.Decimal(12, 2)
  totalVoucherPayments Decimal @default(0) @db.Decimal(12, 2)
  totalOtherPayments   Decimal @default(0) @db.Decimal(12, 2)
  totalProductsSold    Int     @default(0)
  inventoryConsumed    Json? // FIFO batch data for consumed inventory
  reportData           Json? // Full breakdown for printing receipts

  status ShiftStatus @default(OPEN)
  notes  String?

  orders   Order[]
  payments Payment[]

  // Commission System
  commissionCalculations CommissionCalculation[]

  //POS sync
  originSystem OriginSystem @default(AVOQADO)
  posRawData   Json?
  externalId   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([venueId, externalId])
  @@index([venueId])
  @@index([staffId])
  @@index([status])
  @@index([startTime])
  @@index([venueId, createdAt])
  @@index([staffId, createdAt])
}

// ==========================================
// NOTE: TIME TRACKING
// ==========================================

model TimeEntry {
  id      String @id @default(cuid())
  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)
  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // Clock times
  clockInTime  DateTime
  clockOutTime DateTime?

  // Break tracking
  breaks TimeEntryBreak[]

  // Job role during this time entry
  jobRole String? // e.g., "Waiter", "Bartender", "Manager"

  // Calculated fields
  totalHours   Decimal? @db.Decimal(5, 2)
  breakMinutes Int?     @default(0)

  // Status
  status TimeEntryStatus @default(CLOCKED_IN)

  // Notes/metadata
  notes    String?
  editedBy String? // Admin who modified if applicable

  // Check-in verification (anti-fraud photo capture)
  checkInPhotoUrl  String? // Firebase Storage URL of check-in photo
  clockInLatitude  Float? // GPS latitude at clock-in
  clockInLongitude Float? // GPS longitude at clock-in
  clockInAccuracy  Float? // GPS accuracy in meters at clock-in

  // Check-out verification
  checkOutPhotoUrl  String? // Firebase Storage URL of check-out photo
  clockOutLatitude  Float? // GPS latitude at clock-out
  clockOutLongitude Float? // GPS longitude at clock-out
  clockOutAccuracy  Float? // GPS accuracy in meters at clock-out

  // Additional evidence photos
  facadePhotoUrl  String? // Firebase URL: store front photo at clock-in
  depositPhotoUrl String? // Firebase URL: bank deposit voucher at clock-out

  // Auto clock-out tracking
  autoClockOut     Boolean @default(false) // Was this entry auto-closed by the system?
  autoClockOutNote String? // Reason for auto clock-out (e.g., "Hora de cierre: 03:00")

  // Manager validation (approve/reject clock-in/out evidence)
  validationStatus TimeEntryValidation @default(PENDING)
  validatedBy      String? // StaffId of manager who validated
  validatedAt      DateTime?
  validationNote   String? // Reason for rejection

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([staffId, venueId])
  @@index([venueId, clockInTime])
  @@index([status])
  @@index([validationStatus])
  @@index([venueId, createdAt])
  @@index([staffId, createdAt])
  @@map("time_entries")
}

model TimeEntryBreak {
  id          String    @id @default(cuid())
  timeEntryId String
  timeEntry   TimeEntry @relation(fields: [timeEntryId], references: [id], onDelete: Cascade)

  startTime DateTime
  endTime   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([timeEntryId])
  @@map("time_entry_breaks")
}

model Order {
  id      String @id @default(cuid())
  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Restrict)

  // Order info
  orderNumber String
  type        OrderType   @default(DINE_IN)
  source      OrderSource @default(TPV)

  // Terminal that created this order (for sales attribution by device)
  terminalId String?
  terminal   Terminal? @relation("OrderTerminal", fields: [terminalId], references: [id], onDelete: SetNull)

  // Relations
  tableId      String?
  table        Table?  @relation("TableOrderHistory", fields: [tableId], references: [id], onDelete: SetNull)
  currentTable Table?  @relation("TableCurrentOrder")
  shiftId      String?
  shift        Shift?  @relation(fields: [shiftId], references: [id], onDelete: SetNull)

  // Customer (registered customer vs guest)
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  // Table service info
  covers Int? // Number of people at table

  // Staff
  createdById String?
  createdBy   Staff?  @relation("OrderCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  servedById  String?
  servedBy    Staff?  @relation("OrderServedBy", fields: [servedById], references: [id], onDelete: SetNull)

  // Customer info (for guest checkout or quick orders without table)
  customerName       String?
  customerPhone      String?
  customerEmail      String?
  customerIdentifier String? // For quick orders: "BAR-042", "QUICK-123"
  specialRequests    String? @db.Text // Allergies, dietary restrictions, special occasions

  // Amounts
  subtotal       Decimal @db.Decimal(12, 2)
  discountAmount Decimal @default(0) @db.Decimal(10, 2)
  taxAmount      Decimal @db.Decimal(10, 2)
  tipAmount      Decimal @default(0) @db.Decimal(10, 2)
  total          Decimal @db.Decimal(12, 2)

  // Partial payment tracking (for split payments)
  paidAmount       Decimal @default(0) @db.Decimal(12, 2)
  remainingBalance Decimal @default(0) @db.Decimal(12, 2)

  // Status
  status        OrderStatus   @default(PENDING)
  kitchenStatus KitchenStatus @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING)

  // Payment split type (set on first payment, enforces UI consistency)
  splitType SplitType?

  // Optimistic concurrency control (prevent concurrent updates)
  version Int @default(1)

  // Tags for flexible categorization (e.g., ["portabilidad", "promo-enero"])
  // Future use: any business-specific label without schema changes.
  // Pattern consistent with Product.tags and Customer.tags.
  tags String[] @default([])

  // POS sync
  externalId   String? // POS order ID
  originSystem OriginSystem @default(AVOQADO)
  posRawData   Json?
  syncStatus   SyncStatus   @default(PENDING)
  syncedAt     DateTime?

  // Relations
  items               OrderItem[]
  payments            Payment[]
  paymentAllocations  PaymentAllocation[]
  actions             OrderAction[] // Audit trail for order modifications
  loyaltyTransactions LoyaltyTransaction[]

  // Discount System (Phase 2)
  orderDiscounts   OrderDiscount[]
  couponRedemption CouponRedemption?

  // Multi-customer support (N:N relationship)
  orderCustomers OrderCustomer[]

  // Commission System
  commissionCalculations CommissionCalculation[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  @@unique([venueId, externalId])
  @@index([venueId])
  @@index([shiftId])
  @@index([status])
  @@index([createdAt])
  @@index([customerId])
  @@index([terminalId])
  @@index([venueId, tableId, paymentStatus])
  @@index([venueId, customerIdentifier, paymentStatus])
  @@index([venueId, createdAt])
  @@index([venueId, status, createdAt])
}

// Junction table for many-to-many Order <-> Customer relationship
// Allows multiple customers per order for visit tracking and loyalty
model OrderCustomer {
  id         String   @id @default(cuid())
  orderId    String
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // First customer added = primary (receives loyalty points)
  isPrimary Boolean  @default(false)
  addedAt   DateTime @default(now())

  @@unique([orderId, customerId]) // Prevent duplicate customer on same order
  @@index([orderId])
  @@index([customerId])
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  // Denormalized product data - preserved when product is deleted (Toast/Square pattern)
  productName  String?
  productSku   String?
  categoryName String?

  quantity       Int
  unitPrice      Decimal @db.Decimal(10, 2)
  discountAmount Decimal @default(0) @db.Decimal(10, 2)
  taxAmount      Decimal @db.Decimal(10, 2)
  total          Decimal @db.Decimal(10, 2)

  notes String?

  modifiers          OrderItemModifier[]
  paymentAllocations PaymentAllocation[] // ‚úÖ L√çNEA AGREGADA

  //POS sync
  originSystem OriginSystem @default(AVOQADO)
  posRawData   Json?
  syncStatus   SyncStatus   @default(NOT_REQUIRED) // ‚úÖ NUEVO
  lastSyncAt   DateTime? // ‚úÖ NUEVO
  externalId   String? // Para trackear "folio:idproducto" del POS
  sequence     Int          @default(0) // Orden de los items en la cuenta

  // Kitchen
  sentToKitchenAt DateTime?
  preparedAt      DateTime?

  // ==========================================
  // SERIALIZED ITEM - Relation for unique barcode items
  // An OrderItem has Product OR SerializedItem, never both.
  // When it's SerializedItem, price comes from unitPrice (captured at sale).
  // productName should be filled from ItemCategory.name
  // productSku should be filled from SerializedItem.serialNumber
  // ==========================================
  serializedItem SerializedItem?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt // ‚úÖ NUEVO

  @@unique([orderId, externalId]) // Para evitar duplicados por externalId
  @@index([orderId])
  @@index([productId])
  @@index([externalId]) // ‚úÖ NUEVO
  @@index([syncStatus]) // ‚úÖ NUEVO
}

// ==========================================
// NOTE: MODIFIERS
// ==========================================

model ModifierGroup {
  id      String @id @default(cuid())
  venueId String // ‚úÖ AGREGAR ESTE CAMPO
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade) // ‚úÖ AGREGAR RELACI√ìN

  name        String
  description String?

  required      Boolean @default(false)
  allowMultiple Boolean @default(false)
  minSelections Int     @default(0)
  maxSelections Int?

  // Display
  displayOrder Int     @default(0)
  active       Boolean @default(true)

  modifiers Modifier[]
  products  ProductModifierGroup[]

  // ‚úÖ Variable ingredients that can be substituted by modifiers from this group
  linkedRecipeLines RecipeLine[]

  //POS sync
  originSystem OriginSystem @default(AVOQADO)
  posRawData   Json?

  // Demo data flag (for cleanup on conversion)
  isDemo Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([venueId]) // ‚úÖ AGREGAR √çNDICE
}

model Modifier {
  id      String        @id @default(cuid())
  groupId String
  group   ModifierGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  name  String
  price Decimal @default(0) @db.Decimal(10, 2)

  // ‚úÖ INVENTORY TRACKING (Toast/Square pattern)
  // Link modifier to a raw material for inventory deduction
  rawMaterialId   String? // Optional: only if this modifier affects inventory
  rawMaterial     RawMaterial?          @relation(fields: [rawMaterialId], references: [id])
  quantityPerUnit Decimal?              @db.Decimal(12, 3) // Amount to deduct per modifier selection
  unit            Unit? // Unit of measurement (must match rawMaterial.unit or be convertible)
  inventoryMode   ModifierInventoryMode @default(ADDITION) // ADDITION (extra) or SUBSTITUTION (replace)
  cost            Decimal?              @db.Decimal(10, 4) // Auto-calculated: rawMaterial.avgCostPerUnit √ó quantityPerUnit

  //POS sync
  originSystem OriginSystem @default(AVOQADO)
  posRawData   Json?
  active       Boolean      @default(true)

  // Demo data flag (for cleanup on conversion)
  isDemo Boolean @default(false)

  orderItems OrderItemModifier[]

  @@index([rawMaterialId])
}

model ProductModifierGroup {
  id        String        @id @default(cuid())
  productId String
  product   Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  groupId   String
  group     ModifierGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  displayOrder Int @default(0)

  @@unique([productId, groupId])
}

model OrderItemModifier {
  id          String    @id @default(cuid())
  orderItemId String
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  modifierId  String?
  modifier    Modifier? @relation(fields: [modifierId], references: [id], onDelete: SetNull)

  // Denormalized modifier data - preserved when modifier is deleted
  name String?

  quantity Int     @default(1)
  price    Decimal @db.Decimal(10, 2)
}

// Order Action Audit Trail
// Tracks all actions performed on orders (comp, void, discount, split, etc.)
model OrderAction {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  actionType ActionType // COMP, VOID, DISCOUNT, SPLIT, MERGE, TRANSFER

  performedById String
  performedBy   Staff  @relation(fields: [performedById], references: [id], onDelete: Restrict)

  reason   String? // Required for comp/void
  metadata Json? // Additional action-specific data

  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([actionType])
  @@index([createdAt])
}

enum ActionType {
  COMP
  VOID
  DISCOUNT
  SPLIT
  MERGE
  TRANSFER
}

// ==========================================
// NOTE: PAYMENTS & FEES
// ==========================================

model Payment {
  id      String  @id @default(cuid())
  venueId String
  venue   Venue   @relation(fields: [venueId], references: [id], onDelete: Restrict)
  orderId String
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  shiftId String?
  shift   Shift?  @relation(fields: [shiftId], references: [id], onDelete: SetNull)

  processedById String?
  processedBy   Staff?  @relation(fields: [processedById], references: [id], onDelete: SetNull)

  // ‚≠ê Provider-agnostic merchant account tracking (2025-01-10)
  // Links payment to specific merchant account that processed it
  // Enables multi-merchant support and accurate revenue attribution
  merchantAccountId String?
  merchantAccount   MerchantAccount? @relation(fields: [merchantAccountId], references: [id], onDelete: Restrict)

  // Terminal that processed this payment (for payment reconciliation by device)
  terminalId String?
  terminal   Terminal? @relation("PaymentTerminal", fields: [terminalId], references: [id], onDelete: SetNull)

  // Amounts
  amount    Decimal @db.Decimal(12, 2)
  tipAmount Decimal @default(0) @db.Decimal(10, 2)

  // Payment info
  method    PaymentMethod
  source    PaymentSource     @default(OTHER)
  status    TransactionStatus @default(PENDING)
  splitType SplitType         @default(FULLPAYMENT) // How this payment was split (audit trail)
  type      PaymentType?      @default(REGULAR) // How this payment was split (audit trail)

  // Processor info
  processor     String? // stripe, mercadopago, etc.
  processorId   String?
  processorData Json?

  // authorization info
  authorizationNumber String? // "502511"
  referenceNumber     String? // "000000188231" 

  cardBrand CardBrand? // MASTERCARD, VISA, etc.
  maskedPan String? // "411111******1111"
  entryMode CardEntryMode? // CONTACTLESS, CHIP, SWIPE, etc.

  // Fee calculation
  feePercentage Decimal @db.Decimal(5, 4)
  feeAmount     Decimal @db.Decimal(10, 2)
  netAmount     Decimal @db.Decimal(12, 2)

  // Receipt
  receipts DigitalReceipt[]

  // ‚≠ê SDK Checkout Sessions (external merchant payments)
  checkoutSessions CheckoutSession[]

  // POS sync
  externalId   String?
  originSystem OriginSystem @default(AVOQADO)
  posRawData   Json?
  syncStatus   SyncStatus   @default(PENDING)
  syncedAt     DateTime?

  // Relations
  transaction      VenueTransaction?
  allocations      PaymentAllocation[] // ‚úÖ L√çNEA AGREGADA
  review           Review? // ‚úÖ L√çNEA AGREGADA (en singular porque es 1-a-1)
  transactionCost  TransactionCost?
  saleVerification SaleVerification? // üì∏ Step 4 verification evidence

  // Commission System
  commissionCalculations CommissionCalculation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([source])
  @@index([authorizationNumber]) // ‚úÖ NUEVO √çNDICE
  @@index([referenceNumber]) // ‚úÖ NUEVO √çNDICE
  @@index([cardBrand]) // ‚úÖ NUEVO √çNDICE
  @@index([merchantAccountId]) // ‚≠ê NUEVO: Provider-agnostic merchant tracking
  @@index([terminalId]) // ‚≠ê NUEVO: Device sales attribution tracking
  @@index([venueId])
  @@index([orderId])
  @@index([shiftId])
  @@index([method])
  @@index([status])
  @@index([venueId, createdAt])
  @@index([venueId, status, createdAt])
  @@index([merchantAccountId, createdAt])
}

model PaymentAllocation {
  id        String  @id @default(cuid())
  paymentId String
  payment   Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  // A qu√© se asigna este pedazo del pago
  orderItemId String?
  orderItem   OrderItem? @relation(fields: [orderItemId], references: [id])
  // O podr√≠as asignarlo a una orden si es un pago general
  orderId     String
  order       Order      @relation(fields: [orderId], references: [id])

  amount Decimal @db.Decimal(12, 2) // La porci√≥n del pago asignada

  createdAt DateTime @default(now())

  @@index([paymentId])
  @@index([orderItemId])
  @@index([orderId])
}

model DigitalReceipt {
  id String @id @default(cuid())

  // Un identificador seguro y no secuencial para la URL p√∫blica
  // Es mejor que usar el CUID/UUID directamente, que puede ser largo
  accessKey String @unique @default(cuid())

  // Relaci√≥n con el pago
  paymentId String
  payment   Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  // Snapshot de los datos en el momento de la creaci√≥n
  // ¬°Esta es la clave para la inmutabilidad!
  dataSnapshot Json

  // Tracking del env√≠o
  status         ReceiptStatus @default(PENDING)
  recipientEmail String?
  recipientPhone String?
  sentAt         DateTime?
  viewedAt       DateTime? // Se puede actualizar cuando se accede al link

  createdAt DateTime @default(now())

  @@index([accessKey])
  @@index([paymentId])
}

// ============================================================
// SALE VERIFICATION (Step 4 - Post-payment verification)
// ============================================================
// Used by retail/telecommunications venues to capture evidence
// of sales (photos + barcodes) for audit and inventory deduction
model SaleVerification {
  id        String  @id @default(cuid())
  venueId   String
  venue     Venue   @relation(fields: [venueId], references: [id], onDelete: Cascade)
  paymentId String  @unique // One verification per payment
  payment   Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  staffId   String
  staff     Staff   @relation(fields: [staffId], references: [id], onDelete: Restrict)

  // Photo URLs (Firebase Storage paths)
  photos String[] // Array of URLs: venues/{venueId}/verificaciones/{paymentId}/*.jpg

  // Scanned products with barcode data
  // JSON array of: { barcode, format, productId?, productName?, inventoryDeducted }
  scannedProducts Json @default("[]")

  // Processing state
  status            SaleVerificationStatus @default(PENDING)
  inventoryDeducted Boolean                @default(false) // Whether stock was deducted

  // Metadata
  deviceId String? // TPV device that captured the verification
  notes    String? // Optional notes from staff

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([venueId])
  @@index([paymentId])
  @@index([staffId])
  @@index([status])
  @@index([createdAt])
}

model VenueTransaction {
  id        String  @id @default(cuid())
  venueId   String
  venue     Venue   @relation(fields: [venueId], references: [id])
  paymentId String  @unique
  payment   Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  type TransactionType

  // Amounts
  grossAmount Decimal @db.Decimal(12, 2)
  feeAmount   Decimal @db.Decimal(10, 2)
  netAmount   Decimal @db.Decimal(12, 2)

  // Settlement tracking
  status       SettlementStatus @default(PENDING)
  settledAt    DateTime? // When funds were actually settled
  settlementId String? // External settlement ID from processor

  // NEW: Enhanced settlement tracking
  estimatedSettlementDate DateTime? // Calculated settlement date based on rules
  actualSettlementDate    DateTime? // Real settlement date (can differ from estimate)
  netSettlementAmount     Decimal?            @db.Decimal(12, 2) // Net amount after ALL fees
  settlementConfigId      String? // Reference to config used for calculation
  settlementNotes         String? // Notes about settlement (delays, issues, etc.)
  settlementVarianceDays  Int? // Days variance (actual - estimated)
  confirmationMethod      ConfirmationMethod? // How settlement was confirmed

  // Relations
  incidents     SettlementIncident[]
  confirmations SettlementConfirmation[]

  createdAt DateTime @default(now())

  @@index([venueId])
  @@index([status])
  @@index([createdAt])
  @@index([estimatedSettlementDate])
  @@index([venueId, status, estimatedSettlementDate])
}

// ==========================================
// NOTE: FEATURES & BILLING
// ==========================================

model Feature {
  id          String  @id @default(cuid())
  code        String  @unique
  name        String
  description String?

  category     FeatureCategory
  monthlyPrice Decimal         @db.Decimal(10, 2)

  // Stripe integration
  stripeProductId String? @unique
  stripePriceId   String? @unique

  active Boolean @default(true)

  venues VenueFeature[]
}

model VenueFeature {
  id        String  @id @default(cuid())
  venueId   String
  venue     Venue   @relation(fields: [venueId], references: [id], onDelete: Cascade)
  featureId String
  feature   Feature @relation(fields: [featureId], references: [id], onDelete: Restrict)

  active       Boolean @default(true)
  monthlyPrice Decimal @db.Decimal(10, 2)

  startDate DateTime  @default(now())
  endDate   DateTime? // null = paid subscription, not-null = trial period

  // Stripe integration
  stripeSubscriptionId     String?   @unique
  stripeSubscriptionItemId String?   @unique
  stripePriceId            String?
  trialEndDate             DateTime? // When the trial period ends

  // Payment failure & grace period tracking
  suspendedAt         DateTime? // When the subscription was suspended due to payment failure
  gracePeriodEndsAt   DateTime? // When the grace period ends (7 days after first failure)
  lastPaymentAttempt  DateTime? // Last time payment was attempted
  paymentFailureCount Int       @default(0) // Number of consecutive payment failures

  @@unique([venueId, featureId])
  @@index([venueId])
}

// ==========================================
// NOTE: STRIPE WEBHOOK LOGGING
// ==========================================

model WebhookEvent {
  id             String             @id @default(cuid())
  stripeEventId  String             @unique // Stripe's event ID (evt_xxx)
  eventType      String // e.g., "customer.subscription.updated"
  payload        Json // Full Stripe event payload
  status         WebhookEventStatus @default(PENDING)
  errorMessage   String?            @db.Text
  processingTime Int? // Time in milliseconds
  retryCount     Int                @default(0)

  // Related entities (optional)
  venueId String?
  venue   Venue?  @relation(fields: [venueId], references: [id], onDelete: SetNull)

  createdAt   DateTime  @default(now())
  processedAt DateTime? // When successfully processed

  @@index([stripeEventId])
  @@index([eventType])
  @@index([status])
  @@index([venueId])
  @@index([createdAt])
}

model FeeSchedule {
  id          String  @id @default(cuid())
  name        String
  description String?

  tiers  FeeTier[]
  venues Venue[]

  active Boolean @default(true)
}

model FeeTier {
  id         String      @id @default(cuid())
  scheduleId String
  schedule   FeeSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  minVolume  Decimal  @db.Decimal(12, 2)
  maxVolume  Decimal? @db.Decimal(12, 2)
  percentage Decimal  @db.Decimal(5, 4)

  @@index([scheduleId])
}

model Invoice {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  invoiceNumber String   @unique
  periodStart   DateTime
  periodEnd     DateTime
  dueDate       DateTime

  // Amounts
  subtotal  Decimal @db.Decimal(12, 2)
  taxAmount Decimal @db.Decimal(10, 2)
  total     Decimal @db.Decimal(12, 2)

  status InvoiceStatus @default(PENDING)
  paidAt DateTime?

  items InvoiceItem[]

  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([status])
}

model InvoiceItem {
  id        String  @id @default(cuid())
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  type        ChargeType
  description String
  venueId     String?

  quantity  Decimal @db.Decimal(10, 2)
  unitPrice Decimal @db.Decimal(10, 2)
  amount    Decimal @db.Decimal(12, 2)
}

// ==========================================
// NOTE REVIEWS
// ==========================================

model Review {
  id      String @id @default(cuid())
  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id])

  // Rating
  overallRating  Int // 1-5
  foodRating     Int?
  serviceRating  Int?
  ambienceRating Int?

  comment String?

  // Customer info
  customerName  String?
  customerEmail String?

  // Source
  source     ReviewSource @default(AVOQADO)
  externalId String? // Google review ID, etc.

  terminalId String?
  terminal   Terminal? @relation(fields: [terminalId], references: [id])

  paymentId String?  @unique // Un pago solo puede tener un review directo
  payment   Payment? @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  servedById String? // Para ligar al mesero
  servedBy   Staff?  @relation(fields: [servedById], references: [id])

  // Response
  responseText      String?
  respondedAt       DateTime?
  responseAutomated Boolean   @default(false)

  createdAt DateTime @default(now())

  @@unique([venueId, externalId])
  @@index([venueId])
  @@index([overallRating])
  @@index([createdAt])
  @@index([terminalId]) // ‚úÖ Nuevo √≠ndice
  @@index([paymentId]) // ‚úÖ Nuevo √≠ndice
  @@index([servedById]) // ‚úÖ Nuevo √≠ndice
  @@index([venueId, createdAt])
}

// ==========================================
// NOTE HARDWARE
// ==========================================

model Terminal {
  id      String @id @default(cuid())
  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id])

  serialNumber String?      @unique // Optional until device is activated with hardware serial
  name         String
  type         TerminalType

  // Hardware information (for payment terminals)
  brand String? // Hardware manufacturer (e.g., "PAX", "Ingenico", "Verifone")
  model String? // Hardware model (e.g., "A910S", "D220", "VX520")

  // Status
  status        TerminalStatus @default(INACTIVE)
  lastHeartbeat DateTime?

  // Health monitoring
  version    String? // AvoqadoPOS version
  systemInfo Json? // Platform, memory, uptime, etc.
  ipAddress  String? // Last known IP address

  // Configuration
  config          Json?
  configOverrides Json? // Per-terminal overrides (cascade: orgDefaults + overrides = config.settings)

  // üÜï Multi-Merchant Support (2025-11-05)
  // Array of MerchantAccount IDs this terminal can use for payment processing
  // ‚ö†Ô∏è WARNING: String[] has no database-level foreign key constraint
  // Protection relies on application layer (deleteMerchantAccount service)
  // DO NOT delete merchants via direct SQL - always use API endpoints
  assignedMerchantIds String[] @default([])

  // Preferred processor for this TPV (LEGACY/MENTA/AUTO)
  preferredProcessor PaymentProcessor @default(AUTO)

  // Menta API Integration - Smart Caching
  mentaTerminalId String? // Menta's UUID for payments (cached on first use)
  mentaLastSync   DateTime? // When we last synced with Menta API

  // üÜï ACTIVATION SYSTEM (Hybrid: Serial Number + Activation Code)
  // Similar to Square POS device activation flow
  activationCode        String?   @unique // 6-char alphanumeric code (e.g. A3F9K2)
  activationCodeExpiry  DateTime? // Code expires after 7 days
  activatedAt           DateTime? // First successful activation timestamp
  activatedBy           String? // StaffId who generated the activation code
  activationAttempts    Int       @default(0) // Counter for failed attempts (max 5)
  lastActivationAttempt DateTime? // Last activation attempt timestamp (anti-brute force)

  reviews Review[] // ‚úÖ L√çNEA AGREGADA

  // üÜï Sales Attribution Relations (2026-01-08)
  // Orders and payments processed by this terminal for sales reports
  orders   Order[]   @relation("OrderTerminal")
  payments Payment[] @relation("PaymentTerminal")

  // üÜï Remote Command System (2025-11-30)
  // Device lock state for remote lock/unlock commands
  isLocked    Boolean   @default(false)
  lockReason  String? // Why terminal was locked (e.g., "security", "maintenance")
  lockMessage String? // Message to display on lock screen
  lockedAt    DateTime?
  lockedBy    String? // StaffId who locked

  // Location tracking for geofencing
  lastLatitude   Float?
  lastLongitude  Float?
  lastLocationAt DateTime?

  // Command system relations
  commandQueue      TpvCommandQueue[]
  scheduledCommands ScheduledCommand[]
  geofenceRules     GeofenceRule[]

  // Observability relations
  logs          TerminalLog[]
  healthMetrics TerminalHealth[]

  // TPV Messaging
  messageDeliveries TpvMessageDelivery[]
  messageResponses  TpvMessageResponse[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([venueId])
  @@index([status])
  @@index([activationCode]) // Fast lookup for activation code validation
  @@index([isLocked]) // Fast lookup for locked terminals
}

// ==========================================
// NOTE: TERMINAL OBSERVABILITY & MONITORING
// ==========================================
// Real-time logs and health metrics from production terminals
// Inspired by Toast, Square, and Clover fleet management systems

/// Real-time log events from TPV terminals
/// Streamed via Socket.IO for immediate visibility into production issues
/// Retention: 30 days (configurable per venue)
model TerminalLog {
  id         String   @id @default(cuid())
  venueId    String
  venue      Venue    @relation(fields: [venueId], references: [id], onDelete: Cascade)
  terminalId String
  terminal   Terminal @relation(fields: [terminalId], references: [id], onDelete: Cascade)

  // Log Entry
  level     LogLevel // INFO, WARN, ERROR
  tag       String // Component name (e.g., "Payment", "Menu", "Socket")
  message   String   @db.Text
  error     String?  @db.Text // Stack trace for errors
  metadata  Json? // Additional context (orderId, amount, etc.)
  timestamp BigInt // Unix timestamp from terminal

  // Audit
  createdAt DateTime @default(now())

  @@index([venueId, terminalId, createdAt])
  @@index([level, createdAt])
  @@index([tag, createdAt])
}

/// Terminal health metrics and heartbeat
/// Sent every 5 minutes for proactive issue detection
/// Enables alerting before terminal failures occur
model TerminalHealth {
  id         String   @id @default(cuid())
  venueId    String
  venue      Venue    @relation(fields: [venueId], references: [id], onDelete: Cascade)
  terminalId String
  terminal   Terminal @relation(fields: [terminalId], references: [id], onDelete: Cascade)

  // Overall Health
  healthScore Int // 0-100 (100 = perfect health)

  // Memory
  memoryTotalMB      Int
  memoryAvailableMB  Int
  memoryUsagePercent Int
  lowMemory          Boolean @default(false)

  // Storage
  storageTotalMB      Int
  storageAvailableMB  Int
  storageUsagePercent Int
  lowStorage          Boolean @default(false)

  // Battery
  batteryLevel       Int? // 0-100 percentage
  batteryCharging    Boolean @default(false)
  batteryTemperature Float? // Celsius
  lowBattery         Boolean @default(false)

  // Connectivity
  socketConnected Boolean
  online          Boolean

  // Device Info (for diagnostics)
  manufacturer   String
  model          String
  osVersion      String
  appVersion     String
  appVersionCode Int
  blumonEnv      String

  // Uptime
  uptimeMinutes Int

  // Timestamps
  timestamp DateTime // Heartbeat timestamp from terminal
  createdAt DateTime @default(now())

  @@index([venueId, terminalId, createdAt])
  @@index([healthScore, createdAt])
  @@index([lowMemory])
  @@index([lowBattery])
}

enum LogLevel {
  INFO
  WARN
  ERROR
}

// ==========================================
// NOTE: PAYMENT PROVIDER INTEGRATION
// ==========================================

// Generic payment provider model
/// Catalog of upstream payment vendors that Avoqado integrates with.
/// Acts as the template/metadata layer; `configSchema` describes
/// how merchant-level `providerConfig` JSON should be shaped.
model PaymentProvider {
  id          String       @id @default(cuid())
  code        String       @unique // "MENTA", "CLIP", "BANORTE_DIRECT", etc.
  name        String // "Menta", "Clip", "Banorte Direct"
  type        ProviderType // PAYMENT_PROCESSOR, BANK_DIRECT, WALLET
  countryCode String[] // ["MX", "AR"]
  active      Boolean      @default(true)

  // Provider-specific configuration schema
  /// Optional JSON schema describing the structure required in
  /// `MerchantAccount.providerConfig` for this provider.
  configSchema Json? // JSON schema for validation

  // Relations
  merchants          MerchantAccount[]
  webhooks           WebhookSubscription[]
  eventLogs          ProviderEventLog[]
  costStructures     ProviderCostStructure[]
  ecommerceMerchants EcommerceMerchant[] // ‚≠ê E-commerce channels using this provider

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([type])
}

/// Terminal-based merchant accounts for card-present payments (PAX devices)
/// Used by Avoqado venues (restaurants) with physical payment terminals
///
/// **Blumon Product**: PAX Terminal SDK (OAuth + DUKPT encryption)
/// **Integration**: Android TPV app with Blumon SDK
/// **Credentials**: OAuth tokens, RSA keys, DUKPT encryption keys
/// **Relationship**: Belongs to Venue via VenuePaymentConfig
///
/// **Key Fields**:
/// - credentialsEncrypted: OAuth token + RSA keys + DUKPT keys (AES-256-CBC encrypted)
/// - blumonSerialNumber: Virtual serial for OAuth (e.g., "2841548417")
/// - blumonPosId: Momentum API position ID for payment routing (e.g., "376")
///
/// ‚ö†Ô∏è See docs/MERCHANT_MODELS_ARCHITECTURE.md for why this is separate from EcommerceMerchant
model MerchantAccount {
  id String @id @default(cuid())

  // Provider relationship
  providerId String
  provider   PaymentProvider @relation(fields: [providerId], references: [id])

  // Generic merchant info
  externalMerchantId String // Provider's merchant ID
  alias              String?

  // Display and status fields for UI
  displayName  String? // User-friendly name like "Cuenta Principal", "Facturaci√≥n"
  active       Boolean @default(true) // Enable/disable account
  displayOrder Int     @default(0) // For consistent ordering in UI

  // Bank Account Information (CLABE for Mexican accounts)
  clabeNumber   String? // 18-digit CLABE (Clave Bancaria Estandarizada)
  bankName      String? // Bank name (e.g., "BBVA", "Santander", "Banorte")
  accountHolder String? // Legal account holder name (must match Venue legalName)

  // Encrypted credentials (provider-agnostic)
  credentialsEncrypted Json // Different per provider

  // Provider-specific config
  /// Per-account configuration values that comply with the provider's
  /// `configSchema`. Non-sensitive knobs live here; secrets stay encrypted.
  providerConfig Json? // Flexible config per provider

  // üÜï Blumon-specific fields (2025-11-05)
  // Used for multi-merchant payment routing on PAX terminals
  blumonSerialNumber String? // Blumon device serial (e.g., "2841548417")
  blumonPosId        String? // Momentum API posId (e.g., "376")
  blumonEnvironment  String? // "SANDBOX" or "PRODUCTION"
  blumonMerchantId   String? // Blumon's merchant identifier

  // Relations
  venueConfigsPrimary   VenuePaymentConfig[]        @relation("PrimaryAccount")
  venueConfigsSecondary VenuePaymentConfig[]        @relation("SecondaryAccount")
  venueConfigsTertiary  VenuePaymentConfig[]        @relation("TertiaryAccount")
  orgConfigsPrimary     OrganizationPaymentConfig[] @relation("OrgPrimaryAccount")
  orgConfigsSecondary   OrganizationPaymentConfig[] @relation("OrgSecondaryAccount")
  orgConfigsTertiary    OrganizationPaymentConfig[] @relation("OrgTertiaryAccount")
  costStructures        ProviderCostStructure[]
  transactionCosts      TransactionCost[]
  settlementConfigs     SettlementConfiguration[]
  payments              Payment[] // ‚≠ê Track all payments processed by this merchant account

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([providerId, externalMerchantId])
  @@index([providerId])
  @@index([active])
  @@index([displayOrder])
}

// ==========================================
// NOTE: ECOMMERCE MERCHANTS (CARD-NOT-PRESENT)
// ==========================================

/// E-commerce merchant accounts for card-not-present payments (online/web/mobile)
/// Used by Avoqado venues with online sales channels (websites, mobile apps, delivery platforms)
///
/// **Blumon Product**: Hosted Checkout API (redirect flow + webhooks)
/// **Integration**: JavaScript SDK (avoqado-v1.js) with redirect to Blumon hosted page
/// **Credentials**: API Key + Merchant ID + POS ID (stored in providerCredentials JSON)
/// **Relationship**: Belongs to Venue (same business, different sales channel)
///
/// **Key Fields**:
/// - venueId: Links to the venue (restaurant/business) that owns this e-commerce channel
/// - publicKey: "pk_live_xxx" or "pk_test_xxx" (for frontend API calls)
/// - secretKeyEncrypted: "sk_live_xxx" (for backend API calls, AES-256-CBC encrypted)
/// - providerCredentials: { blumonMerchantId, blumonApiKey, blumonPosId, webhookSecret }
///
/// **Example**: "Tacos El G√ºero" restaurant has:
/// - MerchantAccount (terminal f√≠sico en restaurante)
/// - EcommerceMerchant (sitio web de delivery)
///
/// ‚≠ê ARCHITECTURE DECISION (2025-01-13):
/// Follows industry standard (Square, Toast, Stripe, Clover) - separate models for:
/// - Card-Present (MerchantAccount) - Physical terminals with OAuth + DUKPT encryption
/// - Card-Not-Present (EcommerceMerchant) - Online checkout with API keys + hosted flow
///
/// ‚ö†Ô∏è See docs/MERCHANT_MODELS_ARCHITECTURE.md for complete architecture analysis
model EcommerceMerchant {
  id String @id @default(cuid())

  // Venue relationship (REQUIRED - same business, different sales channel)
  venueId String
  venue   Venue  @relation("VenueEcommerceMerchants", fields: [venueId], references: [id], onDelete: Cascade)

  // Channel identifier (allows multiple e-commerce channels per venue)
  channelName String @default("Web Principal") // "Web", "App M√≥vil", "Uber Eats"

  // Basic info (can be inherited from Venue or customized per channel)
  businessName String // "Mi Tienda Online SA"
  rfc          String? // Tax ID (optional initially)
  contactEmail String  @unique
  contactPhone String?
  website      String?

  // API Credentials (Avoqado SDK)
  publicKey     String @unique // "pk_live_abc123xyz" or "pk_test_abc123xyz"
  secretKeyHash String @unique // SHA-256 hash of secret key for O(1) lookup (never store plaintext)

  // Provider Integration (Multi-provider ready)
  providerId String
  provider   PaymentProvider @relation(fields: [providerId], references: [id], onDelete: Restrict)

  // Provider-specific credentials (encrypted JSON)
  // For Blumon Hosted Checkout: { blumonMerchantId, blumonApiKey, blumonPosId, webhookSecret }
  // For Stripe: { stripeAccountId, stripeSecretKey }
  // For Square: { squareApplicationId, squareAccessToken }
  providerCredentials Json

  // Cost Structure (what provider charges Avoqado)
  costStructureId String?
  costStructure   ProviderCostStructure? @relation(fields: [costStructureId], references: [id])

  // Pricing (what we charge this client)
  pricingStructureId String?
  pricingStructure   VenuePricingStructure? @relation(fields: [pricingStructureId], references: [id])

  // Webhook configuration (optional - to notify the client)
  webhookUrl    String? // "https://cliente.com/webhooks/avoqado"
  webhookSecret String? // HMAC secret for signature (stored as hash, not encrypted)
  webhookEvents String[] @default(["payment.completed", "payment.failed"])

  // Dashboard access
  dashboardUserId String? @unique
  dashboardUser   Staff?  @relation(fields: [dashboardUserId], references: [id])

  // Status & mode
  active      Boolean @default(true)
  sandboxMode Boolean @default(true) // Start in sandbox

  // Audit
  createdById String? // Staff ID who onboarded this merchant

  // Relations
  checkoutSessions CheckoutSession[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([venueId, channelName]) // One venue can have multiple e-commerce channels with unique names
  @@index([venueId])
  @@index([publicKey])
  @@index([contactEmail])
  @@index([active])
  @@index([sandboxMode])
  @@index([providerId])
}

// =============================================================================
// EXTERNAL TABLE: Session Storage (managed by connect-pg-simple)
// =============================================================================
// This table is auto-created by Express session middleware.
// We define it here to prevent Prisma from detecting it as "drift".
// DO NOT use this model in application code - it's managed externally.
model user_sessions {
  sid    String   @id @db.VarChar
  sess   Json     @db.Json
  expire DateTime @db.Timestamp(6)

  @@index([expire], map: "IDX_session_expire")
  @@map("user_sessions")
}

/// Temporary checkout sessions for SDK payments
/// Acts as a payment intent before the customer completes the payment
model CheckoutSession {
  id        String @id @default(cuid())
  sessionId String @unique // "cs_avoqado_abc123xyz" or "cs_test_abc123xyz"

  // E-commerce merchant
  ecommerceMerchantId String
  ecommerceMerchant   EcommerceMerchant @relation(fields: [ecommerceMerchantId], references: [id], onDelete: Cascade)

  // Payment details
  amount      Decimal @db.Decimal(12, 2)
  currency    String  @default("MXN")
  description String? // Description of the payment

  // Customer info (optional)
  customerEmail String?
  customerPhone String?
  customerName  String?

  // External reference (merchant's order ID)
  externalOrderId String? // "order_12345" from client's system
  metadata        Json? // Custom data from merchant: { userId: "123", productId: "456" }

  // Blumon checkout
  blumonCheckoutId  String? // ID returned by Blumon
  blumonCheckoutUrl String? // URL where we redirect the customer

  // Payment result
  paymentId String?  @unique
  payment   Payment? @relation(fields: [paymentId], references: [id])

  // Tracking & analytics
  ipAddress String? // Customer IP (fraud detection)
  userAgent String? // Browser info
  referrer  String? // Where customer came from

  // Status
  status       CheckoutStatus @default(PENDING)
  expiresAt    DateTime // 24 hours by default
  completedAt  DateTime?
  cancelledAt  DateTime?
  failedAt     DateTime?
  errorMessage String? // If failed, why

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ecommerceMerchantId])
  @@index([sessionId])
  @@index([status])
  @@index([externalOrderId])
  @@index([createdAt])
  @@index([expiresAt]) // For cleanup of expired sessions
  @@index([paymentId])
}

/// Mapping between a venue and the merchant accounts it should use.
/// Supports primary/secondary/tertiary routing plus extra rules so the
/// same venue can failover or route by business logic.
model VenuePaymentConfig {
  id      String @id @default(cuid())
  venueId String @unique
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // Account hierarchy (flexible for any provider)
  primaryAccountId String
  primaryAccount   MerchantAccount @relation("PrimaryAccount", fields: [primaryAccountId], references: [id], onDelete: Restrict)

  secondaryAccountId String?
  secondaryAccount   MerchantAccount? @relation("SecondaryAccount", fields: [secondaryAccountId], references: [id], onDelete: Restrict)

  tertiaryAccountId String?
  tertiaryAccount   MerchantAccount? @relation("TertiaryAccount", fields: [tertiaryAccountId], references: [id], onDelete: Restrict)

  // Routing rules (JSON for flexibility)
  /// Optional dynamic rules (e.g. BIN routing, amount thresholds) that decide
  /// which merchant account handles a given payment.
  routingRules Json? // { "factura": "secondary", "amount_over": 1000, "bin_routing": {...} }

  // Default processor preference
  preferredProcessor PaymentProcessor @default(AUTO)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([primaryAccountId])
  @@index([secondaryAccountId])
  @@index([tertiaryAccountId])
}

/// Organization-level payment configuration. Mirrors VenuePaymentConfig but
/// applies to all venues in the organization that don't have their own config.
/// Resolution order: VenuePaymentConfig (explicit) ‚Üí OrganizationPaymentConfig (inherited).
model OrganizationPaymentConfig {
  id             String       @id @default(cuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Account hierarchy (same structure as VenuePaymentConfig)
  primaryAccountId String
  primaryAccount   MerchantAccount @relation("OrgPrimaryAccount", fields: [primaryAccountId], references: [id], onDelete: Restrict)

  secondaryAccountId String?
  secondaryAccount   MerchantAccount? @relation("OrgSecondaryAccount", fields: [secondaryAccountId], references: [id], onDelete: Restrict)

  tertiaryAccountId String?
  tertiaryAccount   MerchantAccount? @relation("OrgTertiaryAccount", fields: [tertiaryAccountId], references: [id], onDelete: Restrict)

  // Routing rules (JSON for flexibility)
  routingRules Json?

  // Default processor preference
  preferredProcessor PaymentProcessor @default(AUTO)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([primaryAccountId])
  @@index([secondaryAccountId])
  @@index([tertiaryAccountId])
}

/// Organization-level pricing structure. Mirrors VenuePricingStructure but
/// applies to all venues in the organization that don't have their own pricing.
/// Resolution order: VenuePricingStructure (explicit) ‚Üí OrganizationPricingStructure (inherited).
model OrganizationPricingStructure {
  id String @id @default(cuid())

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Account type this pricing applies to
  accountType AccountType // PRIMARY, SECONDARY, TERTIARY

  // Pricing by transaction type (with Avoqado's margin included)
  debitRate         Decimal @db.Decimal(5, 4)
  creditRate        Decimal @db.Decimal(5, 4)
  amexRate          Decimal @db.Decimal(5, 4)
  internationalRate Decimal @db.Decimal(5, 4)

  // Fixed fees (with margin)
  fixedFeePerTransaction Decimal? @db.Decimal(8, 4)
  monthlyServiceFee      Decimal? @db.Decimal(10, 2)

  // Minimum transaction volumes or penalties
  minimumMonthlyVolume Decimal? @db.Decimal(12, 2)
  volumePenalty        Decimal? @db.Decimal(10, 2)

  // Period this pricing is valid for
  effectiveFrom DateTime
  effectiveTo   DateTime?

  // Status
  active Boolean @default(true)

  // Contract/agreement reference
  contractReference String?
  notes             String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, accountType, effectiveFrom])
  @@index([organizationId])
  @@index([accountType])
  @@index([effectiveFrom])
}

// Generic webhook subscription (works for any provider)
model WebhookSubscription {
  id      String @id @default(cuid())
  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // Provider info
  providerId String?
  provider   PaymentProvider? @relation(fields: [providerId], references: [id])

  url             String
  secretEncrypted String?
  active          Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([venueId])
  @@index([providerId])
}

// Generic provider event log
model ProviderEventLog {
  id       String       @id @default(cuid())
  provider ProviderType @default(PAYMENT_PROCESSOR)
  venueId  String?
  venue    Venue?       @relation(fields: [venueId], references: [id], onDelete: SetNull)

  // Provider info
  providerId      String?
  paymentProvider PaymentProvider? @relation(fields: [providerId], references: [id])

  eventId String?
  type    String?
  payload Json
  status  EventStatus @default(PENDING)

  createdAt   DateTime  @default(now())
  processedAt DateTime?

  @@index([provider])
  @@index([venueId])
  @@index([status])
  @@index([providerId])
}

// Stripe webhook event tracking for idempotency
// Prevents duplicate processing of webhook events
model StripeWebhookEvent {
  id        String   @id @default(cuid())
  eventId   String   @unique // Stripe event.id
  type      String // Event type (e.g., "customer.subscription.updated")
  processed Boolean  @default(false) // Whether event processing completed successfully
  createdAt DateTime @default(now())

  // Failure tracking for observability
  failureReason String? // Error message if processing failed
  failedAt      DateTime? // When the processing failed
  retryCount    Int       @default(0) // Number of times Stripe retried this event

  @@index([eventId])
  @@index([processed])
  @@index([retryCount]) // For monitoring retry patterns
}

// ==========================================
// NOTE: COST MANAGEMENT & PRICING
// ==========================================

/// Defines what the upstream provider charges Avoqado for a given
/// merchant account during a time window (the supply-side economics).
model ProviderCostStructure {
  id String @id @default(cuid())

  // Provider relationship
  providerId String
  provider   PaymentProvider @relation(fields: [providerId], references: [id])

  // Merchant account (costs can vary by account type)
  merchantAccountId String
  merchantAccount   MerchantAccount @relation(fields: [merchantAccountId], references: [id])

  // Cost breakdown by transaction type
  debitRate         Decimal @db.Decimal(5, 4) // e.g., 0.0150 (1.5%)
  creditRate        Decimal @db.Decimal(5, 4) // e.g., 0.0250 (2.5%)
  amexRate          Decimal @db.Decimal(5, 4) // e.g., 0.0350 (3.5%)
  internationalRate Decimal @db.Decimal(5, 4) // e.g., 0.0400 (4.0%)

  // Fixed costs per transaction (if applicable)
  fixedCostPerTransaction Decimal? @db.Decimal(8, 4) // e.g., 0.50 MXN

  // Monthly/volume-based costs
  monthlyFee     Decimal? @db.Decimal(10, 2)
  minimumVolume  Decimal? @db.Decimal(12, 2)
  volumeDiscount Decimal? @db.Decimal(5, 4)

  // Period this cost structure is valid for
  effectiveFrom DateTime
  effectiveTo   DateTime?

  // Status
  active Boolean @default(true)

  // Metadata
  proposalReference String? // Reference to Menta's proposal
  notes             String?

  // Relations
  transactionCosts   TransactionCost[]
  ecommerceMerchants EcommerceMerchant[] // ‚≠ê E-commerce channels using this cost structure

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([merchantAccountId, effectiveFrom])
  @@index([providerId])
  @@index([merchantAccountId])
  @@index([effectiveFrom])
}

/// Pricing agreement we offer to a venue for processing via a particular
/// account tier. Mirrors provider cost fields but includes our margin.
model VenuePricingStructure {
  id String @id @default(cuid())

  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // Account type this pricing applies to
  accountType AccountType // PRIMARY, SECONDARY, TERTIARY

  // Pricing by transaction type (with Avoqado's margin included)
  debitRate         Decimal @db.Decimal(5, 4) // e.g., 0.0200 (2.0% - includes margin)
  creditRate        Decimal @db.Decimal(5, 4) // e.g., 0.0300 (3.0% - includes margin)
  amexRate          Decimal @db.Decimal(5, 4) // e.g., 0.0400 (4.0% - includes margin)
  internationalRate Decimal @db.Decimal(5, 4) // e.g., 0.0450 (4.5% - includes margin)

  // Fixed fees (with margin)
  fixedFeePerTransaction Decimal? @db.Decimal(8, 4) // e.g., 0.75 MXN
  monthlyServiceFee      Decimal? @db.Decimal(10, 2) // e.g., 299.00 MXN

  // Minimum transaction volumes or penalties
  minimumMonthlyVolume Decimal? @db.Decimal(12, 2)
  volumePenalty        Decimal? @db.Decimal(10, 2)

  // Period this pricing is valid for
  effectiveFrom DateTime
  effectiveTo   DateTime?

  // Status
  active Boolean @default(true)

  // Contract/agreement reference
  contractReference String?
  notes             String?

  // Relations
  transactionCosts   TransactionCost[]
  ecommerceMerchants EcommerceMerchant[] // ‚≠ê E-commerce channels using this pricing structure

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([venueId, accountType, effectiveFrom])
  @@index([venueId])
  @@index([accountType])
  @@index([effectiveFrom])
}

/// Snapshot of the economics for a single payment. Links the payment to the
/// merchant account used and records both provider cost and venue charge so
/// we can compute margin and later aggregate into reports.
model TransactionCost {
  id String @id @default(cuid())

  // Payment reference
  paymentId String  @unique
  payment   Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  // Account used for this transaction
  merchantAccountId String
  merchantAccount   MerchantAccount @relation(fields: [merchantAccountId], references: [id])

  // Transaction details
  transactionType TransactionCardType
  amount          Decimal             @db.Decimal(12, 2)

  // Costs (what we pay to provider)
  providerRate       Decimal @db.Decimal(5, 4) // Rate charged by provider
  providerCostAmount Decimal @db.Decimal(10, 4) // Actual cost amount
  providerFixedFee   Decimal @default(0) @db.Decimal(8, 4)

  // Revenue (what we charge venue)
  venueRate         Decimal @db.Decimal(5, 4) // Rate we charge venue
  venueChargeAmount Decimal @db.Decimal(10, 4) // What we charge venue
  venueFixedFee     Decimal @default(0) @db.Decimal(8, 4)

  // Profit calculation
  grossProfit  Decimal @db.Decimal(10, 4) // venueCharge - providerCost
  profitMargin Decimal @db.Decimal(5, 4) // grossProfit / venueCharge

  // References to cost structures used
  providerCostStructureId String?
  providerCostStructure   ProviderCostStructure? @relation(fields: [providerCostStructureId], references: [id])

  venuePricingStructureId String?
  venuePricingStructure   VenuePricingStructure? @relation(fields: [venuePricingStructureId], references: [id])

  createdAt DateTime @default(now())

  @@index([paymentId])
  @@index([merchantAccountId])
  @@index([transactionType])
  @@index([createdAt])
}

// ==========================================
// SETTLEMENT TRACKING & AVAILABLE BALANCE
// ==========================================

/// Settlement configuration per merchant account and card type
/// Defines the rules for when funds will be available to the venue
model SettlementConfiguration {
  id String @id @default(cuid())

  // Merchant account this config applies to
  merchantAccountId String
  merchantAccount   MerchantAccount @relation(fields: [merchantAccountId], references: [id], onDelete: Cascade)

  // Card type this configuration applies to
  cardType TransactionCardType

  // Settlement timing rules
  settlementDays    Int // Number of days until settlement (e.g., 1, 3, 7)
  settlementDayType SettlementDayType // BUSINESS_DAYS or CALENDAR_DAYS
  cutoffTime        String // Time of day cutoff (e.g., "23:00")
  cutoffTimezone    String // Timezone for cutoff (e.g., "America/Mexico_City")

  // Effective date range for this configuration
  effectiveFrom DateTime
  effectiveTo   DateTime?

  // Metadata
  notes     String? // Admin notes about this configuration
  createdBy String? // Staff ID who created this config

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([merchantAccountId, cardType, effectiveFrom])
  @@index([merchantAccountId])
  @@index([cardType])
  @@index([effectiveFrom])
}

/// Settlement simulation records
/// Stores user simulations for historical tracking and analytics
model SettlementSimulation {
  id String @id @default(cuid())

  // User who ran the simulation
  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)
  userId  String
  user    Staff  @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Simulation parameters
  simulationType  SimulationType
  simulatedAmount Decimal              @db.Decimal(12, 2)
  cardType        TransactionCardType?
  simulatedDate   DateTime // When the hypothetical transaction would occur
  simulatedTime   String? // Time of day for the transaction (e.g., "14:30")

  // Simulation results (stored as JSON for flexibility)
  results Json // Contains: estimatedSettlementDate, netAmount, fees, etc.

  createdAt DateTime @default(now())

  @@index([venueId])
  @@index([userId])
  @@index([simulationType])
  @@index([createdAt])
}

/// Settlement Incident Tracking
/// Tracks when expected settlements don't arrive on time
model SettlementIncident {
  id String @id @default(cuid())

  // Transaction that didn't settle as expected
  transactionId String?
  transaction   VenueTransaction? @relation(fields: [transactionId], references: [id], onDelete: SetNull)

  // Venue affected
  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // Incident details
  estimatedSettlementDate DateTime // When we expected settlement
  actualSettlementDate    DateTime? // When it actually settled (if resolved)
  delayDays               Int? // Days delayed (calculated)

  // Processor information
  processorName   String // e.g., "Blumonpay", "Menta", "Clip"
  cardType        TransactionCardType
  transactionDate DateTime
  amount          Decimal             @db.Decimal(12, 2)

  // Status tracking
  status         IncidentStatus @default(PENDING_CONFIRMATION)
  detectionDate  DateTime       @default(now()) // When we detected the issue
  resolutionDate DateTime? // When incident was resolved

  // Notes and follow-up
  notes           String?   @db.Text
  alertedSOFOM    Boolean   @default(false) // Did we alert SOFOM?
  alertedAt       DateTime?
  resolvedBy      String? // Staff ID who resolved
  resolutionNotes String?   @db.Text

  // Relations
  confirmations SettlementConfirmation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([venueId])
  @@index([status])
  @@index([estimatedSettlementDate])
  @@index([detectionDate])
  @@index([processorName])
}

/// Manual Settlement Confirmations
/// Tracks when venues/admins manually confirm settlement arrival
model SettlementConfirmation {
  id String @id @default(cuid())

  // Related incident (optional - can be standalone confirmation)
  incidentId String?
  incident   SettlementIncident? @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  // Transaction confirmed
  transactionId String?
  transaction   VenueTransaction? @relation(fields: [transactionId], references: [id], onDelete: SetNull)

  // Venue
  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // Confirmation details
  confirmedBy       String // Staff ID who confirmed
  confirmationDate  DateTime  @default(now())
  settlementArrived Boolean // Did money actually arrive?
  actualDate        DateTime? // When money arrived (if yes)

  // Evidence (optional)
  notes         String? @db.Text
  evidenceUrl   String? // Photo/document of bank statement
  bankReference String? // Bank transaction reference

  createdAt DateTime @default(now())

  @@index([venueId])
  @@index([incidentId])
  @@index([transactionId])
  @@index([confirmationDate])
}

/// Processor Reliability Metrics
/// Tracks historical accuracy of settlement projections per processor
model ProcessorReliabilityMetric {
  id String @id @default(cuid())

  // Processor identification
  processorName String // e.g., "Blumonpay", "Menta", "Clip"
  cardType      TransactionCardType

  // Time period for this metric
  periodStart DateTime
  periodEnd   DateTime

  // Volume metrics
  totalTransactions Int
  totalAmount       Decimal @db.Decimal(15, 2)

  // Accuracy metrics
  onTimeSettlements  Int // Settled on expected date
  delayedSettlements Int // Settled late
  failedSettlements  Int @default(0) // Never settled

  // Delay statistics
  averageDelayDays Decimal @default(0) @db.Decimal(5, 2) // Average days late
  maxDelayDays     Int     @default(0) // Worst delay

  // Reliability score (0-100)
  reliabilityScore Decimal @db.Decimal(5, 2) // % of on-time settlements

  // Confidence level
  confidence ConfidenceLevel @default(LOW)

  // Metadata
  calculatedAt DateTime @default(now())
  notes        String?  @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([processorName, cardType, periodStart])
  @@index([processorName])
  @@index([cardType])
  @@index([periodStart])
  @@index([reliabilityScore])
}

/// Holiday Calendar
/// Mexican federal and banking holidays for settlement calculations
model HolidayCalendar {
  id String @id @default(cuid())

  // Holiday details
  name        String
  date        DateTime    @db.Date
  year        Int
  holidayType HolidayType
  isBanking   Boolean     @default(true) // Affects settlements?

  // Metadata
  description String?
  createdBy   String? // Staff ID who added
  notes       String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([date, holidayType])
  @@index([date])
  @@index([year])
  @@index([holidayType])
  @@index([isBanking])
}

// Monthly profit summary per venue
model MonthlyVenueProfit {
  id String @id @default(cuid())

  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // Period
  year  Int
  month Int

  // Volume metrics
  totalTransactions Int
  totalVolume       Decimal @db.Decimal(15, 2)

  // By transaction type
  debitTransactions         Int     @default(0)
  debitVolume               Decimal @default(0) @db.Decimal(15, 2)
  creditTransactions        Int     @default(0)
  creditVolume              Decimal @default(0) @db.Decimal(15, 2)
  amexTransactions          Int     @default(0)
  amexVolume                Decimal @default(0) @db.Decimal(15, 2)
  internationalTransactions Int     @default(0)
  internationalVolume       Decimal @default(0) @db.Decimal(15, 2)

  // Financial summary
  totalProviderCosts  Decimal @db.Decimal(12, 4) // What we paid to providers
  totalVenueCharges   Decimal @db.Decimal(12, 4) // What we charged venue
  totalGrossProfit    Decimal @db.Decimal(12, 4) // Our profit
  averageProfitMargin Decimal @db.Decimal(5, 4) // Average margin %

  // Monthly fees
  monthlyProviderFees Decimal @default(0) @db.Decimal(10, 2)
  monthlyServiceFees  Decimal @default(0) @db.Decimal(10, 2)

  // Status
  status ProfitStatus @default(CALCULATED)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([venueId, year, month])
  @@index([venueId])
  @@index([year, month])
  @@index([status])
}

// ==========================================
// NOTE: AUDIT & LOGS
// ==========================================

model ActivityLog {
  id      String  @id @default(cuid())
  staffId String?
  staff   Staff?  @relation(fields: [staffId], references: [id])
  venueId String

  action   String
  entity   String?
  entityId String?

  data      Json?
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([staffId])
  @@index([venueId])
  @@index([entity, entityId])
  @@index([createdAt])
}

// ==========================================
// NOTE: CUSTOMERS (FUTURE IMPLEMENTATION)
// ==========================================

model Customer {
  id    String  @id @default(cuid())
  email String? // Unique per venue, not globally (allows same email in different venues)
  phone String? // Unique per venue, not globally

  firstName String?
  lastName  String?
  birthDate DateTime?
  gender    String?

  // Auth
  password   String?
  provider   AuthProvider @default(EMAIL)
  providerId String?

  // Multi-tenant
  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // Customer grouping
  customerGroupId String?
  customerGroup   CustomerGroup? @relation(fields: [customerGroupId], references: [id], onDelete: SetNull)

  // Loyalty & tracking
  loyaltyPoints     Int       @default(0)
  totalVisits       Int       @default(0)
  lastVisitAt       DateTime?
  firstVisitAt      DateTime?
  totalSpent        Decimal   @default(0) @db.Decimal(12, 2)
  averageOrderValue Decimal   @default(0) @db.Decimal(10, 2)

  // Additional info
  notes String?  @db.Text
  tags  String[] // ["VIP", "Allergic-Nuts", "Birthday-Dec"]

  // Preferences
  language         String  @default("es")
  marketingConsent Boolean @default(false)

  active Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  orders              Order[]
  loyaltyTransactions LoyaltyTransaction[]

  // Discount System (Phase 2)
  customerDiscounts CustomerDiscount[]
  couponRedemptions CouponRedemption[]

  // Multi-customer support (N:N relationship with orders)
  orderAssociations OrderCustomer[]

  // Reservations
  reservations    Reservation[]
  waitlistEntries ReservationWaitlistEntry[]

  @@unique([venueId, email]) // Unique email per venue (not globally)
  @@unique([venueId, phone]) // Unique phone per venue (not globally)
  @@index([venueId])
  @@index([customerGroupId])
}

model CustomerGroup {
  id      String @id @default(cuid())
  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  name        String
  description String? @db.Text
  color       String? // For UI display (e.g., "#FF5733")

  // Auto-assignment rules (future implementation)
  autoAssignRules Json? // E.g., { "minSpent": 1000, "minVisits": 10 }

  active Boolean @default(true)

  // Demo data flag (for cleanup on conversion)
  isDemo Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  customers Customer[]

  // Discount System (Phase 2)
  discounts Discount[]

  @@unique([venueId, name])
  @@index([venueId])
}

model LoyaltyConfig {
  id      String @id @default(cuid())
  venueId String @unique
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // Earning rules
  pointsPerDollar Decimal @default(1) @db.Decimal(5, 2) // 1 point per $1 spent
  pointsPerVisit  Int     @default(0) // Bonus points per visit (e.g., 10)

  // Redemption rules
  redemptionRate   Decimal @default(0.01) @db.Decimal(5, 4) // $0.01 per point
  minPointsRedeem  Int     @default(100) // Minimum points to redeem
  pointsExpireDays Int? // Points expire after X days (null = never expire)

  active Boolean @default(true)

  // Demo data flag (for cleanup on conversion)
  isDemo Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LoyaltyTransaction {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  type   LoyaltyTransactionType // EARN, REDEEM, EXPIRE, ADJUST
  points Int // Positive for EARN/ADJUST-add, negative for REDEEM/EXPIRE/ADJUST-subtract

  // Context
  orderId String?
  order   Order?  @relation(fields: [orderId], references: [id], onDelete: SetNull)

  // Metadata
  reason String? @db.Text // E.g., "Birthday bonus", "Manual adjustment by manager"

  // Audit
  createdById String?
  createdBy   StaffVenue? @relation("LoyaltyTransactionCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([customerId, createdAt])
  @@index([orderId])
}

// ==========================================
// NOTE: DISCOUNT SYSTEM
// ==========================================

model Discount {
  id      String @id @default(cuid())
  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // Basic info
  name        String
  description String?      @db.Text
  type        DiscountType // PERCENTAGE, FIXED_AMOUNT, COMP
  value       Decimal      @db.Decimal(10, 4) // Percentage (0-100) or fixed amount

  // Scope - what the discount applies to
  scope DiscountScope @default(ORDER) // ORDER, ITEM, CATEGORY, CUSTOMER_GROUP

  // Target IDs (based on scope)
  targetItemIds          String[] // Product IDs when scope = ITEM
  targetCategoryIds      String[] // Category IDs when scope = CATEGORY
  targetModifierIds      String[] // Modifier IDs for modifier-level discounts
  targetModifierGroupIds String[] // ModifierGroup IDs

  // Customer Group targeting
  customerGroupId String?
  customerGroup   CustomerGroup? @relation(fields: [customerGroupId], references: [id], onDelete: SetNull)

  // Automatic application
  isAutomatic Boolean @default(false) // Apply automatically when conditions met
  priority    Int     @default(0) // Higher priority = applied first

  // Rules / Conditions
  minPurchaseAmount Decimal? @db.Decimal(10, 2) // Minimum order total required
  maxDiscountAmount Decimal? @db.Decimal(10, 2) // Cap on discount amount
  minQuantity       Int? // Minimum item quantity required

  // BOGO (Buy One Get One) configuration
  buyQuantity        Int? // Buy X items...
  getQuantity        Int? // ...get Y items
  getDiscountPercent Decimal? @db.Decimal(5, 2) // ...at Z% off (e.g., 100 = free)
  buyItemIds         String[] // Items that qualify for "buy"
  getItemIds         String[] // Items that qualify for "get" (can be different)

  // Time-based restrictions
  validFrom  DateTime? // Start date
  validUntil DateTime? // End date
  daysOfWeek Int[] // 0-6 (Sunday-Saturday), empty = all days
  timeFrom   String? // "09:00" - start time
  timeUntil  String? // "17:00" - end time

  // Usage limits
  maxTotalUses       Int? // Total uses across all customers
  maxUsesPerCustomer Int? // Uses per individual customer
  currentUses        Int  @default(0) // Counter

  // Comp-specific fields
  requiresApproval Boolean @default(false) // Manager approval needed
  compReason       String? @db.Text // Why comp was given

  // Tax handling
  applyBeforeTax Boolean @default(true) // Apply discount before calculating tax
  modifyTaxBasis Boolean @default(true) // Reduce taxable amount

  // Stacking rules
  isStackable   Boolean @default(false) // Can combine with other discounts
  stackPriority Int     @default(0) // Order when stacking

  // Status
  active Boolean @default(true)

  // Audit
  createdById String?
  createdBy   StaffVenue? @relation("DiscountCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  couponCodes       CouponCode[]
  customerDiscounts CustomerDiscount[]
  orderDiscounts    OrderDiscount[]

  @@index([venueId])
  @@index([isAutomatic])
  @@index([active])
  @@index([customerGroupId])
  @@index([validFrom, validUntil])
}

model CouponCode {
  id         String   @id @default(cuid())
  discountId String
  discount   Discount @relation(fields: [discountId], references: [id], onDelete: Cascade)

  code String @unique // The actual coupon code (e.g., "SAVE20")

  // Override discount limits for this specific code
  maxUses            Int? // Total uses for this code
  maxUsesPerCustomer Int? // Uses per customer for this code
  currentUses        Int  @default(0)

  // Override discount validity for this specific code
  minPurchaseAmount Decimal?  @db.Decimal(10, 2)
  validFrom         DateTime?
  validUntil        DateTime?

  active Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  redemptions    CouponRedemption[]
  orderDiscounts OrderDiscount[]

  @@index([discountId])
  @@index([code])
  @@index([active])
}

model CouponRedemption {
  id           String     @id @default(cuid())
  couponCodeId String
  couponCode   CouponCode @relation(fields: [couponCodeId], references: [id], onDelete: Cascade)

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  orderId String @unique
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  amountSaved Decimal @db.Decimal(10, 2) // How much the customer saved

  redeemedAt DateTime @default(now())

  @@index([couponCodeId])
  @@index([customerId])
  @@index([orderId])
}

model CustomerDiscount {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  discountId String
  discount   Discount @relation(fields: [discountId], references: [id], onDelete: Cascade)

  // Status
  active Boolean @default(true)

  // Validity override for this customer
  validFrom  DateTime?
  validUntil DateTime?

  // Usage tracking
  usageCount Int  @default(0)
  maxUses    Int? // Override discount maxUsesPerCustomer

  // Audit
  assignedById String?
  assignedBy   StaffVenue? @relation("CustomerDiscountAssignedBy", fields: [assignedById], references: [id], onDelete: SetNull)

  assignedAt DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([customerId, discountId])
  @@index([customerId])
  @@index([discountId])
  @@index([active])
}

model OrderDiscount {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Source of discount (one of these should be set)
  discountId   String?
  discount     Discount?   @relation(fields: [discountId], references: [id], onDelete: SetNull)
  couponCodeId String?
  couponCode   CouponCode? @relation(fields: [couponCodeId], references: [id], onDelete: SetNull)

  // Discount details (denormalized for historical accuracy)
  type  DiscountType
  name  String
  value Decimal      @db.Decimal(10, 4) // Original value (% or fixed)

  // Calculated amounts
  amount       Decimal @db.Decimal(10, 2) // Actual discount amount applied
  taxReduction Decimal @default(0) @db.Decimal(10, 2) // Tax saved due to discount

  // Flags
  isComp      Boolean @default(false) // Was this a comp?
  isAutomatic Boolean @default(false) // Applied automatically?
  isManual    Boolean @default(false) // Applied manually at checkout?

  // Comp-specific
  compReason String? @db.Text

  // Audit
  appliedById    String?
  appliedBy      StaffVenue? @relation("OrderDiscountAppliedBy", fields: [appliedById], references: [id], onDelete: SetNull)
  authorizedById String? // Manager who approved (if requiresApproval)
  authorizedBy   StaffVenue? @relation("OrderDiscountAuthorizedBy", fields: [authorizedById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([discountId])
  @@index([couponCodeId])
}

enum DiscountType {
  PERCENTAGE // E.g., 10% off
  FIXED_AMOUNT // E.g., $5 off
  COMP // Full comp (100% off)
}

enum DiscountScope {
  ORDER // Applies to entire order
  ITEM // Applies to specific items
  CATEGORY // Applies to items in categories
  MODIFIER // Applies to modifiers
  MODIFIER_GROUP // Applies to modifier groups
  CUSTOMER_GROUP // Auto-apply to customer group members
  QUANTITY // Quantity-based (BOGO)
}

// ==========================================
// NOTE: NOTIFICATIONS SYSTEM
// ==========================================

model Notification {
  id String @id @default(cuid())

  // Recipient
  recipientId String
  recipient   Staff  @relation(fields: [recipientId], references: [id], onDelete: Cascade)

  // Context
  venueId String?
  venue   Venue?  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // Notification content
  type        NotificationType
  title       String
  message     String
  actionUrl   String? // Deep link or route
  actionLabel String? // Button text like "View Order"

  // Metadata
  entityType String? // "Order", "Payment", "Review", etc.
  entityId   String? // ID of related entity
  metadata   Json? // Additional context data

  // Status
  isRead   Boolean              @default(false)
  readAt   DateTime?
  priority NotificationPriority @default(NORMAL)

  // Delivery channels
  channels NotificationChannel[] @default([IN_APP])

  // Tracking
  sentAt   DateTime?
  failedAt DateTime?
  errorMsg String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([recipientId])
  @@index([venueId])
  @@index([type])
  @@index([isRead])
  @@index([createdAt])
  @@index([entityType, entityId])
}

model NotificationPreference {
  id String @id @default(cuid())

  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)

  venueId String?
  venue   Venue?  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // Notification type settings
  type     NotificationType
  enabled  Boolean               @default(true)
  channels NotificationChannel[] @default([IN_APP])
  priority NotificationPriority  @default(NORMAL)

  // Scheduling
  quietStart String? // "22:00" - don't send notifications after this time
  quietEnd   String? // "08:00" - don't send notifications before this time

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([staffId, venueId, type])
  @@index([staffId])
  @@index([type])
}

model NotificationTemplate {
  id String @id @default(cuid())

  type        NotificationType
  language    String           @default("es")
  title       String
  message     String
  actionLabel String?

  // Variables that can be used in templates
  // e.g., "{{customerName}} left a {{rating}}-star review"
  variables String[] @default([])

  active Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([type, language])
  @@index([type])
  @@index([active])
}

// Device tokens for push notifications (FCM)
model DeviceToken {
  id String @id @default(cuid())

  // Owner
  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)

  // Token info
  token    String         @unique // FCM token
  platform DevicePlatform

  // Device info (optional, for debugging)
  deviceModel String? // "iPhone 15 Pro", "Pixel 8"
  osVersion   String? // "iOS 17.2", "Android 14"
  appVersion  String? // "1.0.0"
  bundleId    String? // "io.avoqado.pos", "com.jaac.avoqado_tpv"

  // Status
  active    Boolean  @default(true)
  lastUsed  DateTime @default(now())
  failCount Int      @default(0) // Consecutive delivery failures

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([staffId])
  @@index([platform])
  @@index([active])
}

model PosCommand {
  id            String        @id @default(cuid())
  venueId       String
  venue         Venue         @relation(fields: [venueId], references: [id])
  entityType    String // "Order", "Payment"
  entityId      String // ID en nuestra BD
  commandType   CommandType // CREATE, UPDATE, DELETE
  payload       Json
  status        CommandStatus @default(PENDING)
  attempts      Int           @default(0)
  lastAttemptAt DateTime?
  errorMessage  String?
  completedAt   DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([venueId, status])
  @@index([entityType, entityId])
  @@index([status, createdAt])
}

// ==========================================
// NOTE: ENUMS
// ==========================================

enum PaymentSource {
  TPV // Terminal
  DASHBOARD_TEST // Test payments from superadmin dashboard
  QR // Customer QR
  WEB // Website
  APP // Mobile app
  PHONE // Phone order
  POS // Direct from POS
  SDK // External merchant using Avoqado SDK
  OTHER
}

/// Business type enum - expanded to support multiple business verticals
/// Category is derived in code via getBusinessCategory() helper function
/// See: src/utils/businessCategory.ts
enum BusinessType {
  // === FOOD_SERVICE Category ===
  RESTAURANT // Full-service restaurant
  BAR // Bar, pub, cantina
  CAFE // Coffee shop, cafeter√≠a
  BAKERY // Panader√≠a, pasteler√≠a
  FOOD_TRUCK // Food truck, puesto m√≥vil
  FAST_FOOD // Quick service restaurant
  CATERING // Catering service
  CLOUD_KITCHEN // Virtual kitchen, delivery only

  // === RETAIL Category ===
  RETAIL_STORE // General retail store
  JEWELRY // Joyer√≠a
  CLOTHING // Tienda de ropa, boutique
  ELECTRONICS // Electr√≥nica, celulares
  PHARMACY // Farmacia
  CONVENIENCE_STORE // Tienda de conveniencia, OXXO-style
  SUPERMARKET // Supermercado, grocery
  LIQUOR_STORE // Licorer√≠a, vinater√≠a
  FURNITURE // Muebler√≠a
  HARDWARE // Ferreter√≠a
  BOOKSTORE // Librer√≠a
  PET_STORE // Tienda de mascotas

  // === SERVICES Category ===
  SALON // Hair salon, barber√≠a
  SPA // Spa, wellness center
  FITNESS // Gym, fitness studio
  CLINIC // Cl√≠nica m√©dica, dental
  VETERINARY // Veterinaria
  AUTO_SERVICE // Taller mec√°nico, autolavado
  LAUNDRY // Lavander√≠a, tintorer√≠a
  REPAIR_SHOP // Reparaci√≥n general

  // === HOSPITALITY Category ===
  HOTEL // Hotel
  HOSTEL // Hostel
  RESORT // Resort, vacation property

  // === ENTERTAINMENT Category ===
  CINEMA // Cine
  ARCADE // Arcade, game center
  EVENT_VENUE // Sal√≥n de eventos
  NIGHTCLUB // Antro, club nocturno
  BOWLING // Boliche

  OTHER // Catch-all for unlisted types
}

enum EntityType {
  PERSONA_FISICA // Natural person / individual
  PERSONA_MORAL // Legal entity / company
}

enum VerificationStatus {
  NOT_SUBMITTED // Documents not yet uploaded
  PENDING_REVIEW // Awaiting Superadmin KYC review
  IN_REVIEW // Superadmin is currently reviewing
  VERIFIED // KYC approved, venue can operate
  REJECTED // KYC rejected, needs resubmission
}

/// Venue operational status - single source of truth for venue lifecycle
/// Consolidates previous isOnboardingDemo/isLiveDemo booleans into status
/// Mexican law requires data retention - PRODUCTION venues cannot be hard deleted
/// DEMO venues (LIVE_DEMO, TRIAL) CAN be deleted as they contain fake data
enum VenueStatus {
  // === Demo States (Ephemeral - CAN be deleted) ===
  LIVE_DEMO // Public demo.dashboard.avoqado.io (anonymous, auto-cleanup)
  TRIAL // Private onboarding demo (30-day trial, user registered)

  // === Production States (SAT - CANNOT be deleted) ===
  ONBOARDING // Real venue being configured (post-demo conversion)
  PENDING_ACTIVATION // KYC submitted, awaiting Avoqado review
  ACTIVE // Fully operational venue
  SUSPENDED // Suspended by venue owner (voluntary, can reactivate)
  ADMIN_SUSPENDED // Suspended by Avoqado (non-payment, policy violation)
  CLOSED // Permanently closed (data retained for audit, immutable)
}

/// Venue type enum - mirrors BusinessType for backwards compatibility
/// Both enums should stay in sync
enum VenueType {
  // === FOOD_SERVICE Category ===
  RESTAURANT
  BAR
  CAFE
  BAKERY
  FOOD_TRUCK
  FAST_FOOD
  CATERING
  CLOUD_KITCHEN

  // === RETAIL Category ===
  RETAIL_STORE
  JEWELRY
  CLOTHING
  ELECTRONICS
  PHARMACY
  CONVENIENCE_STORE
  SUPERMARKET
  LIQUOR_STORE
  FURNITURE
  HARDWARE
  BOOKSTORE
  PET_STORE
  TELECOMUNICACIONES // Telcel/AT&T stores, phone repair shops, etc.

  // === SERVICES Category ===
  SALON
  SPA
  FITNESS
  CLINIC
  VETERINARY
  AUTO_SERVICE
  LAUNDRY
  REPAIR_SHOP

  // === HOSPITALITY Category ===
  HOTEL
  HOSTEL
  RESORT

  // === ENTERTAINMENT Category ===
  CINEMA
  ARCADE
  EVENT_VENUE
  NIGHTCLUB
  BOWLING

  // === LEGACY (kept for backwards compatibility) ===
  HOTEL_RESTAURANT
  FITNESS_STUDIO

  OTHER
}

enum PosType {
  SOFTRESTAURANT
  SQUARE
  TOAST
  CLOVER
  ALOHA
  MICROS
  NCR
  CUSTOM
  NONE
}

enum PosStatus {
  NOT_INTEGRATED
  CONNECTING
  CONNECTED
  ERROR
  DISABLED
}

enum FeeType {
  PERCENTAGE
  FIXED
  TIERED
}

enum StaffRole {
  SUPERADMIN // Full access to everything
  OWNER // Full access to everything
  ADMIN // Full venue access
  MANAGER // Operations access
  WAITER // Service access
  CASHIER // Payment access only
  KITCHEN // Kitchen display access
  HOST // Reservations/seating
  VIEWER // Read-only
}

enum OrgRole {
  OWNER // Organization owner
  ADMIN // Organization admin
  MEMBER // Regular member
  VIEWER // Read-only access
}

enum ProductType {
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // NEW: Square-aligned product types (January 2026)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  REGULAR // Physical products (retail, merchandise) - DEFAULT for new products
  FOOD_AND_BEV // Food AND beverage (use isAlcoholic boolean for alcohol)
  APPOINTMENTS_SERVICE // Bookable services (haircuts, massages, appointments)
  EVENT // Event tickets (concerts, classes, experiences)
  DIGITAL // Digital products (ebooks, courses, downloads)
  DONATION // Donations (tips, causes, roundup)

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // LEGACY: Kept for backwards compatibility - DO NOT USE FOR NEW PRODUCTS
  // Migration: FOOD/BEVERAGE/ALCOHOL ‚Üí FOOD_AND_BEV + isAlcoholic
  //            RETAIL ‚Üí REGULAR
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  FOOD // @deprecated Use FOOD_AND_BEV
  BEVERAGE // @deprecated Use FOOD_AND_BEV
  ALCOHOL // @deprecated Use FOOD_AND_BEV + isAlcoholic=true
  RETAIL // @deprecated Use REGULAR
  SERVICE // General services (kept as-is, use APPOINTMENTS_SERVICE for bookable)
  OTHER // Catch-all
}

enum MenuType {
  REGULAR
  BREAKFAST
  LUNCH
  DINNER
  SEASONAL
  CATERING
  DRINKS
  KIDS
}

enum MovementType {
  PURCHASE // New stock arrival
  SALE // Sold to customer
  ADJUSTMENT // Manual adjustment
  LOSS // Damage, theft, expiry
  TRANSFER // Between venues
  COUNT // Physical count correction
}

enum OrderType {
  DINE_IN
  TAKEOUT
  DELIVERY
  PICKUP
}

enum OrderSource {
  TPV // Terminal (standard TPV mode)
  KIOSK // Self-service kiosk mode (abandoned orders should NOT appear as cuentas por cobrar)
  QR // Customer QR
  WEB // Website
  APP // Mobile app (generic)
  AVOQADO_IOS // Avoqado iOS app
  AVOQADO_ANDROID // Avoqado Android app
  PHONE // Phone order
  POS // Direct from POS
}

enum TableShape {
  SQUARE // 2-4 person square table
  ROUND // Round table
  RECTANGLE // Long table (6+ people)
}

enum TableStatus {
  AVAILABLE // Free, can be assigned
  OCCUPIED // Has active order
  RESERVED // Reserved for future
  CLEANING // Being cleaned/prepared
}

enum FloorElementType {
  WALL // Decorative/dividing wall
  BAR_COUNTER // Bar counter
  SERVICE_AREA // Kitchen, bathroom, storage
  LABEL // Decorative text label (e.g., "Terraza", "VIP")
  DOOR // Door/entrance
}

enum PaymentTiming {
  PAY_BEFORE // Retail, QSR: Pay before receiving product
  PAY_AFTER // Restaurant: Pay after consuming
}

enum InventoryDeduction {
  ON_ORDER_CREATE // Restaurant: Deduct when order created/updated (kitchen starts)
  ON_PAYMENT // Retail: Deduct when payment processed (handed over)
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  COMPLETED
  CANCELLED
  DELETED
}

enum KitchenStatus {
  PENDING
  RECEIVED
  PREPARING
  READY
  SERVED
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  REFUNDED
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  DIGITAL_WALLET
  BANK_TRANSFER
  CRYPTOCURRENCY // B4Bit crypto payments (BTC, ETH, USDT, etc.)
  OTHER
}

enum CheckoutStatus {
  PENDING // Session created, waiting for customer
  PROCESSING // Customer redirected to Blumon, payment in progress
  COMPLETED // Payment successful
  EXPIRED // Session expired (24 hours)
  CANCELLED // Customer cancelled or merchant cancelled
  FAILED // Payment failed
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum TransactionType {
  PAYMENT
  REFUND
  ADJUSTMENT
}

enum SettlementStatus {
  PENDING
  PROCESSING
  SETTLED
  FAILED
}

enum ShiftStatus {
  OPEN
  CLOSING
  CLOSED
}

enum FeatureCategory {
  OPERATIONS
  PAYMENTS
  MARKETING
  ANALYTICS
  INTEGRATIONS
}

enum ChargeType {
  TRANSACTION_FEE
  FEATURE_FEE
  SETUP_FEE
  OVERAGE_FEE
  OTHER
}

enum InvoiceStatus {
  DRAFT
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

enum WebhookEventStatus {
  PENDING // Webhook received, not yet processed
  SUCCESS // Processed successfully
  FAILED // Processing failed
  RETRYING // Currently retrying after failure
}

enum ReviewSource {
  AVOQADO
  GOOGLE
  TRIPADVISOR
  FACEBOOK
  YELP
  TPV
}

enum TerminalType {
  TPV_ANDROID
  TPV_IOS
  PRINTER_RECEIPT
  PRINTER_KITCHEN
  KDS // Kitchen Display System
}

enum TerminalStatus {
  PENDING_ACTIVATION // Purchased but no hardware serial number yet
  ACTIVE
  INACTIVE
  MAINTENANCE
  RETIRED
}

enum SyncStatus {
  PENDING
  SYNCING
  SYNCED
  FAILED
  NOT_REQUIRED
}

enum SaleVerificationStatus {
  PENDING // Just created, awaiting processing
  PROCESSING // Processing inventory deduction
  COMPLETED // Successfully processed
  FAILED // Failed to process
  SKIPPED // User skipped verification
}

enum InvitationType {
  ORGANIZATION_ADMIN // Invitaci√≥n para admin de organizaci√≥n
  VENUE_STAFF // Invitaci√≥n para staff de venue
  VENUE_ADMIN // Invitaci√≥n para admin de venue espec√≠fico
}

enum InvitationStatus {
  PENDING // Esperando aceptaci√≥n
  ACCEPTED // Aceptada y usada
  DECLINED // Rechazada expl√≠citamente
  EXPIRED // Expir√≥ antes de usar
  REVOKED // Revocada por admin
}

enum AuthProvider {
  EMAIL
  GOOGLE
  FACEBOOK
  APPLE
}

enum LoyaltyTransactionType {
  EARN // Customer earns points (from purchase or visit)
  REDEEM // Customer redeems points (discount applied)
  EXPIRE // Points expire (automatic or manual)
  ADJUST // Manual adjustment by staff (can be + or -)
}

enum ReceiptStatus {
  PENDING // Generado pero no enviado
  SENT // Enviado exitosamente
  DELIVERED // Confirmado como entregado por el servicio de email (si lo soporta)
  VIEWED // El cliente abri√≥ el link
  ERROR // Fallo en el env√≠o
}

enum OriginSystem {
  AVOQADO // Creado en nuestro sistema (la fuente de verdad por defecto)
  POS_SOFTRESTAURANT // Sincronizado desde el POS SoftRestaurant
}

enum CommandType {
  CREATE
  UPDATE
  DELETE
  CANCEL
}

enum CommandStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum PosConnectionState {
  ONLINE // Recibiendo heartbeats normalmente
  OFFLINE // No hemos recibido un heartbeat en mucho tiempo
  NEEDS_RECONCILIATION // Se detect√≥ un cambio de InstanceId (¬°Alerta m√°xima!)
}

enum PaymentProcessor {
  LEGACY
  MENTA
  CLIP
  BANK_DIRECT
  AUTO
}

enum ProviderType {
  PAYMENT_PROCESSOR // Menta, Stripe, etc.
  BANK_DIRECT // Direct bank integration
  WALLET // Clip, PayPal, etc.
  GATEWAY // Payment gateway
  OTHER
}

enum EventStatus {
  PENDING
  PROCESSED
  ERROR
}

enum AccountType {
  PRIMARY
  SECONDARY
  TERTIARY
}

enum TransactionCardType {
  DEBIT
  CREDIT
  AMEX
  INTERNATIONAL
  OTHER
}

enum SettlementDayType {
  BUSINESS_DAYS // Exclude weekends and holidays
  CALENDAR_DAYS // Count all days including weekends
}

enum SimulationType {
  MANUAL_TRANSACTION // Simulate a hypothetical transaction
  HISTORICAL_PROJECTION // Project based on historical patterns
}

enum ProfitStatus {
  CALCULATED
  VERIFIED
  DISPUTED
  FINALIZED
}

enum IncidentStatus {
  PENDING_CONFIRMATION // Detected but not confirmed
  CONFIRMED_DELAY // Venue confirmed it's delayed
  RESOLVED // Settlement arrived, incident closed
  ESCALATED // Requires SuperAdmin attention
}

enum ConfidenceLevel {
  HIGH // 95%+ reliability
  MEDIUM // 85-95% reliability
  LOW // <85% reliability
}

enum HolidayType {
  FEDERAL // Federal holiday
  BANKING // Banking holiday (affects settlements)
  GENERAL // General observance
}

enum ConfirmationMethod {
  AUTOMATIC // Detected via API/webhook
  MANUAL // Venue/admin confirmed
  BANK_INTEGRATION // Verified via bank API
}

enum SplitType {
  PERPRODUCT // Pay for specific products
  EQUALPARTS // Split equally among people
  CUSTOMAMOUNT // Custom payment amount
  FULLPAYMENT // Pay the entire bill
}

enum CardBrand {
  VISA
  MASTERCARD
  AMERICAN_EXPRESS
  DISCOVER
  DINERS_CLUB
  JCB
  MAESTRO
  UNIONPAY
  ELO
  HIPERCARD
  OTHER
}

enum CardEntryMode {
  CONTACTLESS // NFC/Tap
  CONTACT // Magnetic stripe
  CHIP // EMV Chip insert
  SWIPE // Magnetic stripe
  MANUAL // Keyed entry
  FALLBACK // Chip fallback to swipe
  ONLINE // E-commerce/online
  OTHER
}

enum PaymentType {
  REGULAR // Normal order-based payment
  FAST // Quick payment without order items
  TEST // Test payments from superadmin dashboard
  REFUND // Future: refund payments
  ADJUSTMENT // Future: manual adjustments
}

enum NotificationType {
  // Order notifications
  NEW_ORDER
  ORDER_UPDATED
  ORDER_READY
  ORDER_CANCELLED

  // Payment notifications
  PAYMENT_RECEIVED
  PAYMENT_FAILED
  REFUND_PROCESSED

  // Review notifications
  NEW_REVIEW
  BAD_REVIEW
  REVIEW_RESPONSE_NEEDED

  // Staff notifications
  SHIFT_REMINDER
  SHIFT_ENDED
  NEW_STAFF_JOINED

  // System notifications
  POS_DISCONNECTED
  POS_RECONNECTED
  LOW_INVENTORY
  SYSTEM_MAINTENANCE
  FEATURE_UPDATED

  // Admin notifications
  VENUE_APPROVAL_NEEDED
  VENUE_SUSPENDED
  HIGH_COMMISSION_ALERT
  REVENUE_MILESTONE

  // Subscription notifications
  SUBSCRIPTION_TRIAL_ENDING
  SUBSCRIPTION_ACTIVATED
  SUBSCRIPTION_CANCELLED
  SUBSCRIPTION_PAYMENT_FAILED

  // KYC notifications (Superadmin)
  NEW_KYC_SUBMISSION // New venue submitted KYC documents
  KYC_APPROVED // KYC was approved by superadmin
  KYC_REJECTED // KYC was rejected by superadmin
  KYC_IN_REVIEW // KYC marked as in review

  // General
  ANNOUNCEMENT
  REMINDER
  ALERT
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum NotificationChannel {
  IN_APP // Dashboard notifications
  EMAIL // Email notifications
  SMS // SMS notifications (future)
  PUSH // Push notifications (future)
  WEBHOOK // Webhook notifications (future)
}

enum DevicePlatform {
  IOS
  ANDROID
  WEB
}

// ============================
// AI TRAINING TABLES
// ============================

model ChatTrainingData {
  id               String   @id @default(cuid())
  venueId          String
  venue            Venue    @relation("VenueChatTraining", fields: [venueId], references: [id], onDelete: Cascade)
  userId           String
  user             Staff    @relation("UserChatTraining", fields: [userId], references: [id], onDelete: Cascade)
  userQuestion     String
  aiResponse       String
  sqlQuery         String?
  sqlResult        Json?
  confidence       Float
  executionTime    Int?
  rowsReturned     Int?
  wasCorrect       Boolean? // User feedback: was this response correct?
  userFeedback     String? // Optional user feedback text
  responseCategory String? // sales, staff, inventory, etc.
  sessionId        String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  feedback ChatFeedback[]

  @@index([venueId])
  @@index([userId])
  @@index([responseCategory])
  @@index([confidence])
  @@index([createdAt])
}

model LearnedPatterns {
  id                 String    @id @default(cuid())
  questionPattern    String // Regex or keywords that match questions
  category           String // sales, staff, inventory, etc.
  optimalSqlTemplate String // Best SQL template for this pattern
  averageConfidence  Float
  successRate        Float // % of correct responses
  totalUsages        Int       @default(0)
  lastUsed           DateTime?
  isActive           Boolean   @default(true)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  @@unique([questionPattern, category])
  @@index([category])
  @@index([successRate])
  @@index([isActive])
}

model ChatFeedback {
  id                String               @id @default(cuid())
  trainingDataId    String               @unique // Only one feedback per training data
  trainingData      ChatTrainingData     @relation(fields: [trainingDataId], references: [id], onDelete: Cascade)
  feedbackType      ChatFeedbackType
  correctedResponse String? // What the response should have been
  correctedSql      String? // What the SQL should have been
  adminNotes        String?
  processingStatus  ChatProcessingStatus @default(PENDING)
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  @@index([processingStatus])
}

model TpvFeedback {
  id                 String          @id @default(cuid())
  feedbackType       TpvFeedbackType
  message            String          @db.Text
  venueSlug          String
  appVersion         String
  buildVersion       String
  androidVersion     String
  deviceModel        String
  deviceManufacturer String
  emailSent          Boolean         @default(false)
  emailSentAt        DateTime?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  @@index([venueSlug])
  @@index([feedbackType])
  @@index([createdAt])
}

enum TpvFeedbackType {
  BUG
  FEATURE
}

enum ChatFeedbackType {
  CORRECT
  INCORRECT
  PARTIALLY_CORRECT
  CLARIFICATION_NEEDED
}

enum ChatProcessingStatus {
  PENDING
  PROCESSED
  APPLIED
}

// ==========================================
// NOTE: CHATBOT TOKEN BUDGET SYSTEM
// Tracks token usage per venue with soft limits,
// overage tracking, and Stripe integration for purchases
// ==========================================

model ChatbotTokenBudget {
  id      String @id @default(cuid())
  venueId String @unique
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // Monthly budget configuration
  monthlyFreeTokens  Int      @default(10000) // Free tokens per month (10K default)
  currentMonthUsed   Int      @default(0) // Tokens used this month
  currentPeriodStart DateTime @default(now()) // Start of current billing period
  currentPeriodEnd   DateTime // End of current billing period

  // Extra tokens (purchased/recharged)
  extraTokensBalance Int @default(0) // Purchased tokens available

  // Overage tracking (soft limit - allows usage beyond free + extra)
  overageTokensUsed   Int     @default(0) // Tokens used beyond free + extra
  overageWarningShown Boolean @default(false) // Has user seen overage warning this period

  // Auto-recharge settings
  autoRechargeEnabled   Boolean @default(false) // Enable automatic token purchase
  autoRechargeThreshold Int     @default(1000) // Recharge when below this many tokens
  autoRechargeAmount    Int     @default(10000) // How many tokens to purchase

  // Stripe integration for token purchases
  stripeTokenProductId String? // Stripe product ID for token packs
  stripePriceId        String? // Default price ID for token packs

  // Lifetime statistics
  totalTokensUsed      BigInt  @default(0) // Total tokens ever consumed
  totalTokensPurchased BigInt  @default(0) // Total tokens ever purchased
  totalAmountSpent     Decimal @default(0) @db.Decimal(12, 2) // Total USD spent on tokens

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  usageRecords TokenUsageRecord[]
  purchases    TokenPurchase[]

  @@index([venueId])
  @@index([currentPeriodEnd])
}

model TokenUsageRecord {
  id       String             @id @default(cuid())
  budgetId String
  budget   ChatbotTokenBudget @relation(fields: [budgetId], references: [id], onDelete: Cascade)

  // User who made the query
  userId String

  // Token consumption details
  promptTokens     Int // Input tokens (question + context)
  completionTokens Int // Output tokens (response)
  totalTokens      Int // Sum of prompt + completion

  // Query context
  queryType      TokenQueryType // Type of query for analytics
  trainingDataId String? // Link to ChatTrainingData for audit trail

  // Cost tracking
  estimatedCost Decimal @db.Decimal(8, 6) // Cost in USD (for analytics)

  createdAt DateTime @default(now())

  @@index([budgetId])
  @@index([createdAt])
  @@index([userId])
  @@index([queryType])
}

model TokenPurchase {
  id       String             @id @default(cuid())
  budgetId String
  budget   ChatbotTokenBudget @relation(fields: [budgetId], references: [id], onDelete: Cascade)

  // Purchase details
  tokenAmount Int // Number of tokens purchased
  amountPaid  Decimal @db.Decimal(10, 2) // Amount paid in venue currency

  // Stripe tracking
  stripePaymentIntentId String? @unique // Stripe payment intent ID
  stripeInvoiceId       String? // Stripe invoice ID (for invoice-based purchases)
  stripeReceiptUrl      String? // Stripe hosted invoice URL for viewing receipt
  stripeInvoicePdfUrl   String? // Stripe invoice PDF URL for downloading

  // Purchase metadata
  purchaseType TokenPurchaseType // Manual, auto-recharge, or promotional
  triggeredBy  String? // User ID who triggered (null for auto-recharge)
  status       TokenPurchaseStatus @default(PENDING)

  createdAt   DateTime  @default(now())
  completedAt DateTime? // When payment was confirmed

  @@index([budgetId])
  @@index([status])
  @@index([stripePaymentIntentId])
  @@index([createdAt])
}

enum TokenQueryType {
  SIMPLE_QUERY // SharedQueryService - 0 tokens (routed without LLM)
  COMPLEX_SINGLE // Single SQL generation ~3,800 tokens
  COMPLEX_CONSENSUS // 3x SQL generation ~9,100 tokens (consensus voting)
  RESULT_INTERPRETATION // Interpreting SQL results ~1,100 tokens
  INTENT_CLASSIFICATION // Intent detection ~700 tokens
  CONVERSATION // General conversation ~300 tokens
}

enum TokenPurchaseType {
  MANUAL // User-initiated purchase from dashboard
  AUTO_RECHARGE // Automatic recharge when threshold reached
  PROMOTIONAL // Free promotional tokens (marketing, support, etc.)
}

enum TokenPurchaseStatus {
  PENDING // Payment initiated but not confirmed
  COMPLETED // Payment successful, tokens added
  FAILED // Payment failed
  REFUNDED // Payment refunded
}

// ==========================================
// TPV REMOTE COMMAND SYSTEM
// Enterprise-grade device management for terminals
// Inspired by Stripe Terminal Fleet Management & MDM patterns
// ==========================================

enum TpvCommandType {
  // Device State Commands
  LOCK // Lock terminal, show custom message
  UNLOCK // Unlock terminal
  MAINTENANCE_MODE // Enter maintenance mode
  EXIT_MAINTENANCE // Exit maintenance mode
  REACTIVATE // Reactivate retired terminal
  REMOTE_ACTIVATE // Remote activation by SUPERADMIN (pre-registered terminal)

  // App Lifecycle Commands
  RESTART // Graceful app restart
  SHUTDOWN // Complete shutdown
  CLEAR_CACHE // Clear specified caches
  FORCE_UPDATE // Force app update (silent, no user prompt)
  REQUEST_UPDATE // Request update (shows dialog, user can accept/dismiss)
  INSTALL_VERSION // Install specific version (SUPERADMIN rollback/upgrade)

  // Data Management Commands
  SYNC_DATA // Force data synchronization
  FACTORY_RESET // Complete data wipe (CRITICAL)
  EXPORT_LOGS // Export device logs

  // Configuration Commands
  UPDATE_CONFIG // Push new configuration
  REFRESH_MENU // Force menu refresh
  UPDATE_MERCHANT // Change active merchant

  // Automation Commands
  SCHEDULE // Schedule future command
  GEOFENCE_TRIGGER // Geo-based automation
  TIME_RULE // Time-based automation
}

enum TpvCommandPriority {
  LOW
  NORMAL
  HIGH
  CRITICAL
}

enum TpvCommandStatus {
  PENDING // Waiting to be sent
  QUEUED // In queue for offline terminal
  SENT // Sent, waiting for ACK
  RECEIVED // Terminal acknowledged receipt
  EXECUTING // Terminal is executing
  COMPLETED // Successfully completed
  FAILED // Failed after retries
  EXPIRED // Expired before execution
  CANCELLED // Cancelled by user
}

enum TpvCommandResultStatus {
  SUCCESS
  PARTIAL_SUCCESS
  FAILED
  TIMEOUT
  REJECTED
}

enum TpvCommandHistoryStatus {
  SENT
  ACK_RECEIVED
  EXECUTION_STARTED
  COMPLETED
  FAILED
  TIMEOUT
  REJECTED
  CANCELLED
}

enum TpvCommandSource {
  DASHBOARD // Manual from web dashboard
  API // External API call
  SCHEDULED // From scheduled command
  GEOFENCE // Triggered by geofence
  SYSTEM // System-triggered (auto maintenance, etc.)
}

enum BulkTargetType {
  ALL_VENUE // All terminals in venue
  TERMINAL_GROUP // Custom group of terminals
  TERMINAL_LIST // Specific list of terminal IDs
}

enum BulkErrorAction {
  CONTINUE // Continue with next terminal on error
  STOP // Stop bulk operation on first error
  ROLLBACK // Attempt to rollback completed commands
}

enum BulkOperationStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  PARTIAL_FAILURE
  FAILED
  CANCELLED
}

enum ScheduleType {
  ONCE // Execute once at specific time
  DAILY // Execute daily at specific time
  WEEKLY // Execute weekly on specific day
  MONTHLY // Execute monthly on specific date
  CRON // Custom cron expression
}

// ==========================================
// TPV Command Queue (Offline Support)
// Stores pending commands for terminals
// ==========================================

model TpvCommandQueue {
  id         String   @id @default(cuid())
  terminalId String
  terminal   Terminal @relation(fields: [terminalId], references: [id], onDelete: Cascade)
  venueId    String
  venue      Venue    @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // Command Details
  commandType TpvCommandType
  payload     Json?
  priority    TpvCommandPriority @default(NORMAL)

  // Status Tracking
  status        TpvCommandStatus @default(PENDING)
  attempts      Int              @default(0)
  maxAttempts   Int              @default(3)
  lastAttemptAt DateTime?
  nextAttemptAt DateTime? // For retry scheduling

  // Scheduling
  scheduledFor DateTime? // Execute at specific time
  expiresAt    DateTime? // Command expires if not executed

  // Execution Result
  executedAt    DateTime?
  resultStatus  TpvCommandResultStatus?
  resultMessage String?
  resultPayload Json?
  duration      Int? // Execution duration in milliseconds

  // Audit
  requestedBy     String // StaffId who initiated
  requestedByName String? // Staff name at time of request
  correlationId   String  @unique @default(cuid())

  // Confirmation Requirements
  requiresPin   Boolean   @default(false)
  pinVerifiedAt DateTime?
  pinVerifiedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  history         TpvCommandHistory[]
  bulkOperation   BulkCommandOperation? @relation(fields: [bulkOperationId], references: [id])
  bulkOperationId String?

  @@index([terminalId, status])
  @@index([venueId, status])
  @@index([status, scheduledFor])
  @@index([correlationId])
  @@index([bulkOperationId])
}

// ==========================================
// TPV Command History (Audit Trail)
// Immutable log of all command executions
// ==========================================

model TpvCommandHistory {
  id             String           @id @default(cuid())
  commandQueueId String?
  commandQueue   TpvCommandQueue? @relation(fields: [commandQueueId], references: [id], onDelete: SetNull)

  // Terminal Info (denormalized for historical accuracy)
  terminalId     String
  terminalSerial String
  terminalName   String
  venueId        String
  venueName      String

  // Command Details
  commandType TpvCommandType
  payload     Json?

  // Execution Details
  status        TpvCommandHistoryStatus
  executedAt    DateTime?
  duration      Int? // Milliseconds
  resultMessage String?
  resultPayload Json?
  errorCode     String?

  // Source Info
  source    TpvCommandSource @default(DASHBOARD)
  ipAddress String?
  userAgent String?

  // Audit
  requestedBy     String
  requestedByName String
  requestedByRole String
  correlationId   String

  createdAt DateTime @default(now())

  @@index([terminalId, createdAt])
  @@index([venueId, createdAt])
  @@index([commandType, createdAt])
  @@index([requestedBy])
  @@index([correlationId])
}

// ==========================================
// Bulk Command Operations
// Manage commands sent to multiple terminals
// ==========================================

model BulkCommandOperation {
  id      String @id @default(cuid())
  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // Target
  targetType   BulkTargetType
  targetIds    String[] // Terminal IDs or group IDs
  totalTargets Int

  // Command
  commandType TpvCommandType
  payload     Json?

  // Execution Settings
  sequential    Boolean         @default(false)
  onErrorAction BulkErrorAction @default(CONTINUE)

  // Progress
  status       BulkOperationStatus @default(PENDING)
  successCount Int                 @default(0)
  failureCount Int                 @default(0)
  pendingCount Int                 @default(0)

  // Audit
  requestedBy     String
  requestedByName String?
  startedAt       DateTime?
  completedAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  commands TpvCommandQueue[]

  @@index([venueId, status])
  @@index([status, createdAt])
}

// ==========================================
// Scheduled Commands (Recurring)
// Time-based command automation
// ==========================================

model ScheduledCommand {
  id         String    @id @default(cuid())
  venueId    String
  venue      Venue     @relation(fields: [venueId], references: [id], onDelete: Cascade)
  terminalId String? // Null = all terminals in venue
  terminal   Terminal? @relation(fields: [terminalId], references: [id], onDelete: Cascade)

  // Command
  name        String // User-friendly name
  description String?
  commandType TpvCommandType
  payload     Json?

  // Schedule
  scheduleType   ScheduleType
  cronExpression String? // For CRON type
  timezone       String       @default("America/Mexico_City")
  nextExecution  DateTime
  lastExecution  DateTime?

  // Lifecycle
  enabled        Boolean   @default(true)
  expiresAt      DateTime? // Optional end date
  executionCount Int       @default(0)
  maxExecutions  Int? // Optional limit

  // Audit
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([venueId, enabled, nextExecution])
  @@index([nextExecution])
}

// ==========================================
// Geofencing Rules
// Location-based command triggers
// ==========================================

model GeofenceRule {
  id         String    @id @default(cuid())
  venueId    String
  venue      Venue     @relation(fields: [venueId], references: [id], onDelete: Cascade)
  terminalId String? // Null = all terminals
  terminal   Terminal? @relation(fields: [terminalId], references: [id], onDelete: Cascade)

  // Rule Info
  name        String
  description String?

  // Geofence Definition
  centerLat    Float
  centerLng    Float
  radiusMeters Int

  // Trigger Actions
  onEnter        TpvCommandType?
  onEnterPayload Json?
  onExit         TpvCommandType?
  onExitPayload  Json?

  // State
  enabled       Boolean   @default(true)
  lastTriggered DateTime?
  triggerCount  Int       @default(0)

  // Audit
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([venueId, enabled])
}

enum TimeEntryStatus {
  CLOCKED_IN // Currently working
  ON_BREAK // Currently on break
  CLOCKED_OUT // Finished shift
  ADMIN_EDITED // Modified by admin
}

enum TimeEntryValidation {
  PENDING // Awaiting manager review
  APPROVED // Manager approved the entry
  REJECTED // Manager rejected the entry (see validationNote)
}

// ==========================================
// NOTE: INVENTORY MANAGEMENT ENUMS
// ==========================================

enum RawMaterialCategory {
  MEAT
  POULTRY
  SEAFOOD
  DAIRY
  CHEESE
  EGGS
  VEGETABLES
  FRUITS
  GRAINS
  BREAD
  PASTA
  RICE
  BEANS
  SPICES
  HERBS
  OILS
  SAUCES
  CONDIMENTS
  BEVERAGES
  ALCOHOL
  CLEANING
  PACKAGING
  OTHER
}

enum PurchaseOrderStatus {
  DRAFT // Being created
  PENDING_APPROVAL // Awaiting manager/admin approval
  REJECTED // Approval rejected
  APPROVED // Approved, ready to send
  SENT // Sent to supplier
  CONFIRMED // Supplier confirmed
  SHIPPED // In transit
  PARTIAL // Partially received
  RECEIVED // Fully received
  CANCELLED // Cancelled
}

enum ShippingAddressType {
  VENUE // Deliver to venue address
  CUSTOM // Custom delivery address
}

enum PurchaseOrderItemStatus {
  PENDING // Not yet received
  RECEIVED // Successfully received
  DAMAGED // Received but damaged
  NOT_PROCESSED // Not received and won't be processed
}

enum PricingStrategy {
  MANUAL // User sets price manually
  AUTO_MARKUP // Auto-calculate based on cost + markup %
  AUTO_TARGET_MARGIN // Auto-calculate based on target food cost %
}

enum UnitCategory {
  WEIGHT // kg, g, lb, oz
  VOLUME // L, ml, gal, oz
  COUNT // units, pieces, dozen
}

enum RawMaterialMovementType {
  PURCHASE // Received from supplier
  USAGE // Used in production (recipe)
  ADJUSTMENT // Manual stock adjustment
  SPOILAGE // Wasted/expired/damaged
  TRANSFER // Moved to another venue
  COUNT // Physical inventory count correction
  RETURN // Returned to supplier
}

enum AlertType {
  LOW_STOCK // Below minimum stock
  OUT_OF_STOCK // Stock is zero
  EXPIRING_SOON // Approaching expiration date
  OVER_STOCK // Above maximum stock
}

enum AlertStatus {
  ACTIVE // Alert is active
  ACKNOWLEDGED // Staff has seen it
  RESOLVED // Issue fixed
  DISMISSED // Manually dismissed
}

enum BatchStatus {
  ACTIVE // Has remaining quantity available
  DEPLETED // Fully consumed (remainingQuantity = 0)
  EXPIRED // Past expiration date
  QUARANTINED // Quality issue, should not be used
}

enum CostingMethod {
  FIFO // First-In-First-Out: Uses oldest batch costs
  WEIGHTED_AVERAGE // Weighted average of all batch costs
  STANDARD_COST // Fixed standard cost regardless of actual costs
}

// ‚úÖ WORLD-CLASS: Inventory tracking method (Toast/Square/Shopify pattern)
enum InventoryMethod {
  QUANTITY // Direct unit counting (retail, bar items)
  RECIPE // Ingredient-based tracking (restaurant items)
}

// ‚úÖ WORLD-CLASS: Modifier inventory mode (Toast/Square pattern)
// Determines how a modifier affects inventory when selected
enum ModifierInventoryMode {
  ADDITION // Adds extra ingredient (e.g., "Extra Bacon" adds 30g bacon)
  SUBSTITUTION // Replaces recipe ingredient (e.g., "Almond Milk" replaces "Whole Milk")
}

// ==========================================
// NOTE: UNIT MEASUREMENT SYSTEM
// ==========================================

enum UnitType {
  WEIGHT
  VOLUME
  COUNT
  LENGTH
  TEMPERATURE
  TIME
}

enum Unit {
  // Weight units
  GRAM
  KILOGRAM
  MILLIGRAM
  POUND
  OUNCE
  TON

  // Volume units - Liquid
  MILLILITER
  LITER
  GALLON
  QUART
  PINT
  CUP
  FLUID_OUNCE
  TABLESPOON
  TEASPOON

  // Count units
  UNIT
  PIECE
  DOZEN
  CASE
  BOX
  BAG
  BOTTLE
  CAN
  JAR

  // Length units (for items like pasta, rope, etc.)
  METER
  CENTIMETER
  MILLIMETER
  INCH
  FOOT

  // Temperature (for cooking)
  CELSIUS
  FAHRENHEIT

  // Time (for recipes)
  MINUTE
  HOUR
  DAY
}

// ==========================================
// NOTE: ONBOARDING ENUMS
// ==========================================

enum OnboardingType {
  DEMO // Demo venue with pre-populated data
  REAL // Real business venue
}

enum PremiumFeature {
  INVENTORY // FIFO inventory management ($180-280 MXN/month)
  ADVANCED_REPORTS // Advanced analytics and reporting ($180-280 MXN/month)
  AI_ASSISTANT // AI chatbot and insights ($180-280 MXN/month)
  ONLINE_ORDERING // QR ordering, web ordering, delivery apps ($180-280 MXN/month)
}

// ==========================================
// NOTE: CASH CLOSEOUT (CORTES DE CAJA)
// ==========================================

// ‚úÖ Cash Closeout - Records when venue closes out cash and deposits/stores it
// Industry standard for restaurants, retail, hotels - track expected vs actual cash
model CashCloseout {
  id      String @id @default(cuid())
  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // Period tracking
  periodStart DateTime // Start of this cash period (last closeout or venue creation)
  periodEnd   DateTime @default(now()) // When closeout was made

  // Expected vs Actual
  expectedAmount  Decimal  @db.Decimal(12, 2) // Sum of CASH payments in period
  actualAmount    Decimal  @db.Decimal(12, 2) // User input (counted)
  variance        Decimal  @db.Decimal(12, 2) // actual - expected (positive = overage, negative = shortage)
  variancePercent Decimal? @db.Decimal(5, 2) // For display and variance warnings

  // Deposit details
  depositMethod DepositMethod @default(BANK_DEPOSIT)
  bankReference String? // Optional: bank receipt number or reference
  notes         String?       @db.Text

  // Staff tracking
  closedById String
  closedBy   Staff  @relation("CashCloseoutClosedBy", fields: [closedById], references: [id])

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([venueId])
  @@index([venueId, createdAt])
}

// Deposit method for cash closeouts
enum DepositMethod {
  BANK_DEPOSIT // Cash deposited to bank account
  SAFE // Cash stored in venue safe
  OWNER_WITHDRAWAL // Owner took the cash
  NEXT_SHIFT // Left as starting bank for next shift
}

// ==========================================
// NOTE: CREDIT ASSESSMENT (SOFOM Integration)
// ==========================================
// Based on Square Capital / Stripe Capital model
// Used by SOFOM to evaluate venues for merchant cash advances

/// Credit assessment for a venue - calculated metrics and score
/// Updated periodically (daily or on-demand) to reflect latest payment data
model VenueCreditAssessment {
  id      String @id @default(cuid())
  venueId String @unique
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // ===== OVERALL SCORE (0-100) =====
  creditScore       Int               @default(0) // 0-100 score
  creditGrade       CreditGrade       @default(D) // A, B, C, D grade
  eligibilityStatus CreditEligibility @default(INELIGIBLE)

  // ===== VOLUME METRICS (30% of score) =====
  // Annual and monthly transaction volumes
  annualVolume        Decimal @default(0) @db.Decimal(14, 2) // Total volume last 12 months
  monthlyAverage      Decimal @default(0) @db.Decimal(12, 2) // Average monthly volume
  currentMonthVolume  Decimal @default(0) @db.Decimal(12, 2) // Current month volume
  transactionCount12m Int     @default(0) // Transaction count last 12 months

  // ===== GROWTH METRICS (20% of score) =====
  yoyGrowthPercent Decimal        @default(0) @db.Decimal(6, 2) // Year-over-year growth %
  momGrowthPercent Decimal        @default(0) @db.Decimal(6, 2) // Month-over-month growth %
  trendDirection   TrendDirection @default(FLAT) // GROWING, FLAT, DECLINING

  // ===== STABILITY METRICS (25% of score) =====
  revenueVariance    Decimal @default(0) @db.Decimal(6, 4) // Standard deviation / mean (lower = more stable)
  consistencyScore   Decimal @default(0) @db.Decimal(5, 2) // 0-100 consistency rating
  daysSinceLastTx    Int     @default(0) // Days since last transaction
  operatingDaysRatio Decimal @default(0) @db.Decimal(4, 2) // Active days / total days (0-1)
  averageTicket      Decimal @default(0) @db.Decimal(10, 2) // Average transaction amount

  // ===== RISK METRICS (25% of score) =====
  chargebackRate   Decimal @default(0) @db.Decimal(6, 4) // Chargebacks / total transactions
  refundRate       Decimal @default(0) @db.Decimal(6, 4) // Refunds / total transactions
  chargebackCount  Int     @default(0) // Total chargebacks last 12m
  paymentMethodMix Json? // % breakdown by method (diversification indicator)

  // ===== CREDIT RECOMMENDATION =====
  recommendedCreditLimit Decimal @default(0) @db.Decimal(12, 2) // Suggested max loan amount
  suggestedFactorRate    Decimal @default(1.15) @db.Decimal(4, 2) // Factor rate (1.10 - 1.20)
  maxRepaymentPercent    Decimal @default(0.15) @db.Decimal(4, 2) // Max % of daily sales for repayment

  // ===== ALERTS & FLAGS =====
  alerts String[] // Array of alert codes: "HIGH_CHARGEBACK", "DECLINING_REVENUE", etc.
  flags  Json? // Additional structured flags

  // ===== TIMESTAMPS =====
  calculatedAt DateTime @default(now()) // When score was last calculated
  dataAsOf     DateTime @default(now()) // Latest payment data included

  // ===== HISTORY =====
  history CreditAssessmentHistory[]
  offers  CreditOffer[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([creditScore])
  @@index([eligibilityStatus])
  @@index([creditGrade])
}

/// Historical snapshots of credit assessments for trend analysis
model CreditAssessmentHistory {
  id           String                @id @default(cuid())
  assessmentId String
  assessment   VenueCreditAssessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  // Snapshot data
  creditScore   Int
  creditGrade   CreditGrade
  annualVolume  Decimal     @db.Decimal(14, 2)
  monthlyVolume Decimal     @db.Decimal(12, 2)
  growthPercent Decimal     @db.Decimal(6, 2)

  snapshotDate DateTime @default(now())

  @@index([assessmentId])
  @@index([snapshotDate])
}

/// Credit offers extended to venues (for SOFOM integration)
model CreditOffer {
  id           String                @id @default(cuid())
  assessmentId String
  assessment   VenueCreditAssessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  venueId      String
  venue        Venue                 @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // Offer details
  offerAmount       Decimal @db.Decimal(12, 2) // Principal amount offered
  factorRate        Decimal @db.Decimal(4, 2) // e.g., 1.12 = 12% fee
  totalRepayment    Decimal @db.Decimal(12, 2) // offerAmount * factorRate
  repaymentPercent  Decimal @db.Decimal(4, 2) // % of daily sales for repayment
  estimatedTermDays Int // Estimated repayment period in days

  // Offer status
  status    CreditOfferStatus @default(PENDING)
  expiresAt DateTime // Offer expiration date

  // If accepted
  acceptedAt   DateTime?
  acceptedById String?
  acceptedBy   Staff?    @relation(fields: [acceptedById], references: [id])

  // If rejected
  rejectedAt      DateTime?
  rejectionReason String?

  // Audit trail
  createdById String?
  createdBy   Staff?  @relation("CreditOfferCreatedBy", fields: [createdById], references: [id])
  notes       String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([venueId])
  @@index([assessmentId])
  @@index([status])
}

// ==========================================
// MODULE SYSTEM - Multi-tenant feature management
// Enables/disables functionality per venue without hardcoded conditionals
// ==========================================

/// Module definitions available in the system.
/// Modules are GENERIC - they work for any industry.
/// Customization comes from configuration, not code.
model Module {
  id          String  @id @default(cuid())
  code        String  @unique // 'SERIALIZED_INVENTORY', 'ATTENDANCE_TRACKING', etc.
  name        String // "Inventario Serializado"
  description String?

  // Schema JSON for validating configuration
  configSchema Json? // JSON Schema

  // Default configuration (labels, behavior)
  defaultConfig Json // { labels: { item: "Item", barcode: "Barcode" }, ... }

  // Presets by industry (for quick setup)
  presets Json? // { telecom: { labels: { item: "SIM" } }, jewelry: { labels: { item: "Piedra" } } }

  // State
  active Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  venueModules        VenueModule[]
  organizationModules OrganizationModule[]
}

/// Enables a module for a specific venue.
/// DIFFERENT from VenueFeature which is for billing/Stripe.
model VenueModule {
  id       String @id @default(cuid())
  venueId  String
  venue    Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)
  moduleId String
  module   Module @relation(fields: [moduleId], references: [id])

  // State
  enabled Boolean @default(true)

  // Custom configuration (merged with Module.defaultConfig)
  // Example: { labels: { item: "SIM", barcode: "ICCID" } }
  config Json?

  // Audit
  enabledBy String // Staff ID that enabled the module
  enabledAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([venueId, moduleId])
  @@index([venueId])
}

/// Enables a module for ALL venues in an organization.
/// Provides inheritance: if enabled at org level, all venues get the module.
/// Venues can override with their own VenueModule.config if needed.
model OrganizationModule {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  moduleId       String
  module         Module       @relation(fields: [moduleId], references: [id])

  // State
  enabled Boolean @default(true)

  // Default configuration for all venues in the org
  // Individual venues can override via VenueModule.config
  config Json?

  // Audit
  enabledBy String // Staff ID that enabled the module
  enabledAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, moduleId])
  @@index([organizationId])
}

/// Categories for SerializedItems (NOT to be confused with MenuCategory).
/// Represents sales channels, types, or classifications.
/// Can be venue-scoped (venueId set) or org-scoped (organizationId set, venueId null).
model ItemCategory {
  id      String @id @default(cuid())
  venueId String? // Nullable: null = org-level category
  venue   Venue?  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // Organization scope (for org-level categories shared across all venues)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name        String // "Negra", "Blanca", "Roja" or "Diamante", "Rub√≠"
  description String?
  color       String? // For UI
  sortOrder   Int     @default(0)

  // Does it require pre-registration of stock?
  requiresPreRegistration Boolean @default(true)

  // Suggested price (optional, cashier can change it)
  suggestedPrice Decimal? @db.Decimal(10, 2)

  // Regex to auto-categorize barcodes (optional)
  barcodePattern String?

  active Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  serializedItems   SerializedItem[]
  stockAlertConfigs StockAlertConfig[]

  @@unique([venueId, name])            // Venue-level uniqueness (NULL venueId won't conflict)
  @@unique([organizationId, name])     // Org-level uniqueness
  @@index([venueId])
  @@index([organizationId])
}

/// Product with UNIQUE barcode.
/// DOES NOT HAVE PRICE - price is defined at the moment of sale.
/// Applies to: SIMs, jewelry, electronics, etc.
/// Can be venue-scoped (venueId set) or org-scoped (organizationId set, venueId null).
model SerializedItem {
  id      String @id @default(cuid())
  venueId String? // Nullable: null = org-level item
  venue   Venue?  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // Organization scope (for org-level items shared across all venues)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Venue that sold this item (for org-level items sold at a specific venue)
  sellingVenueId String?
  sellingVenue   Venue? @relation("SoldItems", fields: [sellingVenueId], references: [id])

  // Category
  categoryId String
  category   ItemCategory @relation(fields: [categoryId], references: [id])

  // Unique identification
  serialNumber String // Barcode, ICCID, certificate, etc.

  // Status
  status SerializedItemStatus @default(AVAILABLE)

  // Sale tracking (when status=SOLD)
  soldAt      DateTime?
  orderItemId String?    @unique
  orderItem   OrderItem? @relation(fields: [orderItemId], references: [id], onDelete: SetNull)

  // Audit
  createdAt DateTime @default(now())
  createdBy String // Staff ID that registered the item

  @@unique([venueId, serialNumber])            // Legacy venue-level uniqueness
  @@unique([organizationId, serialNumber])     // Org-level uniqueness
  @@index([venueId, categoryId])
  @@index([venueId, status])
  @@index([organizationId, categoryId])
  @@index([organizationId, status])
  @@index([serialNumber])
}

// ===== CREDIT ASSESSMENT ENUMS =====

enum CreditGrade {
  A // Excellent (80-100) - Auto-approve
  B // Good (70-79) - Standard terms
  C // Fair (50-69) - Manual review required
  D // Poor (<50) - Ineligible or special terms
}

enum CreditEligibility {
  ELIGIBLE // Ready for offer
  REVIEW_REQUIRED // Needs manual review
  INELIGIBLE // Does not meet criteria
  OFFER_PENDING // Has active offer waiting response
  ACTIVE_LOAN // Currently has active loan
}

enum TrendDirection {
  GROWING // Positive growth trend
  FLAT // Stable, no significant change
  DECLINING // Negative growth trend
}

enum CreditOfferStatus {
  PENDING // Offer created, waiting for venue response
  ACCEPTED // Venue accepted the offer
  REJECTED // Venue rejected the offer
  EXPIRED // Offer expired without response
  WITHDRAWN // SOFOM withdrew the offer
}

// ==========================================
// SERIALIZED INVENTORY - Status for items with unique barcodes
// Used by Module System for venues with serialized inventory
// ==========================================
enum SerializedItemStatus {
  AVAILABLE // Disponible para venta
  SOLD // Ya vendido
  RETURNED // Devuelto
  DAMAGED // Da√±ado o perdido
}

// ==========================================
// COMMISSION SYSTEM ENUMS
// Staff bonus/commission system for sales-based rewards
// ==========================================

/// Who receives the commission for an order/payment
enum CommissionRecipient {
  CREATOR // Order.createdById - who created the order
  SERVER // Order.servedById - who served the table
  PROCESSOR // Payment.processedById - who processed payment
}

/// When to calculate commission
enum CommissionTrigger {
  PER_PAYMENT // Calculate commission for each Payment
  PER_ORDER // Calculate commission once per completed Order
}

/// How to calculate the commission amount
enum CommissionCalcType {
  PERCENTAGE // Rate applied to sale amount
  FIXED // Fixed amount per order/payment
  TIERED // Rate changes based on volume tiers
  MILESTONE // Bonus for reaching goals
  MANUAL // Manually assigned commission
}

/// What metric is used for tier progression
enum TierType {
  BY_QUANTITY // Number of orders/payments
  BY_AMOUNT // Total sales amount in currency
}

/// Period for tier calculations and resets
enum TierPeriod {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

/// What metric is used for milestone targets
enum MilestoneTargetType {
  ORDER_QUANTITY // Number of orders
  SALES_AMOUNT // Total sales amount
  PRODUCT_QUANTITY // Units of specific product sold
  CATEGORY_QUANTITY // Units from specific category sold
  CATEGORY_AMOUNT // Sales from specific category
}

/// How to calculate milestone bonus
enum BonusType {
  FIXED_AMOUNT // Fixed bonus when milestone reached
  PERCENTAGE_OF_SALES // % of sales during milestone period
  PERCENTAGE_OF_TARGET // % of target amount as bonus
}

/// Status of individual commission calculation records
enum CommissionCalcStatus {
  CALCULATED // Initial calculation done
  AGGREGATED // Rolled into a CommissionSummary
  VOIDED // Cancelled (e.g., due to refund)
}

/// Status of aggregated commission summaries
enum CommissionSummaryStatus {
  DRAFT // Being calculated
  CALCULATED // Calculation complete
  PENDING_APPROVAL // Awaiting OWNER/ADMIN approval
  APPROVED // Approved, ready for payment
  DISPUTED // Under dispute
  PAID // Paid out to staff
}

/// Status of commission payout records
enum CommissionPayoutStatus {
  PENDING // Payout created
  APPROVED // Approved for payment
  PROCESSING // Payment in progress
  PAID // Successfully paid
  FAILED // Payment failed
  CANCELLED // Cancelled before payment
}

/// Reason for clawback (post-payout refund handling)
enum ClawbackReason {
  REFUND // Original payment was refunded
  CHARGEBACK // Payment was charged back
  CORRECTION // Manual correction by admin
  FRAUD // Fraudulent transaction detected
}

// ==========================================
// COMMISSION SYSTEM MODELS
// ==========================================

/// Main configuration for commission rates at venue level
/// Uses effectiveFrom/effectiveTo pattern for time-bound configs
model CommissionConfig {
  id      String  @id @default(cuid())
  venueId String? // Nullable: null = org-level config, set = venue-level config
  venue   Venue?  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // Organization reference (required for org-level configs, optional for venue-level)
  orgId String?
  org   Organization? @relation(fields: [orgId], references: [id], onDelete: SetNull)

  // Configuration
  name        String // "Comisiones Meseros Q1 2025"
  description String?
  priority    Int     @default(0) // Higher = takes precedence when multiple active

  // Commission rules
  recipient   CommissionRecipient @default(SERVER)
  trigger     CommissionTrigger   @default(PER_PAYMENT)
  calcType    CommissionCalcType  @default(PERCENTAGE)
  defaultRate Decimal             @db.Decimal(5, 4) // 0.0300 = 3%
  minAmount   Decimal?            @db.Decimal(10, 2) // Min commission per transaction
  maxAmount   Decimal?            @db.Decimal(10, 2) // Max commission per transaction

  // Base calculation settings
  includeTips     Boolean @default(false) // Tips are already direct bonus, exclude by default
  includeDiscount Boolean @default(false) // Calculate on pre/post-discount amount
  includeTax      Boolean @default(false) // Include tax in calculation base

  // Role-based rates (JSON object: { "WAITER": 0.03, "CASHIER": 0.02 })
  roleRates Json?

  // Time bounds
  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?

  // Aggregation period for commission summaries (how often to group commissions)
  // This determines payroll alignment: WEEKLY, BIWEEKLY, MONTHLY, etc.
  aggregationPeriod TierPeriod @default(MONTHLY)

  // Status & Audit
  active    Boolean   @default(true)
  deletedAt DateTime?
  deletedBy String?

  createdById String
  createdBy   Staff  @relation("CommissionConfigCreatedBy", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  overrides    CommissionOverride[]
  tiers        CommissionTier[]
  milestones   CommissionMilestone[]
  calculations CommissionCalculation[]

  @@index([venueId, active])
  @@index([venueId, effectiveFrom, effectiveTo])
  @@index([orgId])
}

/// Override commission rates for specific staff members
/// Takes priority over config's defaultRate
model CommissionOverride {
  id       String           @id @default(cuid())
  configId String
  config   CommissionConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  venueId  String
  venue    Venue            @relation(fields: [venueId], references: [id], onDelete: Cascade)
  staffId  String
  staff    Staff            @relation("CommissionOverrideStaff", fields: [staffId], references: [id])

  // Override rate
  customRate Decimal @db.Decimal(5, 4) // 0.0500 = 5%
  reason     String? // "Top performer bonus"
  notes      String? // Additional notes

  // Time bounds
  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?

  // Status
  active                 Boolean @default(true)
  excludeFromCommissions Boolean @default(false) // Completely exclude this staff from commissions

  // Audit
  createdById String
  createdBy   Staff  @relation("CommissionOverrideCreatedBy", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([configId])
  @@index([staffId, effectiveFrom, effectiveTo])
  @@index([venueId])
  @@index([active])
}

/// Tiered commission rates (higher tiers = higher rates)
/// Resets based on tierPeriod
model CommissionTier {
  id       String           @id @default(cuid())
  configId String
  config   CommissionConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  // Tier definition
  tierLevel  Int // 1, 2, 3... (ordered)
  tierName   String // "Bronce", "Plata", "Oro"
  tierType   TierType // BY_QUANTITY or BY_AMOUNT
  tierPeriod TierPeriod // When tier resets

  // Thresholds
  minThreshold Decimal  @db.Decimal(12, 2) // Min orders/amount to reach this tier
  maxThreshold Decimal? @db.Decimal(12, 2) // Max before next tier (null = unlimited)

  // Rate at this tier
  rate Decimal @db.Decimal(5, 4) // Commission rate for this tier

  // Status
  active Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([configId, tierLevel])
  @@index([configId])
  @@index([active])
}

/// Milestone/goal-based bonuses
/// One-time or recurring bonuses when targets are met
model CommissionMilestone {
  id       String           @id @default(cuid())
  configId String
  config   CommissionConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  // Milestone definition
  name        String // "Meta Mensual Enero"
  description String?
  targetType  MilestoneTargetType
  targetValue Decimal             @db.Decimal(12, 2) // Target to achieve

  // Product/category filter (for PRODUCT_* and CATEGORY_* types)
  productId  String?
  product    Product?      @relation(fields: [productId], references: [id])
  categoryId String?
  category   MenuCategory? @relation(fields: [categoryId], references: [id])

  // Bonus when achieved
  bonusType  BonusType
  bonusValue Decimal   @db.Decimal(10, 2) // Amount or percentage based on bonusType

  // Period
  period      TierPeriod // DAILY, WEEKLY, MONTHLY, etc.
  periodStart DateTime
  periodEnd   DateTime
  isRecurring Boolean    @default(false)

  // Time bounds for milestone validity
  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?

  // Status
  active Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  achievements MilestoneAchievement[]

  @@index([configId])
  @@index([periodStart, periodEnd])
}

/// Tracks staff progress and achievement of milestones
model MilestoneAchievement {
  id          String              @id @default(cuid())
  milestoneId String
  milestone   CommissionMilestone @relation(fields: [milestoneId], references: [id], onDelete: Cascade)
  staffId     String
  staff       Staff               @relation(fields: [staffId], references: [id])
  venueId     String
  venue       Venue               @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // Period for this achievement (allows same milestone to be tracked across periods)
  periodStart DateTime
  periodEnd   DateTime

  // Progress tracking
  currentValue  Decimal   @db.Decimal(12, 2) // Current progress
  achievedValue Decimal?  @db.Decimal(12, 2) // Value when achieved (snapshot)
  achieved      Boolean   @default(false)
  achievedAt    DateTime?

  // Bonus details (when achieved)
  bonusAmount Decimal?  @db.Decimal(10, 2)
  bonusPaidAt DateTime?
  bonusPaidIn String? // CommissionSummary ID (legacy)

  // Summary inclusion
  includedInSummaryId String? // CommissionSummary where this bonus was aggregated

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([milestoneId, staffId, periodStart])
  @@index([staffId])
  @@index([venueId])
  @@index([includedInSummaryId])
  @@index([periodStart, periodEnd])
}

/// Individual commission calculation per payment/order
/// IMMUTABLE after creation (following TransactionCost pattern)
model CommissionCalculation {
  id      String @id @default(cuid())
  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)
  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id])

  // Source
  paymentId String?
  payment   Payment? @relation(fields: [paymentId], references: [id])
  orderId   String?
  order     Order?   @relation(fields: [orderId], references: [id])
  shiftId   String?
  shift     Shift?   @relation(fields: [shiftId], references: [id])

  // Config reference
  configId String
  config   CommissionConfig @relation(fields: [configId], references: [id])

  // Calculation snapshot (IMMUTABLE - captured at calculation time)
  baseAmount     Decimal @db.Decimal(12, 2) // Amount used for calculation
  tipAmount      Decimal @default(0) @db.Decimal(10, 2) // Tips (if included)
  discountAmount Decimal @default(0) @db.Decimal(10, 2) // Discount (if included)
  taxAmount      Decimal @default(0) @db.Decimal(10, 2) // Tax (if included)

  // Commission calculation
  effectiveRate   Decimal @db.Decimal(5, 4) // Rate that was applied
  grossCommission Decimal @db.Decimal(10, 2) // Before any deductions
  netCommission   Decimal @db.Decimal(10, 2) // Final commission amount

  // Metadata
  calcType CommissionCalcType
  tier     Int? // Tier level if tiered
  tierName String? // Tier name for display

  // Status
  status       CommissionCalcStatus @default(CALCULATED)
  aggregatedAt DateTime?
  summaryId    String? // Link to CommissionSummary when aggregated
  summary      CommissionSummary?   @relation(fields: [summaryId], references: [id])

  // Voiding
  voidedAt   DateTime?
  voidedBy   String?
  voidReason String?

  // Timestamps
  calculatedAt DateTime @default(now())
  createdAt    DateTime @default(now())

  // Clawbacks
  clawbacks CommissionClawback[]

  @@index([venueId, staffId])
  @@index([paymentId])
  @@index([orderId])
  @@index([status])
  @@index([summaryId])
  @@index([staffId, calculatedAt])
}

/// Aggregated commission summary per period
/// Groups CommissionCalculations for approval and payment
model CommissionSummary {
  id      String @id @default(cuid())
  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)
  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id])

  // Period
  periodType  TierPeriod // DAILY, WEEKLY, etc.
  periodStart DateTime
  periodEnd   DateTime

  // Aggregated totals
  totalSales       Decimal @db.Decimal(14, 2) // Total sales in period
  totalTips        Decimal @default(0) @db.Decimal(12, 2)
  totalCommissions Decimal @db.Decimal(12, 2) // Sum of all calculations
  totalBonuses     Decimal @default(0) @db.Decimal(10, 2) // Milestone bonuses
  totalClawbacks   Decimal @default(0) @db.Decimal(10, 2) // Deducted clawbacks
  grandTotal       Decimal @db.Decimal(12, 2) // commissions + bonuses - clawbacks

  // Computed amounts (for easier querying)
  grossAmount     Decimal @default(0) @db.Decimal(12, 2) // totalCommissions + totalBonuses
  deductionAmount Decimal @default(0) @db.Decimal(10, 2) // Same as totalClawbacks (alias)
  netAmount       Decimal @default(0) @db.Decimal(12, 2) // Same as grandTotal (final payout)

  // Statistics
  orderCount   Int @default(0)
  paymentCount Int @default(0)

  // Status
  status  CommissionSummaryStatus @default(DRAFT)
  version Int                     @default(1) // Optimistic concurrency

  // Approval
  approvedAt   DateTime?
  approvedById String?
  approvedBy   Staff?    @relation("CommissionSummaryApprovedBy", fields: [approvedById], references: [id])

  // Dispute
  disputedAt        DateTime?
  disputeReason     String?
  disputeResolvedAt DateTime?

  // Notes
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  calculations CommissionCalculation[]
  payouts      CommissionPayout[]
  clawbacks    CommissionClawback[]

  @@unique([venueId, staffId, periodType, periodStart])
  @@index([venueId, periodStart])
  @@index([staffId])
  @@index([status])
}

/// Payout records for commission payments
model CommissionPayout {
  id      String @id @default(cuid())
  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // Staff receiving the payout (denormalized from summary for faster queries)
  staffId String
  staff   Staff  @relation("CommissionPayoutStaff", fields: [staffId], references: [id])

  // What's being paid
  summaryId String
  summary   CommissionSummary @relation(fields: [summaryId], references: [id])

  // Payment details
  amount           Decimal @db.Decimal(12, 2)
  paymentMethod    String // "CASH", "BANK_TRANSFER", "PAYROLL"
  reference        String? // Bank reference, check number, etc.
  paymentReference String? // External payment reference (e.g., bank transaction ID)

  // Status
  status CommissionPayoutStatus @default(PENDING)

  // Processing
  processedAt   DateTime?
  processedById String?
  processedBy   Staff?    @relation("CommissionPayoutProcessedBy", fields: [processedById], references: [id])

  // Payout completion
  paidAt DateTime?

  // Error handling
  failureReason String?
  retryCount    Int     @default(0)

  // Notes
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([venueId])
  @@index([staffId])
  @@index([summaryId])
  @@index([status])
  @@index([paidAt])
}

/// Clawback records for refunds that occur after payout
/// Created when a refund affects a commission that was already paid out
model CommissionClawback {
  id            String                @id @default(cuid())
  calculationId String
  calculation   CommissionCalculation @relation(fields: [calculationId], references: [id])
  summaryId     String
  summary       CommissionSummary     @relation(fields: [summaryId], references: [id])

  // Clawback details
  reason          ClawbackReason
  amount          Decimal        @db.Decimal(10, 2) // Amount to claw back
  refundId        String? // Reference to refund payment if applicable (legacy)
  refundPaymentId String? // Reference to the refund Payment record

  // Status
  appliedToSummaryId String? // Future summary where this was deducted
  appliedAt          DateTime?

  // Audit
  createdById String
  createdBy   Staff   @relation("CommissionClawbackCreatedBy", fields: [createdById], references: [id])
  notes       String?

  createdAt DateTime @default(now())

  @@index([calculationId])
  @@index([summaryId])
  @@index([refundPaymentId])
}

// ==========================================
// PLAYTELECOM / WHITE-LABEL DASHBOARD MODELS
// For cash deposits and performance goals
// Used by Module System for venues with WHITE_LABEL_DASHBOARD module
// Note: Attendance tracking uses the TimeEntry model (see above)
// ==========================================

enum CashDepositMethod {
  CASH
  BANK_TRANSFER
}

enum CashDepositStatus {
  PENDING
  APPROVED
  REJECTED
}

/// Tracks cash deposits from staff to be validated by supervisors
model CashDeposit {
  id      String @id @default(cuid())
  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)
  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  amount    Decimal           @db.Decimal(10, 2)
  method    CashDepositMethod
  timestamp DateTime          @default(now())

  // Voucher evidence
  voucherImageUrl String?

  // Status tracking
  status          CashDepositStatus @default(PENDING)
  approvedById    String?
  approvedBy      Staff?            @relation("DepositApprover", fields: [approvedById], references: [id])
  approvedAt      DateTime?
  rejectionReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([staffId])
  @@index([venueId])
  @@index([venueId, status])
  @@index([staffId, venueId])
}

/// Configures low-stock alerts per category per venue
model StockAlertConfig {
  id         String       @id @default(cuid())
  venueId    String
  venue      Venue        @relation(fields: [venueId], references: [id], onDelete: Cascade)
  categoryId String
  category   ItemCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  minimumStock Int // Minimum stock level before alert
  alertEnabled Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([venueId, categoryId])
  @@index([venueId])
}

/// Performance goals for staff (sales targets, units, etc.)
model PerformanceGoal {
  id      String @id @default(cuid())
  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)
  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  month     DateTime // First day of month (YYYY-MM-01)
  salesGoal Decimal  @db.Decimal(10, 2)
  unitsGoal Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([staffId, venueId, month])
  @@index([venueId])
  @@index([staffId])
}

// ==========================================
// ORGANIZATION GOALS (for CommandCenter charts)
// Used in PlayTelecom dashboard for "Ingresos vs Meta" and "Volumen vs Meta"
// ==========================================
model OrganizationGoal {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Period configuration
  period     String   @default("daily") // "daily" | "weekly" | "monthly"
  periodDate DateTime // First day of the period (YYYY-MM-DD for daily, week start, or month start)

  // Targets
  salesTarget  Decimal @db.Decimal(12, 2) // Revenue target (e.g., $135,000)
  volumeTarget Int // Number of sales target (e.g., 500 sales)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, period, periodDate])
  @@index([organizationId])
  @@index([periodDate])
}

// Organization-level sales goal defaults
// Venues without custom goals inherit these; venue goals override entirely
model OrganizationSalesGoalConfig {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  goal     Decimal @db.Decimal(12, 2)
  goalType String  @default("AMOUNT") // "AMOUNT" | "QUANTITY"
  period   String  @default("MONTHLY") // "DAILY" | "WEEKLY" | "MONTHLY"

  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, period, goalType])
  @@index([organizationId])
}

// Organization-level attendance config defaults (inherited by venues without custom config)
// Venues with null attendance fields inherit from this; venues with explicit values override
model OrganizationAttendanceConfig {
  id             String       @id @default(cuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  expectedCheckInTime      String @default("09:00") // "HH:mm" ‚Äî expected check-in time
  latenessThresholdMinutes Int    @default(30)       // Minutes of tolerance after expectedCheckInTime
  geofenceRadiusMeters     Int    @default(500)      // Max distance (meters) from venue for valid clock-in

  // Module defaults (inherited by venues without terminal-level overrides)
  attendanceTracking   Boolean @default(false)
  requireFacadePhoto   Boolean @default(false)
  requireDepositPhoto  Boolean @default(false)
  enableCashPayments   Boolean @default(true)
  enableCardPayments   Boolean @default(true)
  enableBarcodeScanner Boolean @default(true)

  // Full TPV terminal settings (all 35 fields as JSON)
  // Source of truth for org-level defaults. Individual columns above kept for backward compat.
  settings Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Organization-level payout configuration defaults (inherited by venues)
model OrganizationPayoutConfig {
  id             String       @id @default(cuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  aggregationPeriod String   @default("MONTHLY") // "WEEKLY" | "BIWEEKLY" | "MONTHLY" | "QUARTERLY"
  requireApproval   Boolean  @default(true)
  paymentMethods    String[] @default(["CASH", "BANK_TRANSFER"])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================================
// TPV APP UPDATE SYSTEM
// Dual update system: Blumon (provider) + Avoqado (self-managed)
// Allows independent control over app distribution
// ==========================================

enum AppEnvironment {
  SANDBOX // Development/testing builds
  PRODUCTION // Production builds for real terminals
}

/// Update notification mode for TPV app updates
enum UpdateMode {
  NONE // No notification - silent update available
  BANNER // Persistent banner - recommended update, user can dismiss/ignore
  FORCE // Blocking modal - critical update, app blocked until updated
}

/// Tracks TPV app versions uploaded by superadmin
/// Enables self-managed updates independent of Blumon
model AppUpdate {
  id String @id @default(cuid())

  // Version info (Android standard)
  versionName String // Semantic version: "1.3.0"
  versionCode Int // Android version code: 6 (always increments)

  // Environment targeting
  environment AppEnvironment

  // Release info
  releaseNotes String?    @db.Text // Markdown changelog
  updateMode   UpdateMode @default(NONE) // NONE=silent, BANNER=recommended, FORCE=blocking

  // File info (Firebase Storage)
  downloadUrl String // Firebase Storage signed URL or public URL
  fileSize    BigInt // File size in bytes
  checksum    String // SHA-256 hash for integrity verification

  // Compatibility
  minAndroidSdk Int @default(27) // Minimum Android SDK (27 = Android 8.1)

  // Status
  isActive Boolean @default(true) // Whether this version is available for download

  // Audit
  uploadedById String
  uploadedBy   Staff  @relation("AppUpdateUploadedBy", fields: [uploadedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Unique constraint: only one active version per environment
  // Allows multiple versions but queries filter by isActive
  @@unique([versionCode, environment])
  @@index([environment, isActive])
  @@index([versionCode])
}

// ==========================================
// VENUE CRYPTO CONFIG - Per-venue B4Bit device credentials
// ==========================================

enum CryptoConfigStatus {
  PENDING_SETUP // Device created, missing secretKey
  ACTIVE // Fully configured and validated
  INACTIVE // Manually disabled
}

model VenueCryptoConfig {
  id      String @id @default(cuid())
  venueId String @unique
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // B4Bit Device credentials
  b4bitDeviceId   String // API Key (UUID) - auto-created via POST /device/
  b4bitDeviceName String // Device name (= venue name for matching)
  b4bitSecretKey  String? // Device Secret Key (manual - from B4Bit dashboard)

  // Status
  status CryptoConfigStatus @default(PENDING_SETUP)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([venueId])
}

// ==========================================
// MARKETING CAMPAIGNS - Superadmin mass email system
// ==========================================

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  COMPLETED
  FAILED
  CANCELLED
}

enum DeliveryStatus {
  PENDING
  SENT
  FAILED
  BOUNCED
}

/// Reusable email templates for marketing campaigns
model EmailTemplate {
  id       String @id @default(cuid())
  name     String
  subject  String
  bodyHtml String @db.Text
  bodyText String @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String
  creator   Staff    @relation("EmailTemplateCreator", fields: [createdBy], references: [id])

  campaigns MarketingCampaign[]

  @@index([createdAt])
}

/// Marketing campaign for mass emails to venues/staff
model MarketingCampaign {
  id       String @id @default(cuid())
  name     String
  subject  String
  bodyHtml String @db.Text
  bodyText String @db.Text

  // Template reference (optional - if created from template)
  templateId String?
  template   EmailTemplate? @relation(fields: [templateId], references: [id])

  // Targeting
  targetAllVenues  Boolean  @default(true)
  targetVenueIds   String[] // Specific venue IDs if not targeting all
  includeStaff     Boolean  @default(false)
  targetStaffRoles String[] // OWNER, ADMIN, MANAGER, etc.

  // Status
  status       CampaignStatus @default(DRAFT)
  scheduledFor DateTime?
  startedAt    DateTime?
  completedAt  DateTime?

  // Stats (updated as emails are sent)
  totalRecipients Int @default(0)
  sentCount       Int @default(0)
  failedCount     Int @default(0)
  openedCount     Int @default(0) // Tracking: emails opened (via Resend webhooks)
  clickedCount    Int @default(0) // Tracking: links clicked (via Resend webhooks)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String
  creator   Staff    @relation("MarketingCampaignCreator", fields: [createdBy], references: [id])

  deliveries CampaignDelivery[]

  @@index([status])
  @@index([createdAt])
}

/// Individual email delivery within a campaign
model CampaignDelivery {
  id         String            @id @default(cuid())
  campaignId String
  campaign   MarketingCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  recipientEmail String
  recipientName  String?
  venueId        String?
  venueName      String?
  isStaff        Boolean @default(false)

  status   DeliveryStatus @default(PENDING)
  sentAt   DateTime?
  error    String?
  resendId String? // Resend email ID for tracking

  // Tracking (updated via Resend webhooks)
  openedAt     DateTime?
  clickedAt    DateTime?
  clickedLinks String[] // Track which links were clicked

  @@index([campaignId, status])
  @@index([recipientEmail])
  @@index([resendId])
}

// ==========================================
// TPV MESSAGING SYSTEM
// Dashboard ‚Üí TPV terminal messaging (announcements, surveys, actions)
// ==========================================

/// Message sent from dashboard to TPV terminals
model TpvMessage {
  id      String @id @default(cuid())
  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // Content
  type     TpvMessageType
  title    String
  body     String             @db.Text
  priority TpvMessagePriority @default(NORMAL)

  // Interaction config
  requiresAck Boolean @default(false) // Must acknowledge vs simple dismiss

  // Survey options (only for SURVEY type)
  surveyOptions     Json? // ["Option A", "Option B", "Option C"]
  surveyMultiSelect Boolean @default(false)

  // Action config (only for ACTION type)
  actionLabel   String? // Button text e.g. "Update menu"
  actionType    String? // What the TPV should do: REFRESH_MENU | SYNC_DATA | CUSTOM
  actionPayload Json? // Extra data for the action

  // Targeting
  targetType        TpvMessageTarget // ALL_TERMINALS | SPECIFIC_TERMINALS
  targetTerminalIds String[] // Terminal IDs (only when SPECIFIC_TERMINALS)

  // Scheduling & expiration
  scheduledFor DateTime? // Send at future time (null = immediate)
  expiresAt    DateTime? // Auto-dismiss after this time

  // Audit
  createdBy     String // Staff ID who created the message
  createdByName String // Staff name for display

  // Status
  status TpvMessageStatus @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  deliveries TpvMessageDelivery[]
  responses  TpvMessageResponse[]

  @@index([venueId, status])
  @@index([status, scheduledFor])
  @@index([createdAt])
  @@map("tpv_messages")
}

/// Per-terminal delivery tracking for a TpvMessage
model TpvMessageDelivery {
  id         String     @id @default(cuid())
  messageId  String
  message    TpvMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  terminalId String
  terminal   Terminal   @relation(fields: [terminalId], references: [id], onDelete: Cascade)

  status         TpvMessageDeliveryStatus @default(PENDING)
  deliveredAt    DateTime?
  acknowledgedAt DateTime?
  dismissedAt    DateTime?
  acknowledgedBy String? // Staff PIN user who acknowledged

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([messageId, terminalId])
  @@index([terminalId, status])
  @@index([messageId, status])
  @@map("tpv_message_deliveries")
}

/// Survey response from a terminal for a TpvMessage
model TpvMessageResponse {
  id         String     @id @default(cuid())
  messageId  String
  message    TpvMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  terminalId String
  terminal   Terminal   @relation(fields: [terminalId], references: [id], onDelete: Cascade)

  selectedOptions String[] // Selected survey option texts
  respondedBy     String? // Staff ID
  respondedByName String? // Staff name

  createdAt DateTime @default(now())

  @@unique([messageId, terminalId])
  @@index([messageId])
  @@map("tpv_message_responses")
}

// ---- TPV Messaging Enums ----

enum TpvMessageType {
  ANNOUNCEMENT
  SURVEY
  ACTION
}

enum TpvMessagePriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum TpvMessageTarget {
  ALL_TERMINALS
  SPECIFIC_TERMINALS
}

enum TpvMessageStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

enum TpvMessageDeliveryStatus {
  PENDING
  DELIVERED
  ACKNOWLEDGED
  DISMISSED
}

// ==========================================
// TRAINING / LMS SYSTEM
// ==========================================

model TrainingModule {
  id             String   @id @default(cuid())
  organizationId String?  // null = global (available to all orgs)
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  title            String
  description      String   @db.Text
  coverImageUrl    String?
  category         TrainingCategory   @default(GENERAL)
  difficulty       TrainingDifficulty @default(BASIC)
  estimatedMinutes Int      @default(5)
  isRequired       Boolean  @default(false)
  position         Int      @default(0)
  status           TrainingStatus @default(DRAFT)

  // Feature tags for auto-filtering (e.g., ["SERIALIZED_INVENTORY", "PAYMENTS"])
  // Empty = shown to ALL orgs. Non-empty = only shown if org has at least one matching module
  featureTags    String[] @default([])

  // Venue-level filtering: if non-empty, only these venues see the training
  // Empty = all venues in the org (or all venues globally if organizationId is null)
  venueIds       String[] @default([])

  quizPassThreshold  Int      @default(70)   // Percentage needed to pass (1-100)
  quizMaxAttempts    Int      @default(0)    // 0 = unlimited

  createdBy      String
  createdByName  String

  steps          TrainingStep[]
  quizQuestions  TrainingQuizQuestion[]
  progress       TrainingProgress[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("training_modules")
}

model TrainingStep {
  id               String   @id @default(cuid())
  trainingModuleId String
  trainingModule   TrainingModule @relation(fields: [trainingModuleId], references: [id], onDelete: Cascade)

  stepNumber       Int
  title            String
  instruction      String   @db.Text
  mediaType        TrainingMediaType @default(IMAGE)
  mediaUrl         String?
  thumbnailUrl     String?
  tipText          String?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([trainingModuleId, stepNumber])
  @@map("training_steps")
}

model TrainingQuizQuestion {
  id               String   @id @default(cuid())
  trainingModuleId String
  trainingModule   TrainingModule @relation(fields: [trainingModuleId], references: [id], onDelete: Cascade)

  questionType     TrainingQuestionType @default(MULTIPLE_CHOICE)
  question         String
  options          String[]
  correctIndex     Int
  correctIndices   Int[]    @default([])  // For MULTI_SELECT: multiple correct answers
  position         Int      @default(0)
  explanation      String?    // Explanation shown after quiz submission

  createdAt        DateTime @default(now())

  @@map("training_quiz_questions")
}

model TrainingProgress {
  id               String   @id @default(cuid())
  trainingModuleId String
  trainingModule   TrainingModule @relation(fields: [trainingModuleId], references: [id], onDelete: Cascade)
  staffId          String
  venueId          String

  lastStepViewed   Int      @default(0)
  isCompleted      Boolean  @default(false)
  quizScore        Int?
  quizTotal        Int?
  quizPassed       Boolean?
  attemptNumber    Int      @default(1)

  startedAt        DateTime @default(now())
  completedAt      DateTime?

  @@unique([trainingModuleId, staffId])
  @@map("training_progress")
}

enum TrainingCategory {
  VENTAS
  INVENTARIO
  PAGOS
  ATENCION_CLIENTE
  GENERAL
}

enum TrainingDifficulty {
  BASIC
  INTERMEDIATE
}

enum TrainingStatus {
  DRAFT
  PUBLISHED
}

enum TrainingMediaType {
  IMAGE
  VIDEO
}

enum TrainingQuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  MULTI_SELECT
}

// ==========================================
// RESERVATION / BOOKING SYSTEM
// ==========================================

enum ReservationStatus {
  PENDING    // Created, awaiting confirmation
  CONFIRMED  // Confirmed (auto or manual)
  CHECKED_IN // Guest arrived
  COMPLETED  // Service delivered
  CANCELLED  // Cancelled by customer, staff, or system (expired)
  NO_SHOW    // Guest didn't arrive within grace period
}

enum ReservationChannel {
  DASHBOARD   // Created by staff
  WEB         // Customer self-service (booking page/widget)
  PHONE       // Phone booking logged by staff
  WHATSAPP    // WhatsApp integration
  APP         // Mobile app
  WALK_IN     // Walk-in converted to reservation
  THIRD_PARTY // External sync (Google Reserve, etc.)
}

enum DepositStatus {
  PENDING   // Deposit requested, not yet paid
  CARD_HOLD // Card captured via Stripe SetupIntent, not yet charged
  PAID      // Payment received
  REFUNDED  // Deposit returned to customer
  FORFEITED // Lost due to no-show/late cancel
}

enum WaitlistStatus {
  WAITING   // In queue
  NOTIFIED  // Slot opened, customer notified
  PROMOTED  // Converted to reservation
  EXPIRED   // No response within window
  CANCELLED // Left waitlist
}

model Reservation {
  id      String @id @default(cuid())
  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // Human-readable confirmation code (e.g., "RES-A3X7K2") ‚Äî for display/phone/WhatsApp
  confirmationCode String
  // Cryptographic token for public view/cancel (UUID v4 ‚Äî NOT guessable like confirmationCode)
  cancelSecret     String @default(uuid())

  // Classification
  status  ReservationStatus  @default(PENDING)
  channel ReservationChannel @default(DASHBOARD)

  // Timing (all UTC ‚Äî Prisma pattern)
  startsAt DateTime
  endsAt   DateTime
  duration Int // Minutes (denormalized for queries)

  // Guest info (linked Customer or anonymous)
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  guestName  String?
  guestPhone String?
  guestEmail String?
  partySize  Int       @default(1)

  // Direct resource references (NO junction tables for MVP)
  tableId         String?
  table           Table?   @relation(fields: [tableId], references: [id], onDelete: SetNull)
  productId       String?
  product         Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  assignedStaffId String?
  assignedStaff   Staff?   @relation("ReservationStaff", fields: [assignedStaffId], references: [id], onDelete: SetNull)

  // Deposit (direct fields ‚Äî avoids synthetic Orders that pollute KPIs)
  depositAmount       Decimal?       @db.Decimal(10, 2)
  depositStatus       DepositStatus?
  depositProcessorRef String? // Stripe PaymentIntent ID or processor reference
  depositPaidAt       DateTime?
  depositRefundedAt   DateTime?

  // Staff assignment
  createdById String?
  createdBy   Staff? @relation("ReservationCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  // Status timestamps (audit trail for MVP ‚Äî proper ReservationHistory in Phase 2)
  confirmedAt DateTime?
  checkedInAt DateTime?
  completedAt DateTime?
  cancelledAt DateTime?
  noShowAt    DateTime?

  // Cancellation details
  cancelledBy        String? // Staff ID, "CUSTOMER", or "SYSTEM"
  cancellationReason String? @db.Text

  // Notes
  specialRequests String?  @db.Text
  internalNotes   String?  @db.Text
  tags            String[] @default([])

  // Simple JSON audit log for MVP (proper model in Phase 2)
  statusLog Json? // [{ status, at, by, reason? }]

  // Relations (Phase 2)
  waitlistPromotion ReservationWaitlistEntry?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Indexes
  @@unique([venueId, confirmationCode])
  @@index([venueId, status, startsAt])
  @@index([venueId, startsAt, endsAt])
  @@index([venueId, tableId, startsAt])
  @@index([venueId, productId, startsAt])
  @@index([venueId, assignedStaffId, startsAt])
  @@index([customerId])
  @@index([cancelSecret])
}

model ReservationWaitlistEntry {
  id      String @id @default(cuid())
  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  guestName  String?
  guestPhone String?

  partySize      Int            @default(1)
  desiredStartAt DateTime
  desiredEndAt   DateTime?
  status         WaitlistStatus @default(WAITING)
  position       Int // Queue position (party-size-aware, not pure FIFO)

  notifiedAt       DateTime?
  responseDeadline DateTime?

  // If converted to reservation
  promotedReservationId String?      @unique
  promotedReservation   Reservation? @relation(fields: [promotedReservationId], references: [id], onDelete: SetNull)

  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([venueId, status, desiredStartAt])
  @@index([venueId, status, partySize])
}

model ReservationSettings {
  id      String @id @default(cuid())
  venueId String @unique
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // Scheduling
  slotIntervalMin    Int     @default(15)
  defaultDurationMin Int     @default(60)
  autoConfirm        Boolean @default(true)
  maxAdvanceDays     Int     @default(60)
  minNoticeMin       Int     @default(60)
  noShowGraceMin     Int     @default(15)

  // Pacing
  pacingMaxPerSlot      Int? // null = no pacing limit
  onlineCapacityPercent Int  @default(100)

  // Deposits
  depositMode          String   @default("none") // none | card_hold | deposit | prepaid
  depositFixedAmount   Decimal? @db.Decimal(10, 2)
  depositPercentage    Int? // percentage of service price
  depositPartySizeGte  Int? // require deposit for parties >= this size
  depositPaymentWindow Int? // hours to complete payment

  // Waitlist
  waitlistEnabled      Boolean @default(true)
  waitlistMaxSize      Int     @default(50)
  waitlistPriorityMode String  @default("fifo") // fifo | party_size | broadcast
  waitlistNotifyWindow Int     @default(30) // minutes

  // Public booking
  publicBookingEnabled Boolean @default(false)
  requirePhone         Boolean @default(true)
  requireEmail         Boolean @default(false)

  // Cancellation
  allowCustomerCancel   Boolean @default(true)
  minHoursBeforeCancel  Int?    @default(2) // minimum hours before start to allow cancellation
  forfeitDeposit        Boolean @default(false)
  noShowFeePercent      Int? // percentage of deposit/service charged on no-show

  // Reminders
  remindersEnabled  Boolean  @default(true)
  reminderChannels  String[] @default(["EMAIL"])
  reminderMinBefore Int[]    @default([1440, 120]) // minutes before reservation

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
