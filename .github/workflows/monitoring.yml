name: ğŸ“Š Service Monitoring & Health Checks

# ğŸ’¤ FREE TIER CONFIGURATION
# This monitoring is configured for Render.com FREE tier services
# - Hourly health checks (to avoid spam from sleeping services)
# - Cold start tolerant (waits and retries)
# - Friendly alerts (no panic for normal sleep behavior)
#
# ğŸš€ TO UPGRADE TO PAID TIER:
# 1. Change cron to '*/15 * * * *' (every 15 minutes)
# 2. Remove cold start retry logic if desired
# 3. Make alerts more strict

on:
  # Temporarily disable scheduled health checks to stop hourly emails
  # schedule:
  #   - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      check_type:
        description: 'Type of check to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - production
          - staging
          - database

permissions:
  contents: read
  issues: write
  actions: write

env:
  PRODUCTION_URL: https://avoqado-server.onrender.com
  STAGING_URL: https://avoqado-server-staging-cm35.onrender.com

jobs:
  # ğŸ¥ Health Check Production
  health-check-production:
    name: ğŸ¥ Production Health Check
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.check_type == 'all' || github.event.inputs.check_type == 'production'))

    steps:
      - name: ğŸ” Production API Health Check (Free Tier Friendly)
        id: prod-health
        run: |
          echo "ğŸ” Checking production health (allowing for cold start)..."

          # First attempt - might be sleeping
          echo "ğŸŒ™ First attempt (service might be sleeping)..."
          HEALTH_RESPONSE=$(curl -s --connect-timeout 30 --max-time 60 -w "HTTPSTATUS:%{http_code};TIME:%{time_total}" $PRODUCTION_URL/health || echo "FAILED")

          if [[ $HEALTH_RESPONSE == *"HTTPSTATUS:200"* ]]; then
            TIME=$(echo $HEALTH_RESPONSE | sed 's/.*TIME:\([0-9.]*\).*/\1/')
            echo "âœ… Production health check passed on first attempt"
            echo "â±ï¸ Response time: ${TIME}s"
            echo "status=healthy" >> $GITHUB_OUTPUT
          else
            echo "â³ First attempt failed (likely cold start), waiting 30s and retrying..."
            sleep 30
            
            # Second attempt - should be warmed up now
            echo "ğŸ”„ Second attempt after warmup..."
            HEALTH_RESPONSE=$(curl -s --connect-timeout 30 --max-time 60 -w "HTTPSTATUS:%{http_code};TIME:%{time_total}" $PRODUCTION_URL/health || echo "FAILED")
            
            if [[ $HEALTH_RESPONSE == *"HTTPSTATUS:200"* ]]; then
              TIME=$(echo $HEALTH_RESPONSE | sed 's/.*TIME:\([0-9.]*\).*/\1/')
              echo "âœ… Production health check passed after warmup"
              echo "â±ï¸ Response time: ${TIME}s (includes cold start)"
              echo "status=healthy" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ Production service appears to be down or having issues"
              echo "Response: $HEALTH_RESPONSE"
              echo "status=unhealthy" >> $GITHUB_OUTPUT
              echo "ğŸ’¡ Note: This might be normal for Render.com free tier cold starts"
            fi
          fi

      - name: ğŸ” Production API Endpoints Check
        if: steps.prod-health.outputs.status == 'healthy'
        run: |
          echo "ğŸ” Testing production API endpoints..."

          # Test auth endpoint (should return 401 without token)
          AUTH_RESPONSE=$(curl -s -w "%{http_code}" $PRODUCTION_URL/api/auth/me -o /dev/null || echo "FAILED")
          if [[ $AUTH_RESPONSE == "401" ]]; then
            echo "âœ… Auth endpoint responding correctly (401 without token)"
          else
            echo "âš ï¸ Auth endpoint unexpected response: $AUTH_RESPONSE"
          fi

          # Test CORS headers
          CORS_HEADERS=$(curl -s -H "Origin: https://dashboardv2.avoqado.io" -I $PRODUCTION_URL/health | grep -i "access-control" || echo "No CORS headers")
          echo "ğŸŒ CORS headers: $CORS_HEADERS"

      - name: ğŸ“Š Production Performance Check
        if: steps.prod-health.outputs.status == 'healthy'
        run: |
          echo "ğŸ“Š Checking production performance..."

          # Measure response time
          RESPONSE_TIME=$(curl -s -w "%{time_total}" -o /dev/null $PRODUCTION_URL/health || echo "0")
          echo "â±ï¸ Response time: ${RESPONSE_TIME}s"

          # Check if response time is acceptable (< 3 seconds)
          if (( $(echo "$RESPONSE_TIME < 3.0" | bc -l) )); then
            echo "âœ… Response time is acceptable"
          else
            echo "âš ï¸ Response time is slow: ${RESPONSE_TIME}s"
          fi

      - name: ğŸ“‹ Production Health Report
        if: steps.prod-health.outputs.status == 'unhealthy'
        run: |
          echo "ğŸ“‹ Production Health Check Report"
          echo "Time: $(date -u)"
          echo "Service: Production API"
          echo "URL: $PRODUCTION_URL/health"
          echo "Status: Service appears to be sleeping or slow to respond"
          echo "ğŸ’¡ This is normal behavior for Render.com free tier"
          echo "ğŸ”„ Service will warm up when users access it"
          echo "âš ï¸ Only investigate if this persists for multiple hours"

  # ğŸ§ª Health Check Staging
  health-check-staging:
    name: ğŸ§ª Staging Health Check
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.check_type == 'all' || github.event.inputs.check_type == 'staging'))

    steps:
      - name: ğŸ” Staging API Health Check (Free Tier Friendly)
        id: staging-health
        run: |
          echo "ğŸ” Checking staging health (allowing for cold start)..."

          # Single attempt with longer timeout for staging
          HEALTH_RESPONSE=$(curl -s --connect-timeout 30 --max-time 60 -w "HTTPSTATUS:%{http_code};TIME:%{time_total}" $STAGING_URL/health || echo "FAILED")

          if [[ $HEALTH_RESPONSE == *"HTTPSTATUS:200"* ]]; then
            TIME=$(echo $HEALTH_RESPONSE | sed 's/.*TIME:\([0-9.]*\).*/\1/')
            echo "âœ… Staging health check passed"
            echo "â±ï¸ Response time: ${TIME}s"
            echo "status=healthy" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Staging health check failed (expected for free tier)"
            echo "Response: $HEALTH_RESPONSE"
            echo "status=unhealthy" >> $GITHUB_OUTPUT
            echo "ğŸ’¡ Staging service is likely sleeping - this is normal"
          fi

      - name: ğŸ” Staging API Endpoints Check
        if: steps.staging-health.outputs.status == 'healthy'
        run: |
          echo "ğŸ” Testing staging API endpoints..."

          # Test basic endpoints
          curl -s -f $STAGING_URL/health > /dev/null && echo "âœ… Health endpoint OK"

      - name: âš ï¸ Staging Warning
        if: steps.staging-health.outputs.status == 'unhealthy'
        run: |
          echo "âš ï¸ STAGING WARNING: Health check failed!"
          echo "Time: $(date -u)"
          echo "Service: Staging API"
          echo "URL: $STAGING_URL/health"
          echo "This is non-critical but should be investigated"

  # ğŸ—„ï¸ Database Health Check
  database-health-check:
    name: ğŸ—„ï¸ Database Health Check
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.check_type == 'all' || github.event.inputs.check_type == 'database'))

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—„ï¸ Check database connectivity
        run: |
          echo "ğŸ—„ï¸ Checking database health via API..."

          # Check if the API can connect to database by testing a simple endpoint
          # The /health endpoint should include database connectivity status

          PROD_DB_CHECK=$(curl -s $PRODUCTION_URL/health | jq -r '.database // "unknown"' || echo "failed")
          STAGING_DB_CHECK=$(curl -s $STAGING_URL/health | jq -r '.database // "unknown"' || echo "failed")

          echo "ğŸ“Š Production database status: $PROD_DB_CHECK"
          echo "ğŸ“Š Staging database status: $STAGING_DB_CHECK"

          if [[ $PROD_DB_CHECK == "healthy" || $PROD_DB_CHECK == "ok" ]]; then
            echo "âœ… Production database is healthy"
          else
            echo "âŒ Production database issue detected"
            exit 1
          fi

  # ğŸ“Š Generate Health Report
  health-report:
    name: ğŸ“Š Generate Health Report
    runs-on: ubuntu-latest
    needs: [health-check-production, health-check-staging, database-health-check]
    if: always() && github.event_name == 'workflow_dispatch'

    steps:
      - name: ğŸ“Š Generate comprehensive health report
        run: |
          echo "# ğŸ“Š Avoqado System Health Report"
          echo "Generated at: $(date -u)"
          echo ""

          echo "## ğŸ­ Production Status"
          if [[ "${{ needs.health-check-production.result }}" == "success" ]]; then
            echo "âœ… Production: Healthy"
          else
            echo "âŒ Production: Issues detected"
          fi

          echo ""
          echo "## ğŸ§ª Staging Status"
          if [[ "${{ needs.health-check-staging.result }}" == "success" ]]; then
            echo "âœ… Staging: Healthy"
          else
            echo "âš ï¸ Staging: Issues detected"
          fi

          echo ""
          echo "## ğŸ—„ï¸ Database Status"
          if [[ "${{ needs.database-health-check.result }}" == "success" ]]; then
            echo "âœ… Database: Healthy"
          else
            echo "âŒ Database: Issues detected"
          fi

          echo ""
          echo "## ğŸ” Next Steps"
          if [[ "${{ needs.health-check-production.result }}" != "success" ]]; then
            echo "1. âš ï¸ **URGENT**: Investigate production issues immediately"
            echo "2. Check Render.com dashboard for production service status"
            echo "3. Review recent deployments and changes"
          fi

          if [[ "${{ needs.database-health-check.result }}" != "success" ]]; then
            echo "1. âš ï¸ Check database connectivity and performance"
            echo "2. Review database logs in provider dashboard"
            echo "3. Check for any ongoing maintenance"
          fi

          if [[ "${{ needs.health-check-staging.result }}" != "success" ]]; then
            echo "1. ğŸ”§ Investigate staging issues (lower priority)"
            echo "2. Ensure staging environment is properly configured"
          fi
