# Avoqado Server CI/CD Pipeline
# ==============================
# This workflow handles testing and deployment to Render (production).
#
# ENVIRONMENT MAPPING:
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ Push to develop                                                 â”‚
# â”‚ â†“                                                               â”‚
# â”‚ This workflow: test only (staging Render service disabled)     â”‚
# â”‚ fly-deploy.yml: deploy-demo (Fly.io - instant start)           â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ Push to main                                                    â”‚
# â”‚ â†“                                                               â”‚
# â”‚ This workflow: test â†’ deploy-production (Render $7/mo)         â”‚
# â”‚ release.yml: create GitHub release (if version changed)        â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# SERVICE URLS:
#   - Production: https://avoqado-server.onrender.com (Render)
#   - Demo:       https://avoqado-server.fly.dev (Fly.io) - see fly-deploy.yml

name: ğŸš€ Avoqado Server CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production

permissions:
  contents: write
  actions: read
  security-events: write
  pull-requests: write
  issues: write

jobs:
  # ğŸ§ª Quality Gate: Test, lint and build
  test-and-build:
    name: ğŸ§ª Test, Lint & Build
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.package-version.outputs.version }}
      build-time: ${{ steps.build-info.outputs.build-time }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ“ Run ESLint
        run: npm run lint

      - name: ğŸ” TypeScript compilation check
        run: npx tsc --noEmit

      - name: ğŸ—„ï¸ Generate Prisma Client
        run: npx prisma generate

      - name: ğŸ—ï¸ Build application
        run: npm run build

      - name: ğŸ§ª Run unit tests
        run: npm run test:unit

      - name: ğŸª Run integration tests
        continue-on-error: true
        run: |
          if [ -z "$DATABASE_URL" ]; then
            echo "âš ï¸ Integration tests skipped - TEST_DATABASE_URL not configured"
            echo "ğŸ“– See docs/CI_CD_SETUP.md for setup instructions"
            exit 0
          fi
          npm run test:integration
        env:
          DATABASE_URL: ${{ secrets.TEST_DATABASE_URL }}
          ACCESS_TOKEN_SECRET: test-access-token-secret
          SESSION_SECRET: test-session-secret
          COOKIE_SECRET: test-cookie-secret
          NODE_ENV: test

      - name: ğŸ“‹ Get package version
        id: package-version
        run: echo "version=$(node -p 'require("./package.json").version')" >> $GITHUB_OUTPUT

      - name: â° Build info
        id: build-info
        run: echo "build-time=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-files-${{ github.sha }}
          path: dist/
          retention-days: 7

      - name: ğŸ“¤ Upload Prisma schema
        uses: actions/upload-artifact@v4
        with:
          name: prisma-schema-${{ github.sha }}
          path: prisma/
          retention-days: 7

  # NOTE: Staging deploy disabled â€” Render staging service is suspended.
  # Demo environment (Fly.io) is still active via fly-deploy.yml.
  # Uncomment this job if/when Render staging is re-enabled.
  #
  # deploy-staging:
  #   name: ğŸš€ Deploy to Staging
  #   needs: test-and-build
  #   runs-on: ubuntu-latest
  #   if: |
  #     (github.ref == 'refs/heads/develop' && github.event_name == 'push') ||
  #     (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
  #   environment:
  #     name: staging
  #     url: ${{ vars.STAGING_API_URL }}
  #
  #   steps:
  #     - name: ğŸš€ Deploy to Render (Staging)
  #       uses: johnbeynon/render-deploy-action@v0.0.8
  #       with:
  #         service-id: ${{ secrets.RENDER_STAGING_SERVICE_ID }}
  #         api-key: ${{ secrets.RENDER_API_KEY }}
  #
  #     - name: â³ Wait for deployment to stabilize
  #       run: |
  #         echo "â³ Waiting for deployment to complete..."
  #         sleep 90
  #
  #     - name: ğŸ¥ Comprehensive health check
  #       run: |
  #         echo "ğŸ¥ Performing health checks..."
  #
  #         # Basic health check
  #         for i in {1..10}; do
  #           if curl -f -s ${{ vars.STAGING_API_URL }}/health; then
  #             echo "âœ… Basic health check passed!"
  #             break
  #           fi
  #           echo "â³ Health check attempt $i failed, retrying in 10 seconds..."
  #           sleep 10
  #         done
  #
  #         # Extended API tests
  #         echo "ğŸ” Testing API endpoints..."
  #         curl -f -s ${{ vars.STAGING_API_URL }}/health | jq '.' || echo "âŒ JSON response invalid"
  #
  #         echo "âœ… Staging deployment successful!"
  #
  #     - name: ğŸ“¢ Notify staging deployment
  #       if: always()
  #       run: |
  #         STATUS="${{ job.status }}"
  #         if [ "$STATUS" = "success" ]; then
  #           echo "ğŸ‰ âœ… Staging deployment completed successfully!"
  #           echo "ğŸ“ Environment: ${{ vars.STAGING_API_URL }}"
  #           echo "ğŸ“¦ Version: ${{ needs.test-and-build.outputs.version }}"
  #           echo "ğŸ• Build time: ${{ needs.test-and-build.outputs.build-time }}"
  #         else
  #           echo "âŒ ğŸš¨ Staging deployment failed!"
  #           exit 1
  #         fi

  # ğŸ­ Deploy to Production Environment
  deploy-production:
    name: ğŸ­ Deploy to Production
    needs: test-and-build
    runs-on: ubuntu-latest
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment:
      name: production
      url: ${{ vars.PRODUCTION_API_URL }}

    steps:
      - name: ğŸ­ Deploy to Render (Production)
        uses: johnbeynon/render-deploy-action@v0.0.8
        with:
          service-id: ${{ secrets.RENDER_PRODUCTION_SERVICE_ID }}
          api-key: ${{ secrets.RENDER_API_KEY }}

      - name: â³ Wait for deployment to stabilize
        run: |
          echo "â³ Waiting for production deployment to complete..."
          sleep 120

      - name: ğŸ¥ Production health verification
        run: |
          echo "ğŸ¥ Performing comprehensive production health checks..."

          # Extended health checks for production
          for i in {1..15}; do
            if curl -f -s ${{ vars.PRODUCTION_API_URL }}/health; then
              echo "âœ… Production health check $i passed!"
              
              # Additional production-specific checks
              echo "ğŸ” Verifying API responses..."
              HEALTH_RESPONSE=$(curl -s ${{ vars.PRODUCTION_API_URL }}/health)
              echo "ğŸ“Š Health response: $HEALTH_RESPONSE"
              
              # Validate JSON response
              echo "$HEALTH_RESPONSE" | jq '.' > /dev/null || (echo "âŒ Invalid JSON response" && exit 1)
              
              echo "âœ… All production health checks passed!"
              break
            fi
            echo "â³ Production health check attempt $i failed, retrying in 15 seconds..."
            sleep 15
          done

          echo "ğŸ‰ Production deployment successful!"

      - name: ğŸ“¢ Notify production deployment
        if: always()
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            echo "ğŸ‰ âœ… ğŸ­ PRODUCTION DEPLOYMENT SUCCESSFUL! ğŸ­ âœ… ğŸ‰"
            echo "ğŸ“ Environment: ${{ vars.PRODUCTION_API_URL }}"
            echo "ğŸ“¦ Version: ${{ needs.test-and-build.outputs.version }}"
            echo "ğŸ• Build time: ${{ needs.test-and-build.outputs.build-time }}"
            echo "ğŸš€ Commit: ${{ github.sha }}"
          else
            echo "âŒ ğŸš¨ PRODUCTION DEPLOYMENT FAILED! ğŸš¨ âŒ"
            exit 1
          fi

  # ğŸ‘€ PR Preview and Quality Report
  deploy-preview:
    name: ğŸ‘€ PR Preview & Quality Report
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: test-and-build

    steps:
      - name: ğŸ’¬ Enhanced PR Comment
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const buildTime = '${{ needs.test-and-build.outputs.build-time }}';
            const version = '${{ needs.test-and-build.outputs.version }}';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸš€ Build Successful! Ready for Review

            ### ğŸ“‹ Build Summary
            - **Branch**: \`${pr.head.ref}\`
            - **Commit**: \`${context.sha.substring(0, 7)}\`
            - **Version**: \`${version}\`
            - **Built at**: \`${buildTime}\`

            ### ğŸ” Quality Checks
            - âœ… **ESLint**: No issues found
            - âœ… **TypeScript**: Compilation successful
            - âœ… **Unit Tests**: All passing
            - âœ… **Integration Tests**: All passing
            - âœ… **Build**: Successful

            ### ğŸ—„ï¸ Database
            - **Neon Branch**: \`pr-${context.issue.number}\` will be created when merged
            - **Migrations**: Will be applied automatically

            ### ğŸ“¦ Artifacts
            - **Build files**: Available for 7 days
            - **Prisma schema**: Included for migration review

            ---

            ğŸ¯ **Ready for code review!** All automated checks have passed.`
            });

      - name: ğŸ“Š Build metrics
        run: |
          echo "ğŸ“Š Build Metrics Summary:"
          echo "ğŸ• Build completed at: ${{ needs.test-and-build.outputs.build-time }}"
          echo "ğŸ“¦ Version: ${{ needs.test-and-build.outputs.version }}"
          echo "ğŸ”„ Workflow run: ${{ github.run_number }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
