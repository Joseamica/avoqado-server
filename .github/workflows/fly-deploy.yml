# Fly.io Demo Environment Deployment
# ====================================
# This workflow deploys to Fly.io for DEMO purposes (instant startup for client demos).
# Fly.io is used instead of Render for demos because it has instant cold starts.
#
# Environment mapping:
#   - develop branch â†’ Fly.io (demo) + Render (staging)
#   - main branch    â†’ Render (production) only
#
# See: https://fly.io/docs/app-guides/continuous-deployment-with-github-actions/

name: ğŸª Fly.io Demo Deploy
on:
  push:
    branches:
      - develop
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (emergency deploy)'
        required: false
        default: false
        type: boolean

concurrency:
  group: fly-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Quick validation before deploy
  validate:
    name: ğŸ§ª Quick Validation
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_tests }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” TypeScript check
        run: npx tsc --noEmit

      - name: ğŸ—„ï¸ Generate Prisma Client
        run: npx prisma generate

      - name: ğŸ—ï¸ Build application
        run: npm run build

  deploy:
    name: ğŸš€ Deploy to Fly.io (Demo)
    runs-on: ubuntu-latest
    needs: [validate]
    if: always() && (needs.validate.result == 'success' || needs.validate.result == 'skipped')
    environment:
      name: staging
      url: https://avoqado-server.fly.dev

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸª° Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: ğŸ” Verify Fly.io secrets
        run: |
          echo "Verificando que todos los secrets estÃ©n configurados..."
          .github/scripts/verify-fly-secrets.sh
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: ğŸš€ Deploy to Fly.io
        run: flyctl deploy --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: ğŸ¥ Health check
        run: |
          echo "â³ Waiting for deployment to stabilize..."
          sleep 30
          for i in {1..5}; do
            if curl -f -s https://avoqado-server.fly.dev/health; then
              echo "âœ… Demo environment is healthy!"
              exit 0
            fi
            echo "â³ Health check attempt $i failed, retrying in 10s..."
            sleep 10
          done
          echo "âš ï¸ Health check failed but deployment completed"

      - name: ğŸ“¢ Deployment summary
        if: always()
        run: |
          echo "ğŸª Demo Deployment Summary"
          echo "=========================="
          echo "ğŸ“ URL: https://avoqado-server.fly.dev"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ”„ Commit: ${{ github.sha }}"
          echo "ğŸ“… Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
